<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br" dir="ltr">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=1024, initial-scale=1" />

	<meta property="og:locale" content="pt_BR" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://tech-espm.github.io/labs-editor/phaser/" />
	<meta property="og:title" content="Editor (Phaser)" />
	<meta property="og:site_name" content="Editor (Phaser)" />
	<meta property="og:description" content="Editor HTML + CSS para uso em sala de aula." />
	<!--
	<meta property="og:image" content="fb.jpg" />
	<meta property="og:image:type" content="image/jpeg">
	<meta property="og:image:width" content="768">
	<meta property="og:image:height" content="768">
	-->

	<meta name="author" content="ESPM TECH" />
	<meta name="description" content="Editor HTML + CSS para uso em sala de aula." />
	<meta name="keywords" content="html, css, editor, wysiwyg" />

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="apple-mobile-web-app-title" content="Editor (Phaser)" />
	<!--
		https://w3c.github.io/manifest/#icon-masks
		https://github.com/w3c/manifest/issues/555
	-->
	<link rel="apple-touch-icon" sizes="57x57" href="../favicons/apple-icon-57x57.png" />
	<link rel="apple-touch-icon" sizes="60x60" href="../favicons/apple-icon-60x60.png" />
	<link rel="apple-touch-icon" sizes="72x72" href="../favicons/apple-icon-72x72.png" />
	<link rel="apple-touch-icon" sizes="76x76" href="../favicons/apple-icon-76x76.png" />
	<link rel="apple-touch-icon" sizes="114x114" href="../favicons/apple-icon-114x114.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="../favicons/apple-icon-120x120.png" />
	<link rel="apple-touch-icon" sizes="144x144" href="../favicons/apple-icon-144x144.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="../favicons/apple-icon-152x152.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="../favicons/apple-icon-180x180.png" />
	<link rel="icon" type="image/png" sizes="512x512" href="../favicons/favicon-512x512.png" />
	<link rel="icon" type="image/png" sizes="192x192" href="../favicons/favicon-192x192.png" />
	<link rel="icon" type="image/png" sizes="96x96" href="../favicons/favicon-96x96.png" />
	<link rel="icon" type="image/png" sizes="48x48" href="../favicons/favicon-48x48.png" />
	<link rel="icon" type="image/png" sizes="32x32" href="../favicons/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="../favicons/favicon-16x16.png" />
	<link rel="Shortcut Icon" href="../favicon.ico" />
	<link rel="Shortcut Icon" href="../favicon.png" />
	<link rel="manifest" href="../manifest-phaser.json" />
	<meta name="msapplication-config" content="../browserconfig.xml" />
	<meta name="theme-color" content="#222222" />

	<title>Editor (Phaser)</title>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Roboto+Mono:400,700" />
	<link rel="stylesheet" href="../lib/bootstrap/css/bootstrap-1.0.22.min.css" />
	<link rel="stylesheet" href="../lib/font-awesome/css/font-awesome-1.0.2.min.css" />
	<link rel="stylesheet" href="../css/style.css?v=1.0.0" />
</head>
<body style="visibility: hidden">

	<div class="modal fade" tabindex="-1" role="dialog" id="modalSave">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|Save"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group no-margin-bottom">
						<label for="modalSaveFileName" data-string="text|FileName"></label>
						<input type="text" class="form-control" id="modalSaveFileName" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalSaveOk" data-string="text|Save"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalDeleteFile">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|DeleteFile"></h4>
				</div>
				<div class="modal-body">
					<div id="modalDeleteFileLabel"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-danger" id="modalDeleteFileOk" data-string="text|Delete"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalCreateDocument">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|CreateDocument"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group no-margin-bottom">
						<label for="modalCreateDocumentFileName" data-string="text|FileName"></label>
						<input type="text" class="form-control" id="modalCreateDocumentFileName" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalCreateDocumentOk" data-string="text|Create"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalTheme">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|Theme"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group no-margin-bottom">
						<label for="modalThemeSelect" data-string="text|Theme"></label>
						<select size="1" class="form-control" id="modalThemeSelect">
							<option value="ace/theme/chrome">Chrome</option>
							<option value="ace/theme/dracula">Dracula</option>
							<option value="ace/theme/eclipse">Eclipse</option>
							<option value="ace/theme/labs">Labs</option>
							<option value="ace/theme/mono_industrial">Mono Industrial</option>
							<option value="ace/theme/monokai">Monokai</option>
							<option value="ace/theme/sqlserver">SQL Server</option>
							<option value="ace/theme/textmate">TextMate</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalThemeOk" data-string="text|Save"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="editor-container" id="editorContainer">
		<a class="nav-tabs-logo" href="https://github.com/tech-espm/labs-editor" target="_blank"><img width="75" src="../images/logo.png" style="border: none;" /></a>
		<div class="nav-tabs-buttons">
			<button type="button" id="editorPlay" class="btn btn-success btn-outline dropdown-toggle" data-string="title|PreviewPage">
				<span class="fa fa-play"></span>
			</button>
		</div>
		<div class="nav-tabs-menu">
			<button type="button" id="editorMenuDropdown" class="btn btn-primary btn-outline dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span class="fa fa-bars" data-string="aria-label|Menu"></span>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a href="#" data-string="text|New" id="editorActionNew"><i class="fa fa-margin fa-file-o"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|LoadEllipsis" id="editorActionLoad"><i class="fa fa-margin fa-folder-open-o"></i></a></li>
				<li><a href="#" data-string="text|SaveEllipsis" id="editorActionSave"><i class="fa fa-margin fa-cloud-download"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|LoadExample" id="editorActionLoadExample"><i class="fa fa-margin fa-lightbulb-o"></i></a></li>
				<li id="editorActionInstallSeparator" role="separator" class="divider" style="display: none;"></li>
				<li id="editorActionInstallItem" style="display: none;"><a href="#" id="editorActionInstall" data-string="text|InstallPhaser"><i class="fa fa-margin fa-download"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" id="editorActionToggleFileList"><i class="fa fa-margin fa-files-o"></i><span id="editorActionToggleFileListLabel" data-string="text|ShowFileList"></span></a></li>
				<li><a href="#" id="editorActionToggleConsole"><i class="fa fa-margin fa-terminal"></i><span id="editorActionToggleConsoleLabel" data-string="text|ShowConsole"></span></a></li>
				<li><a href="#" data-string="text|ClearConsole" id="editorActionClearConsole"><i class="fa fa-margin fa-trash-o"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|ThemeEllipsis" id="editorActionTheme"><i class="fa fa-margin fa-paint-brush"></i></a></li>
			</ul>
			<div class="nav-tabs-file-load"><input id="editorActionFileLoad" tabindex="-1" type="file" accept="text/html" /></div>
		</div>
		<div id="editor" class="editor-html"></div>
		<div id="editorFileListBar" class="editor-html-file-list-bar"><button type="button" id="btnEditorFileListBarCreateDocument" class="btn btn-outline btn-primary btn-xs" data-string="title|CreateDocument"><i class="fa fa-plus"></i></button></div>
		<div id="editorFileList" class="editor-html-file-list"></div>
		<div id="editorConsole" class="editor-html-console"></div>
	</div>
	<div class="editor-bar" id="bar"></div>
	<iframe class="editor-iframe" id="iframe" frameborder="0"></iframe>

	<script type="text/javascript" src="../lib/jquery/jquery-1.0.0.min.js"></script>
	<script type="text/javascript" src="../lib/bootstrap/js/bootstrap-1.0.0.min.js"></script>
	<script type="text/javascript" src="../js/main.js?v=1.0.0"></script>
	<script type="text/javascript" src="../lib/ace-1.4.7/ace.js"></script>
	<script type="text/javascript" src="../lib/ace-1.4.7/ext-searchbox.js"></script>
	<script type="text/javascript" src="../lib/ace-1.4.7/ext-language_tools.js"></script>

	<script type="text/javascript">
		"use strict";

		if (!("CacheStorage" in window) || !("caches" in window) || !("localStorage" in window) || !("Blob" in window))
			alert(translate("BrowserNotSupported"));

		var installationPrompt = null;

		if (("serviceWorker" in navigator)) {
			window.addEventListener("beforeinstallprompt", function (e) {
				if (("preventDefault" in e))
					e.preventDefault();
				installationPrompt = e;
				_ID("editorActionInstallSeparator").style.display = "";
				_ID("editorActionInstallItem").style.display = "";
			});

			navigator.serviceWorker.register("../sw.js");
		}

		var loading = false,
			theme = null,
			blobUrl = null,
			blobTimeout = 0,
			editorContainer = _ID("editorContainer"),
			editorNeedsResize = true,
			editor = null,
			editorFileListBar = _ID("editorFileListBar"),
			editorFileList = _ID("editorFileList"),
			editorFileListVisible = false,
			editorConsole = _ID("editorConsole"),
			editorConsoleVisible = false,
			iframe = _ID("iframe"),
			defaultDocument = "menu.js",
			currentDocument = defaultDocument,
			gamePathPrefix = "/labs-editor/phaser/game/",
			gameCacheName = "labs-editor-game-cache",
			gameCacheFileList = [defaultDocument];

		function loadFileDataURL(file, callback) {
			if (loading) {
				callback(null);
				return;
			}

			if (!("FileReader" in window)) {
				Notification.error(translate("ErrorNoFile"), true);
				callback(null);
				return;
			}

			loading = true;
			Notification.wait();

			var reader = new FileReader();
			reader.onload = function () {
				loading = false;
				Notification.hide();
				callback(reader.result);
			};
			reader.onerror = function () {
				loading = false;
				Notification.error(translate("ErrorFileLoad"), true);
				callback(null);
			};
			reader.readAsDataURL(file);
		}

		// Initial
		(function () {
			window.onbeforeunload = function () {
				return (!editor.session.getUndoManager().isClean() ? translate("ConfirmQuit") : null);
			};

			theme = localStorage.getItem(itemLabsEditorTheme);
			if (!theme)
				theme = "ace/theme/labs";

			editor = ace.edit("editor");
			editor.setOptions({
				selectionStyle: "text",
				highlightActiveLine: true,
				highlightSelectedWord: true,
				readOnly: false,
				cursorStyle: "ace",
				mergeUndoDeltas: true,
				behavioursEnabled: false,
				wrapBehavioursEnabled: false,
				autoScrollEditorIntoView: false,
				copyWithEmptySelection: false,
				useSoftTabs: false,
				navigateWithinSoftTabs: false,
				enableMultiselect: true,
				hScrollBarAlwaysVisible: false,
				vScrollBarAlwaysVisible: false,
				highlightGutterLine: true,
				animatedScroll: false,
				showInvisibles: false,
				showPrintMargin: false,
				fadeFoldWidgets: false,
				showFoldWidgets: true,
				showLineNumbers: true,
				showGutter: true,
				displayIndentGuides: false,
				scrollPastEnd: false,
				fixedWidthGutter: false,
				theme: theme,
				enableLiveAutocompletion: true
			});
			editor.session.setMode("ace/mode/javascript");

			window.resizeWindow();

			setTimeout(function () {
				document.body.style.visibility = "";

				editor.focus();

				if (!BlobDownloader.supported) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}
			}, 250);
		})();

		// Console
		(function () {
			window.clearLog = function () {
				while (editorConsole.firstChild)
					editorConsole.removeChild(editorConsole.firstChild);
			}

			function log(msg, error) {
				var div = _CE("div", "editor-html-console-message monospace" + (error ? " editor-html-console-message-error" : ""));
				_TXT(msg, div);
				_IB(editorConsole, div, editorConsole.firstChild);
			}

			window.consoleProxy = {
				clear: window.clearLog,
				info: function (msg) { log(msg, false) },
				warn: function (msg) { log(msg, false) },
				error: function (msg) { log(msg, true) },
				log: function (msg) { log(msg, false) },
				debug: function (msg) { log(msg, false) },
				exception: function (msg) { log(msg, true) },
				trace: function (msg) { log() },
				errorHandler: function (msg, url, line, col, error) { log("Ln " + line + ": " + msg, true); }
			};
		})();

		// Actions Menu
		(function () {
			var editorActionFileLoad = _ID("editorActionFileLoad"),
				editorActionToggleFileListLabel = _ID("editorActionToggleFileListLabel"),
				editorActionToggleConsoleLabel = _ID("editorActionToggleConsoleLabel"),
				modalSaveFileName = _ID("modalSaveFileName"),
				modalSaveOk = _ID("modalSaveOk"),
				modalDeleteFileOk = _ID("modalDeleteFileOk"),
				modalCreateDocumentFileName = _ID("modalCreateDocumentFileName"),
				modalCreateDocumentOk = _ID("modalCreateDocumentOk"),
				modalThemeSelect = _ID("modalThemeSelect"),
				modalThemeOk = _ID("modalThemeOk");

			$("#modalSave").on("shown.bs.modal", function () {
				modalSaveFileName.focus();
			});

			$("#modalCreateDocument").on("shown.bs.modal", function () {
				modalCreateDocumentFileName.focus();
			});

			$("#modalTheme").on("shown.bs.modal", function () {
				modalThemeSelect.focus();
			});

			modalSaveFileName.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalSaveOk.click();
			};

			modalCreateDocumentFileName.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalCreateDocumentOk.click();
			};

			function confirmClose() {
				return ((editor.session.getUndoManager().isClean() && !localStorage.getItem(itemLabsEditorHasGame)) || confirm(translate("ConfirmClose")));
			}

			function loadFileFromURL(url) {
				loading = true;
				Notification.wait();

				try {
					var xhr = new XMLHttpRequest(), done = false;
					xhr.responseType = "text";
					xhr.onreadystatechange = function () {
						if (xhr.readyState === 4) {
							if (done)
								return;
							done = true;

							loading = false;
							Notification.hide();

							try {
								loadDocument(xhr.responseText);
							} catch (ex) {
								Notification.error(translate("ErrorFileLoad"), true);
							}
						}
					};
					xhr.onerror = function () {
						loading = false;
						Notification.error(translate("ErrorFileLoad"), true);
					};
					xhr.open("get", url);
					xhr.send();
				} catch (ex) {
					loading = false;
					Notification.error(translate("ErrorFileLoad"), true);
				}
			}

			function loadFileFromInput() {
				if (loading)
					return;

				if (!("files" in editorActionFileLoad)) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (!editorActionFileLoad.files.length || !editorActionFileLoad.files[0])
					return;

				loadFileDataURL(editorActionFileLoad.files[0], function (dataURL) {
					var parent = editorActionFileLoad.parentNode;
					editorActionFileLoad = _SA(_SA(_SA(_CE("input", null, _RC(parent, editorActionFileLoad)), "type", "file"), "tabindex", "-1"), "accept", "text/html");
					editorActionFileLoad.onchange = loadFileFromInput;

					if (!dataURL)
						return;

					if (dataURL.indexOf("data:text/html;base64,")) {
						Notification.error(translate("ErrorInvalidHTML"), true);
						return;
					}

					loadFileFromURL(dataURL);
				});
			}

			function previewPage(forceSave) {
				if (loading)
					return;

				saveCurrentDocumentToCache(forceSave, function () {
					_SA(iframe, "src", gamePathPrefix);
				});
			}

			function resetEditorSession() {
				editor.session.setTabSize(4);
				editor.session.setUseSoftTabs(false);
				editor.session.setUseWrapMode(false);
			}

			function newDocument() {
				resetEditorSession();

				editor.session.setValue('var ' + translate("levels") + ' = ["menu"];\nvar ' + translate("gameWidth") + ' = 800;\nvar ' + translate("gameHeight") + ' = 600;\n\nfunction menu() {\n\t\n\tthis.preload = function () {\n\t\t\n\t\tgame.stage.backgroundColor = "#0066ff";\n\t\t\n\t};\n\t\n\tthis.create = function () {\n\t\t\n\t};\n\t\n\tthis.update = function () {\n\t\t\n\t};\n\t\n}\n');

				currentDocument = defaultDocument;
				gameCacheFileList = [defaultDocument];
				saveGameCacheFileList();
				window.clearLog();
				editor.session.getUndoManager().reset();

				_SA(iframe, "src", "about:blank");

				function finished() {
					loading = false;
					Notification.hide();

					saveCurrentDocumentToCache(true);
				}

				loading = true;
				Notification.wait();

				caches.delete(gameCacheName).then(finished).catch(finished);
			}

			function loadDocument(doc) {
				resetEditorSession();

				editor.session.setValue(doc);

				window.clearLog();
				editor.session.getUndoManager().reset();

				previewPage(true);
			}

			function loadDocumentFromCache(fileName, showNotification) {
				if (loading)
					return;

				loading = true;
				Notification.wait();

				function loadError(reason) {
					loading = false;
					Notification.error(translate("ErrorFileLoad"));
				}

				function finishLoading(value) {
					loading = false;
					if (showNotification)
						Notification.success(translate("RememberToAddFileToMenu"));
					else
						Notification.hide();

					resetEditorSession();

					currentDocument = fileName;
					editor.session.setValue(value);
					editor.session.getUndoManager().reset();
				}

				caches.open(gameCacheName).then(function (cache) {
					cache.match(gamePathPrefix + fileName).then(function (response) {
						if (!response)
							finishLoading("");
						else
							response.text().then(finishLoading).catch(loadError);
					}).catch(loadError);
				}).catch(loadError);
			}

			function deleteFileFromCache(fileName, callback) {
				loading = true;
				Notification.wait();

				caches.open(gameCacheName).then(function (cache) {
					cache.delete(gamePathPrefix + fileName).then(function () {
						loading = false;
						Notification.hide();

						if (callback)
							callback();
					}).catch(function (reason) {
						console.error(reason);

						loading = false;
						Notification.hide();

						if (callback)
							callback();
					});
				});
			}

			function saveFileToCache(blob, fileName, callback) {
				loading = true;
				Notification.wait();

				caches.open(gameCacheName).then(function (cache) {
					// The spec says there is no need to worry about max-age
					// and other cache-control headers/settings, because the
					// CacheStorage API ignores them... But... Just in case...
					var request = new Request(gamePathPrefix + fileName, { cache: "no-store" });

					var headers = new Headers();
					headers.append("cache", "private, no-store");
					var response = new Response(blob, { headers: headers });

					cache.put(request, response).then(function () {
						loading = false;
						Notification.hide();

						if (callback)
							callback();
					}).catch(function (reason) {
						console.error(reason);

						loading = false;
						Notification.hide();

						if (callback)
							callback();
					});
				});
			}

			function saveCurrentDocumentToCache(forceSave, callback) {
				if (loading)
					return;

				if (forceSave || !editor.session.getUndoManager().isClean()) {
					saveFileToCache(new Blob([
						new Uint8Array([0xEF, 0xBB, 0xBF]), // UTF-8 BOM
						editor.session.getValue()
					], { type: "text/javascript" }), currentDocument, function () {
						editor.session.getUndoManager().markClean();

						if (callback)
							callback();
					});
				} else if (callback) {
					callback();
				}
			}

			function deleteFileFromDiv(e) {
				if (loading)
					return cancelEvent(e);

				var fileName = _GA(this, "data-name");

				if (!fileName || fileName === defaultDocument)
					return cancelEvent(e);

				_ID("modalDeleteFileLabel").textContent = translate("ConfirmDelete") + fileName + "?";

				_SA(modalDeleteFileOk, "data-name", fileName);

				$("#modalDeleteFile").modal({
					keyboard: true,
					backdrop: true
				});

				return cancelEvent(e);
			}

			function loadFileFromDiv() {
				if (loading)
					return;

				var fileName = _GA(this, "data-name");
				if (!fileName)
					return;

				if (fileName.toLowerCase().endsWith(".js")) {
					if (fileName !== currentDocument)
						saveCurrentDocumentToCache(false, function () { loadDocumentFromCache(fileName, false); });
				} else {
					window.open(gamePathPrefix + fileName);
				}
			}

			function updateGameCacheFileList() {
				gameCacheFileList.sort();

				while (editorFileList.firstChild)
					editorFileList.removeChild(editorFileList.firstChild);

				var i, fileName, div, button;
				for (i = 0; i < gameCacheFileList.length; i++) {
					fileName = gameCacheFileList[i];
					div = _CE("div", "editor-html-file-list-item");
					div.onclick = loadFileFromDiv;
					_SA(div, "data-name", fileName);
					_CE("i", "fa fa-margin fa-file-o", div);
					_TXT(fileName, div);
					if (fileName !== defaultDocument) {
						button = _CE("button", "btn btn-outline btn-danger btn-xs editor-html-file-list-item-button", div);
						button.onclick = deleteFileFromDiv;
						_SA(button, "data-name", fileName);
						_SA(button, "title", translate("Delete"));
						_CE("i", "fa fa-times", button);
					}
					_AC(editorFileList, div);
				}
			}

			function loadGameCacheFileList() {
				gameCacheFileList = null;

				try {
					gameCacheFileList = JSON.parse(localStorage.getItem(itemLabsEditorGameFileList));
				} catch (ex) {
					// Just ignore...
				}

				if (!gameCacheFileList || !gameCacheFileList.length)
					gameCacheFileList = [defaultDocument];

				updateGameCacheFileList();
			}

			function saveGameCacheFileList() {
				localStorage.setItem(itemLabsEditorGameFileList, JSON.stringify(gameCacheFileList));

				updateGameCacheFileList();
			}

			function loadGameFromCache() {
				// We must use a separate list (gameCacheFileList) because,
				// in our case, all the responses returned by cache.matchAll()
				// come with their url = "".

				loadGameCacheFileList();

				loadDocumentFromCache(defaultDocument, false);
			}

			editorActionFileLoad.onchange = loadFileFromInput;

			_ID("editorPlay").onclick = function () {
				if (loading)
					return;

				window.clearLog();

				if (!localStorage.getItem(itemLabsEditorHasGame))
					localStorage.setItem(itemLabsEditorHasGame, "1");

				previewPage(false);
			};

			_ID("editorActionNew").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				if (!confirmClose())
					return cancelEvent(e);

				newDocument();

				return cancelEvent(e);
			};

			_ID("editorActionLoad").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				//if (!confirmClose())
				//	return cancelEvent(e);

				//editorActionFileLoad.click();

				return cancelEvent(e);
			};

			_ID("editorActionSave").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				//$("#modalSave").modal({
				//	keyboard: true,
				//	backdrop: true
				//});

				return cancelEvent(e);
			};

			_ID("editorActionLoadExample").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				//if (!confirmClose())
				//	return cancelEvent(e);

				//loadFileFromURL(translate("ExampleFileHTML"));

				return cancelEvent(e);
			};

			_ID("editorActionInstall").onclick = function (e) {
				$("#editorMenuDropdown").dropdown("toggle");

				_ID("editorActionInstallSeparator").style.display = "none";
				_ID("editorActionInstallItem").style.display = "none";

				if (installationPrompt) {
					installationPrompt.prompt();
					installationPrompt = null;
				}

				return cancelEvent(e);
			};

			function toggleFileList() {
				editorFileListVisible = !editorFileListVisible;
				if (editorFileListVisible) {
					editorActionToggleFileListLabel.textContent = translate("HideFileList");
					_ID("editor").style.left = "200px";
					editorFileListBar.style.display = "block";
					editorFileList.style.display = "block";
				} else {
					editorActionToggleFileListLabel.textContent = translate("ShowFileList");
					_ID("editor").style.left = "";
					editorFileListBar.style.display = "none";
					editorFileList.style.display = "none";
				}
				editor.resize();
			}

			_ID("editorActionToggleFileList").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				toggleFileList();

				if (editorFileListVisible)
					localStorage.setItem(itemLabsEditorFileListVisible, "1");
				else
					localStorage.removeItem(itemLabsEditorFileListVisible);

				return cancelEvent(e);
			};

			function toggleConsole() {
				editorConsoleVisible = !editorConsoleVisible;
				if (editorConsoleVisible) {
					editorActionToggleConsoleLabel.textContent = translate("HideConsole");
					editorFileList.style.bottom = "200px";
					_ID("editor").style.bottom = "200px";
					editorConsole.style.display = "block";
				} else {
					editorActionToggleConsoleLabel.textContent = translate("ShowConsole");
					editorFileList.style.bottom = "";
					_ID("editor").style.bottom = "";
					editorConsole.style.display = "none";
				}
				editor.resize();
			}

			_ID("editorActionToggleConsole").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				toggleConsole();

				if (editorConsoleVisible)
					localStorage.setItem(itemLabsEditorConsoleVisible, "1");
				else
					localStorage.removeItem(itemLabsEditorConsoleVisible);

				return cancelEvent(e);
			};

			_ID("editorActionClearConsole").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				window.clearLog();

				return cancelEvent(e);
			};

			_ID("editorActionTheme").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				modalThemeSelect.value = theme;

				$("#modalTheme").modal({
					keyboard: true,
					backdrop: true
				});

				return cancelEvent(e);
			};

			_ID("btnEditorFileListBarCreateDocument").onclick = function () {
				if (loading)
					return;

				$("#modalCreateDocument").modal({
					keyboard: true,
					backdrop: true
				});
			};

			modalSaveOk.onclick = function () {
				var fileName = trim(modalSaveFileName.value);
				if (!fileName)
					return;

				if (!BlobDownloader.supported) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (fileName.toLowerCase().indexOf(".htm") < 0)
					fileName += ".html";

				$("#modalSave").modal("hide");

				BlobDownloader.download(fileName, new Blob([
					new Uint8Array([0xEF, 0xBB, 0xBF]), // UTF-8 BOM
					editor.session.getValue()
				], { type: "text/html;charset=utf-8" }));

				editor.session.getUndoManager().markClean();
			};

			modalDeleteFileOk.onclick = function () {
				if (loading)
					return;

				var fileName = _GA(modalDeleteFileOk, "data-name");
				if (!fileName)
					return;

				$("#modalDeleteFile").modal("hide");

				deleteFileFromCache(fileName, function () {
					for (var i = gameCacheFileList.length - 1; i >= 0; i--) {
						if (gameCacheFileList[i] === fileName) {
							gameCacheFileList.splice(i, 1);
							break;
						}
					}

					saveGameCacheFileList();

					loadDocumentFromCache(defaultDocument, false);
				});
			};

			modalCreateDocumentOk.onclick = function () {
				if (loading)
					return;

				var fileName = trim(modalCreateDocumentFileName.value);
				if (!fileName)
					return;

				// Force lower case extensions
				var lcase = fileName.toLowerCase(), noExtension;
				if (!lcase.endsWith(".js")) {
					noExtension = fileName;
					fileName += ".js";
					lcase += ".js";
				} else {
					noExtension = fileName.substr(0, fileName.length - 3);
					fileName = noExtension + ".js";
				}

				if (/\W/.test(noExtension)) {
					Notification.error(translate("ErrorInvalidFileName"), true);
					return;
				}

				for (var i = gameCacheFileList.length - 1; i >= 0; i--) {
					if (gameCacheFileList[i].toLowerCase() === lcase) {
						Notification.error(translate("ErrorFileAlreadyExists"), true);
						return;
					}
				}

				saveFileToCache(new Blob([
					new Uint8Array([0xEF, 0xBB, 0xBF]), // UTF-8 BOM
					'function ',
					noExtension,
					'() {\n\t\n\tthis.preload = function () {\n\t\t\n\t};\n\t\n\tthis.create = function () {\n\t\t\n\t};\n\t\n\tthis.update = function () {\n\t\t\n\t};\n\t\n}\n'
				], { type: "text/javascript" }), fileName, function () {
					$("#modalCreateDocument").modal("hide");

					gameCacheFileList.push(fileName);
					saveGameCacheFileList();

					loadDocumentFromCache(fileName, true);
				});
			};

			modalThemeOk.onclick = function () {
				theme = modalThemeSelect.value;

				localStorage.setItem(itemLabsEditorTheme, theme);

				editor.setTheme(theme);

				$("#modalTheme").modal("hide");
			};

			if (localStorage.getItem(itemLabsEditorHasGame))
				loadGameFromCache();
			else
				newDocument();

			if (localStorage.getItem(itemLabsEditorFileListVisible))
				toggleFileList();

			if (localStorage.getItem(itemLabsEditorConsoleVisible))
				toggleConsole();
		})();
	</script>
</body>
</html>
