<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br" dir="ltr">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=1024, initial-scale=1" />

	<meta property="og:locale" content="pt_BR" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://tech-espm.github.io/labs-editor/" />
	<meta property="og:title" content="Editor" />
	<meta property="og:site_name" content="Editor" />
	<meta property="og:description" content="Editor HTML + CSS para uso em sala de aula." />
	<!--
	<meta property="og:image" content="fb.jpg" />
	<meta property="og:image:type" content="image/jpeg">
	<meta property="og:image:width" content="768">
	<meta property="og:image:height" content="768">
	-->

	<meta name="author" content="ESPM TECH" />
	<meta name="description" content="Editor HTML + CSS para uso em sala de aula." />
	<meta name="keywords" content="html, css, editor, wysiwyg" />

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="apple-mobile-web-app-title" content="Neon Labyrinth Maker" />
	<!--
		https://w3c.github.io/manifest/#icon-masks
		https://github.com/w3c/manifest/issues/555
	-->
	<link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-icon-57x57.png" />
	<link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-icon-60x60.png" />
	<link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-icon-72x72.png" />
	<link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-icon-76x76.png" />
	<link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-icon-114x114.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-icon-120x120.png" />
	<link rel="apple-touch-icon" sizes="144x144" href="favicons/apple-icon-144x144.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-icon-152x152.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-icon-180x180.png" />
	<link rel="icon" type="image/png" sizes="512x512" href="favicons/favicon-512x512.png" />
	<link rel="icon" type="image/png" sizes="192x192" href="favicons/favicon-192x192.png" />
	<link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96x96.png" />
	<link rel="icon" type="image/png" sizes="48x48" href="favicons/favicon-48x48.png" />
	<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png" />
	<link rel="Shortcut Icon" href="favicon.ico" />
	<link rel="Shortcut Icon" href="favicon.png" />
	<link rel="manifest" href="manifest.json" />
	<meta name="msapplication-config" content="browserconfig.xml" />
	<meta name="theme-color" content="#222222" />

	<title>Editor</title>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Roboto+Mono:400,700" />
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap-1.0.18.min.css" />
	<link rel="stylesheet" href="lib/font-awesome/css/font-awesome-1.0.2.min.css" />

	<style type="text/css">
		html, body {
			min-height: 100%;
		}

		body {
			background: #fff;
		}

		textarea {
			resize: vertical;
		}

		.fa-margin {
			margin-right: 0.5em;
		}

		.nav-tabs {
			padding: 4px 0 0 4px;
		}

			.nav-tabs > li > a {
				-webkit-transition: background-color ease-in-out .2s, border-color ease-in-out .2s, color ease-in-out .2s;
				-o-transition: background-color ease-in-out .2s, border-color ease-in-out .2s, color ease-in-out .2s;
				transition: background-color ease-in-out .2s, border-color ease-in-out .2s, color ease-in-out .2s;
			}

				.nav-tabs > li > a:focus, .nav-tabs > li > a:hover, .nav-tabs > li > a:active {
					border-color: #ddd;
					background-color: #f0f0f0;
					color: #333;
				}

		.nav-tabs-menu {
			position: absolute;
			right: 5px;
			top: 5px;
		}

		.nav-tabs-file-load {
			position: absolute;
			overflow: hidden;
			width: 0;
		}

		.editor-container {
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			cursor: default;
			-moz-user-select: none;
			-ms-user-select: none;
			-webkit-user-select: none;
			user-select: none;
		}

		.editor {
			position: absolute;
			left: 0;
			top: 46px;
			right: 0;
			bottom: 0;
			font: normal 14px 'Roboto Mono', monospace;
			overflow: auto;
		}

		.editor-css {
			padding-left: 4ch;
		}

		.editor-bar {
			display: none;
			position: absolute;
			top: 0;
			bottom: 0;
			width: 8px;
			cursor: ew-resize;
			background-color: #fff;
			border-left: 1px solid #ddd;
			border-right: 1px solid #ddd;
			-webkit-transition: background-color ease-in-out .2s;
			-o-transition: background-color ease-in-out .2s;
			transition: background-color ease-in-out .2s;
		}

			.editor-bar:hover, .editor-bar-drag {
				background-color: #f0f0f0;
			}

		.editor-iframe {
			position: absolute;
			top: 0;
			height: 100%;
		}

		.move-target {
			border-top: 2px solid transparent;
			-webkit-transition: border-color ease-in-out .2s;
			-o-transition: border-color ease-in-out .2s;
			transition: border-color ease-in-out .2s;
		}

		.editor.moving .move-target {
			border-top-color: #ddd;
		}

			.editor.moving .move-target:hover {
				border-top-color: #00f;
			}

		.element {
			padding: 0;
			margin: 8px 0;
			-webkit-transition: background-color ease-in-out .2s;
			-o-transition: background-color ease-in-out .2s;
			transition: background-color ease-in-out .2s;
		}

			.element.moving {
				background-color: #eee;
			}

				.element.moving .move-target, .element.moving .move-target:hover {
					border-top-color: transparent;
				}

		.element-tag {
			cursor: pointer;
			color: #00f;
			white-space: pre;
			font-weight: bold;
		}

		.element-name {
			color: #f0f;
			font-weight: normal;
		}

		.element-name-block {
			color: #a00;
			font-weight: normal;
		}

		.element-text {
			color: #000;
			font-weight: normal;
		}

		.element-comment {
			color: #080;
			font-weight: normal;
		}

		.element-container {
			padding-left: 4ch;
		}

		.fa-floating-help {
			float: right;
			margin-top: 2px;
			color: #aaa;
		}

			.fa-floating-help:hover {
				color: #000;
			}

		.dropdown-menu {
			margin: 0;
		}

		.dropdown-menu-input-container {
			position: relative;
			margin: 0 5px;
		}

		.dropdown-menu-container {
			position: relative;
			overflow: auto;
		}

		.editor-menu {
			display: none;
			position: fixed;
			background: #fff;
			width: auto;
			border-radius: 4px;
			-webkit-box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
			box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
			z-index: 10;
		}

		.editor-menu-animated {
			opacity: 0;
			cursor: default;
			-webkit-transition: opacity ease-in-out .2s, margin-left ease-in-out .2s, margin-top ease-in-out .2s;
			-o-transition: opacity ease-in-out .2s, margin-left ease-in-out .2s, margin-top ease-in-out .2s;
			transition: opacity ease-in-out .2s, margin-left ease-in-out .2s, margin-top ease-in-out .2s;
			-moz-user-select: none;
			-ms-user-select: none;
			-webkit-user-select: none;
			user-select: none;
		}

		.editor-menu-top {
			margin-top: 12px;
		}

		.editor-menu-left {
			margin-left: 12px;
		}

		.editor-menu-right {
			margin-left: -12px;
		}

		.editor-menu-bottom {
			margin-top: -12px;
		}

		.editor-menu-visible {
			margin: 0;
			opacity: 1;
		}

		.editor-hidden-file-input {
			width: 0;
			position: absolute;
		}
	</style>
</head>
<body style="visibility: hidden">

	<div class="modal fade" tabindex="-1" role="dialog" id="modalTxt">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditText"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="modalTxtInput" data-string="text|NewText"></label>
						<textarea class="form-control" id="modalTxtInput" spellcheck="true" autocomplete="off" rows="3"></textarea>
					</div>
					<div class="form-group no-margin-bottom">
						<button type="button" class="btn btn-outline btn-primary" id="modalTxtBtnLoremIpsum" data-string="text|UseLoremIpsum"></button>
						<select size="1" class="form-control" id="modalTxtSelectLoremIpsum" style="display: inline-block; width: auto;"></select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-margin fa-times"></i><span data-string="text|Cancel"></span></button>
					<button type="button" class="btn btn-primary" id="modalTxtOk"><i class="fa fa-margin fa-check"></i><span data-string="text|OK"></span></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalAttributes">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditAttributes"></h4>
				</div>
				<div class="modal-body" id="modalAttributesBody"></div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-margin fa-times"></i><span data-string="text|Cancel"></span></button>
					<button type="button" class="btn btn-primary" id="modalAttributesOk"><i class="fa fa-margin fa-check"></i><span data-string="text|OK"></span></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalSave">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|Save"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="modalSaveFileName" data-string="text|FileName"></label>
						<input type="text" class="form-control" id="modalSaveFileName" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i></i><span data-string="text|Cancel"></span></button>
					<button type="button" class="btn btn-primary" id="modalSaveOk"><i></i><span data-string="text|Save"></span></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalRuleSelector">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditSelector"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="modalRuleSelectorInput" data-string="text|NewSelector"></label>
						<input type="text" class="form-control" id="modalRuleSelectorInput" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal"><i class="fa fa-margin fa-times"></i><span data-string="text|Cancel"></span></button>
					<button type="button" class="btn btn-primary" id="modalRuleSelectorOk"><i class="fa fa-margin fa-check"></i><span data-string="text|OK"></span></button>
				</div>
			</div>
		</div>
	</div>

	<div class="editor-container" id="editorContainer">
		<ul class="nav nav-tabs" role="tablist">
			<li role="presentation" class="active"><a href="#editor" aria-controls="editor" role="tab" data-toggle="tab">HTML</a></li>
			<li role="presentation"><a href="#editorCss" aria-controls="editorCss" role="tab" data-toggle="tab">CSS</a></li>
		</ul>
		<div class="nav-tabs-menu">
			<button type="button" id="editorMenuDropdown" class="btn btn-primary btn-outline dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span class="fa fa-bars" data-string="aria-label|Menu"></span>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a href="#" data-string="text|New" id="editorActionNew"><i class="fa fa-file-o"></i> </a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|LoadEllipsis" id="editorActionLoad"><i class="fa fa-folder-open-o"></i> </a></li>
				<li><a href="#" data-string="text|SaveEllipsis" id="editorActionSave"><i class="fa fa-cloud-download"></i> </a></li>
			</ul>
			<div class="nav-tabs-file-load"><input id="editorActionFileLoad" tabindex="-1" type="file" accept="text/html" /></div>
		</div>
		<div class="tab-content">
			<div id="editor" role="tabpanel" class="tab-pane fade in active editor"></div>
			<div id="editorCss" role="tabpanel" class="tab-pane fade editor editor-css"></div>
		</div>
	</div>
	<div class="editor-bar" id="bar"></div>
	<iframe class="editor-iframe" id="iframe" frameborder="0"></iframe>
	<ul class="dropdown-menu editor-menu-animated" id="dropdownType">
		<li class="dropdown-menu-input-container">
			<input id="dropdownTypeInput" spellcheck="false" autocomplete="off" class="dropdown-menu-input form-control input-sm" data-string="placeholder|ElementName" />
		</li>
		<li class="divider"></li>
		<li class="dropdown-menu-container" id="dropdownTypeContainer"></li>
	</ul>
	<div class="editor-menu editor-menu-animated editor-menu-top" id="dropdownMenuTop">
		<button class="btn btn-outline btn-xs btn-success" type="button" data-string="title|CreateElement" onclick="dropdownShowType(true, false)" id="dropdownMenuTopCreateElement"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-success" type="button" data-string="title|CreateRule" onclick="dropdownCreateEditRuleSelector(true, false)" id="dropdownMenuTopCreateRule"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-primary" type="button" data-string="title|CreateText" onclick="dropdownCreateText(true)" id="dropdownMenuTopCreateText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-primary" type="button" data-string="title|CreateComment" onclick="dropdownCreateComment(true)" id="dropdownMenuTopCreateComment"><i class="fa fa-nomargin fa-comment"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-left" id="dropdownMenuLeft">
		<button class="btn btn-outline btn-xs btn-default" type="button" onclick="dropdownToggleVisibility()" id="dropdownMenuLeftToggleVisibility"><i class="fa fa-nomargin fa-plus"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-right" id="dropdownMenuRight">
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|Move" onclick="dropdownMove()"><i class="fa fa-nomargin fa-arrows"></i></button>
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|Duplicate" onclick="dropdownDuplicate()"><i class="fa fa-nomargin fa-copy"></i></button>
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|EditText" onclick="dropdownEditText()" id="dropdownMenuRightEditText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|FindElement" onclick="dropdownFind()" id="dropdownMenuRightFind"><i class="fa fa-nomargin fa-search"></i></button>
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|ChangeElement" onclick="dropdownShowType(true, true)" id="dropdownMenuRightChangeType"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-default" type="button" data-string="title|EditSelector" onclick="dropdownCreateEditRuleSelector(true, true)" id="dropdownMenuRightEditRuleSelector"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-primary" type="button" data-string="title|EditAttributes" onclick="dropdownEditAttributes()" id="dropdownMenuRightEditAttributes"><i class="fa fa-nomargin fa-info"></i></button>
		<button class="btn btn-outline btn-xs btn-danger" type="button" data-string="title|Delete" onclick="dropdownDelete()"><i class="fa fa-nomargin fa-times"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-bottom" id="dropdownMenuBottom">
		<button class="btn btn-outline btn-xs btn-success" type="button" data-string="title|CreateElement" onclick="dropdownShowType(false, false)" id="dropdownMenuBottomCreateElement"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-success" type="button" data-string="title|CreateRule" onclick="dropdownCreateEditRuleSelector(false, false)" id="dropdownMenuBottomCreateRule"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-primary" type="button" data-string="title|CreateText" onclick="dropdownCreateText(false)" id="dropdownMenuBottomCreateText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-primary" type="button" data-string="title|CreateComment" onclick="dropdownCreateComment(false)" id="dropdownMenuBottomCreateComment"><i class="fa fa-nomargin fa-comment"></i></button>
	</div>

	<script type="text/javascript" src="lib/jquery/jquery-1.0.0.min.js"></script>
	<script type="text/javascript" src="lib/bootstrap/js/bootstrap-1.0.0.min.js"></script>
	<script type="text/javascript" src="js/main.js"></script>

	<script type="text/javascript">
		"use strict";

		var queryString = "", isPWA = false, installationPrompt = null;

		(function () {
			var i, pair, assoc = {}, keyValues = location.search.substr(1).split("&");
			for (i = keyValues.length - 1; i >= 0; i--) {
				pair = keyValues[i].split("=");
				assoc[decodeURIComponent(pair[0].replace(/\+/g, " "))] = (pair.length === 1 ? "" : decodeURIComponent(pair[1].replace(/\+/g, " ")));
			}
			queryString = assoc;
			isPWA = ("pwa" in queryString);
		})();

		if (("serviceWorker" in navigator)) {
			window.addEventListener("beforeinstallprompt", function (e) {
				if (("preventDefault" in e))
					e.preventDefault();
				installationPrompt = e;
			});

			navigator.serviceWorker.register("service-worker.js");
		}

		// Helper functions
		function _ID(id) { return document.getElementById(id); }
		function _SA(parent, name, value) { parent.setAttribute(name, value); return parent; }
		function _GA(parent, name) { return (parent.getAttribute(name) || ""); }
		function _RA(parent, name) { parent.removeAttribute(name); return parent; }
		function _CE(tagName, className, parent) { var e = document.createElement(tagName); if (className) e.className = className; if (parent) _AC(parent, e); return e; }
		function _ICE(tagName, className, parent) { var e = iframeDocument.createElement(tagName); if (className) e.className = className; if (parent) _AC(parent, e); return e; }
		function _TXT(text, parent) { var e = document.createTextNode(text); if (parent) _AC(parent, e); return e; }
		function _ITXT(text, parent) { var e = iframeDocument.createTextNode(text); if (parent) _AC(parent, e); return e; }
		function _ICMT(text, parent) { var e = iframeDocument.createComment(text); if (parent) _AC(parent, e); return e; }
		function _AC(parent, newChild) { parent.appendChild(newChild); return parent; }
		function _IB(parent, newChild, refChild) { parent.insertBefore(newChild, refChild); return parent; }
		function _BTN(className, icon, title, parent, clickHandler) { var btn = _CE("button", className, parent); _CE("i", "fa fa-nomargin " + icon, btn); _SA(btn, "type", "button"); btn.onclick = clickHandler; if (title) _SA(btn, "title", title); return btn; }
		function _RC(parent, oldChild) { parent.removeChild(oldChild); return parent; }

		var loading = true,
			valueFreeText = null,
			valueColor = 0,
			valueNumber = 1,
			valueImage = 2,
			categoryElement = 0,
			categoryRule = 1,
			categoryRuleAttribute = 2,
			htmlAttributes = [
				{ name: "class", values: [""], common: true },
				{ name: "id", values: valueFreeText, common: true },
				{ name: "title", values: valueFreeText, common: true },
			],
			htmlAttributeClass = htmlAttributes[0],
			elementTypes = [
				{ name: "hr", block: true, noChildren: true, attributes: null },
				{ name: "br", noChildren: true, attributes: null },
				{ name: "img", noChildren: true, attributes: [{ name: "src", values: valueImage }, { name: "alt", values: valueFreeText }, { name: "width", values: valueNumber }, { name: "height", values: valueNumber }] },
				{ name: "a", attributes: [{ name: "href", values: valueFreeText }, { name: "target", values: ["_blank"] }] },
				{ name: "button", attributes: [{ name: "type", values: valueFreeText }, { name: "disabled", values: ["", "disabled"] }] },
				{ name: "input", noChildren: true, attributes: [{ name: "type", values: ["", "button", "checkbox", "color", "date", "datetime-local", "email", "file", "hidden", "month", "number", "password", "radio", "range", "reset", "search", "submit", "tel", "text", "time", "url", "week"] }, { name: "autocomplete", values: ["", "on", "off"] }, { name: "spellcheck", values: ["", "true", "false"] }, { name: "readonly", values: ["", "readonly"] }, { name: "disabled", values: ["", "disabled"] }, { name: "name", values: valueFreeText }, { name: "value", values: valueFreeText }, { name: "min", values: valueNumber }, { name: "max", values: valueNumber }, { name: "maxlength", values: valueNumber }, { name: "checked", values: ["", "checked"] }, { name: "size", values: valueNumber }] },
				{ name: "select", attributes: [{ name: "size", values: valueNumber }] },
				{ name: "option", block: true, attributes: [{ name: "value", values: valueFreeText }, { name: "selected", values: ["", "selected"] }] },
				{ name: "optgroup", block: true, attributes: [{ name: "label", values: valueFreeText }] },
				{ name: "label", attributes: [{ name: "for", values: valueFreeText }] },
				{ name: "p", block: true, attributes: null },
				{ name: "b", attributes: null },
				{ name: "i", attributes: null },
				{ name: "span", attributes: null },
				{ name: "div", block: true, attributes: null },
				{ name: "section", block: true, attributes: null },
				{ name: "nav", block: true, attributes: null },
				{ name: "header", block: true, attributes: null },
				{ name: "footer", block: true, attributes: null },
				{ name: "main", block: true, attributes: null },
				{ name: "article", block: true, attributes: null },
				{ name: "aside", block: true, attributes: null },
				{ name: "ul", block: true, attributes: null },
				{ name: "ol", block: true, attributes: null },
				{ name: "li", block: true, attributes: null },
				{ name: "figure", block: true, attributes: null },
				{ name: "h1", block: true, attributes: null },
				{ name: "h2", block: true, attributes: null },
				{ name: "h3", block: true, attributes: null },
				{ name: "h4", block: true, attributes: null },
				{ name: "h5", block: true, attributes: null },
				{ name: "h6", block: true, attributes: null },
				{ name: "table", block: true, attributes: null },
				{ name: "thead", block: true, attributes: null },
				{ name: "tbody", block: true, attributes: null },
				{ name: "tfoot", block: true, attributes: null },
				{ name: "tr", block: true, attributes: null },
				{ name: "th", attributes: [{ name: "colspan", values: valueNumber }, { name: "rowspan", values: valueNumber }] },
				{ name: "td", attributes: [{ name: "colspan", values: valueNumber }, { name: "rowspan", values: valueNumber }] },
				{ name: "colgroup", attributes: [{ name: "span", values: valueNumber }] },
				{ name: "col", attributes: [{ name: "span", values: valueNumber }] },
			],
			elementTypesByName = {},
			elementTypeBody = null,
			elementTypeText = null,
			elementTypeComment = null,
			cssAttributes = [
				{ name: "margin", values: valueFreeText },
				{ name: "margin-top", values: valueFreeText },
				{ name: "margin-right", values: valueFreeText },
				{ name: "margin-bottom", values: valueFreeText },
				{ name: "margin-left", values: valueFreeText },
				{ name: "padding", values: valueFreeText },
				{ name: "padding-top", values: valueFreeText },
				{ name: "padding-right", values: valueFreeText },
				{ name: "padding-bottom", values: valueFreeText },
				{ name: "padding-left", values: valueFreeText },
				{ name: "border", values: valueFreeText },
				{ name: "border-top", values: valueFreeText },
				{ name: "border-right", values: valueFreeText },
				{ name: "border-bottom", values: valueFreeText },
				{ name: "border-left", values: valueFreeText },
				{ name: "border-color", values: valueColor },
				{ name: "border-width", values: valueFreeText },
				{ name: "border-style", values: ["none", "hidden", "dashed", "dotted", "double", "groove", "inset", "outset", "ridge", "solid"] },
				{ name: "border-collapse", values: ["collapse", "separate"] },
				{ name: "background", values: valueFreeText },
				{ name: "background-color", values: valueColor },
				{ name: "background-image", values: valueImage },
				{ name: "background-attachment", values: ["fixed", "scroll"] },
				{ name: "background-size", values: valueFreeText },
				{ name: "background-position", values: valueFreeText },
				{ name: "background-repeat", values: ["no-repeat", "repeat", "repeat-x", "repeat-y"] },
				{ name: "width", values: valueFreeText },
				{ name: "height", values: valueFreeText },
				{ name: "min-width", values: valueFreeText },
				{ name: "min-height", values: valueFreeText },
				{ name: "max-width", values: valueFreeText },
				{ name: "max-height", values: valueFreeText },
				{ name: "z-index", values: valueFreeText },
				{ name: "box-shadow", values: valueFreeText },
				{ name: "box-sizing", values: ["border-box", "content-box"] },
				{ name: "color", values: valueColor },
				{ name: "opacity", values: valueFreeText },
				{ name: "line-height", values: valueFreeText },
				{ name: "font", values: valueFreeText },
				{ name: "font-family", values: valueFreeText },
				{ name: "font-size", values: valueFreeText },
				{ name: "font-style", values: ["normal", "italic"] },
				{ name: "font-weight", values: ["normal", "bold", "100", "200", "300", "400", "500", "600", "700", "800", "900"] },
				{ name: "cursor", values: ["auto", "crosshair", "default", "pointer", "move", "e-resize", "ne-resize", "nw-resize", "n-resize", "se-resize", "sw-resize", "s-resize", "w-resize", "text", "wait", "help", "progress", "copy", "alias", "context-menu", "cell", "not-allowed", "col-resize", "row-resize", "no-drop", "vertical-text", "all-scroll", "nesw-resize", "nwse-resize", "ns-resize", "ew-resize"] },
				{ name: "top", values: valueFreeText },
				{ name: "right", values: valueFreeText },
				{ name: "bottom", values: valueFreeText },
				{ name: "left", values: valueFreeText },
				{ name: "display", values: ["none", "block", "inline", "inline-block"] },
				{ name: "position", values: ["static", "relative", "absolute", "fixed"] },
				{ name: "float", values: ["left", "right"] },
				{ name: "resize", values: ["none", "both", "horizontal", "vertical"] },
				{ name: "text-align", values: ["left", "right", "center", "justify"] },
				{ name: "text-shadow", values: valueFreeText },
				{ name: "overflow", values: ["auto", "hidden", "visible", "scroll"] },
				{ name: "text-overflow", values: ["clip", "ellipsis"] },
				{ name: "text-decoration", values: valueFreeText },
				{ name: "text-decoration-line", values: ["none", "underline", "overline", "line-through", "blink"] },
				{ name: "text-decoration-color", values: valueColor },
				{ name: "text-decoration-style", values: ["solid", "double", "dotted", "dashed", "wavy"] },
				{ name: "vertical-align", values: ["baseline", "sub", "super", "text-top", "text-bottom", "middle", "top", "bottom"] },
				{ name: "visibility", values: ["visible", "hidden"] },
				{ name: "white-space", values: ["normal", "nowrap", "pre", "pre-wrap", "pre-line", "break-spaces"] },
			],
			cssAttributesByName = {},
			editorContainer = _ID("editorContainer"),
			editor = _ID("editor"),
			editorCss = _ID("editorCss"),
			loremIpsum = [
				"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse erat nulla, mattis et maximus in, molestie at felis. Vestibulum ac eros vel est commodo egestas. Fusce blandit, purus sit amet aliquam tincidunt, nisl mauris euismod nisi, euismod pulvinar dolor metus sit amet orci. Praesent lectus magna, porta a volutpat ac, egestas a dui. Quisque semper, ex eget pretium faucibus, ante ipsum dictum nisl, sed iaculis ante nisi vehicula arcu. Praesent at feugiat dolor, placerat auctor ligula. Cras venenatis viverra nisi eu volutpat.",
				"Morbi sed tortor ac lectus porta vehicula. Nullam venenatis magna in accumsan sodales. Donec massa orci, egestas vel tincidunt eu, laoreet et enim. Curabitur fermentum tempor felis, ac condimentum urna dictum sed. Maecenas at purus finibus, pellentesque sem at, scelerisque lorem. Nam pretium vitae lorem ac volutpat. Integer ligula turpis, lobortis quis congue ut, suscipit semper velit. Integer scelerisque quis lacus eu imperdiet. Integer ex tortor, finibus nec ultrices quis, pretium vel elit. Phasellus tincidunt hendrerit purus, in cursus erat euismod vitae.",
				"In laoreet iaculis nibh, ut varius massa consectetur sit amet. Pellentesque auctor purus id sem posuere porta. Praesent vitae massa mi. Donec eget tellus egestas, aliquet justo vitae, vulputate lacus. Praesent eu tempor eros. Proin risus tellus, accumsan quis magna eget, viverra rutrum nunc. Nullam id placerat nisl, vel tempor augue. Phasellus dignissim dapibus dui a sollicitudin. Nam vulputate accumsan suscipit. Ut rhoncus risus a volutpat porta. Praesent eros ipsum, molestie eget dictum nec, malesuada vitae lectus. Aliquam pretium fermentum arcu, ultricies varius magna lobortis sit amet. Aenean tristique nisl sit amet turpis fringilla suscipit. Maecenas tincidunt, orci eget tincidunt suscipit, lectus nibh condimentum odio, non fermentum purus libero sagittis nibh. Nulla finibus, nulla ut gravida gravida, massa ipsum auctor lectus, et aliquam ligula sapien id felis.",
				"Donec quis iaculis lorem. Vestibulum sollicitudin felis massa, et commodo neque sagittis sed. Phasellus et laoreet ligula, id lacinia orci. Suspendisse luctus eget odio et fringilla. Phasellus vel velit at ligula ullamcorper sollicitudin. Ut efficitur varius diam, fringilla accumsan nisi mattis vitae. Cras dapibus nec augue posuere rhoncus. Mauris dolor felis, malesuada et risus eu, tempus rhoncus libero. Quisque iaculis volutpat nunc, lacinia aliquet libero viverra in. Etiam sit amet lectus ut ante gravida malesuada sed a massa. Nulla a blandit lacus. Ut eleifend convallis libero a posuere. Fusce a tempus urna, eu molestie enim.",
				"Cras fringilla, leo eu dignissim placerat, ligula lacus efficitur enim, eu congue arcu ante eu odio. Donec egestas bibendum est. Etiam non dolor pharetra, scelerisque tortor a, pulvinar diam. Suspendisse euismod elit lacus, ac gravida ligula malesuada nec. Etiam fringilla nisl odio, et luctus lorem posuere at. Nam justo enim, blandit ac lorem vitae, vestibulum scelerisque leo. Pellentesque molestie mattis neque non imperdiet. Nulla commodo orci risus, id molestie ex efficitur non. Sed quis elit non ante aliquet pharetra. Morbi lacinia mi metus, gravida accumsan ante cursus et. Morbi sed ipsum augue.",
				"Curabitur vel turpis maximus, rhoncus metus at, fringilla massa. Nunc bibendum eros eget nunc scelerisque dictum. In dignissim imperdiet dolor, non ornare metus iaculis nec. Fusce nec rhoncus lectus, id rutrum odio. Nam varius ornare elit. Duis eget cursus diam. Proin fringilla ex libero, at consequat risus vulputate in. Proin nec magna ut tortor placerat commodo ut id metus. Praesent mollis quam id purus vulputate consectetur. Nam at tortor sit amet tellus vestibulum tempus. Pellentesque ante ipsum, viverra ut imperdiet sed, commodo mollis nibh.",
				"Curabitur cursus lacus at commodo dictum. Sed sed pharetra purus. Quisque pharetra neque dolor, a interdum arcu eleifend quis. Donec feugiat mollis justo ut molestie. Donec sit amet eros eu sapien cursus sollicitudin at ac dolor. Duis in interdum eros, vitae rutrum lacus. Sed placerat ac arcu sit amet fringilla. Suspendisse et tincidunt augue. Duis mattis ex leo, nec iaculis orci porta in. Donec ultrices risus tempus est dignissim laoreet. Sed justo dolor, mattis ut dolor et, interdum pharetra neque. Aenean congue enim ligula, vitae interdum metus consectetur at.",
				"Sed ullamcorper gravida odio vel auctor. Proin in velit pulvinar, consequat arcu non, congue arcu. Morbi ut egestas magna. Integer mattis lectus nec magna fringilla, vel gravida nisl eleifend. Quisque condimentum commodo mollis. Mauris convallis massa nec tincidunt porta. Fusce faucibus eros quis ante dignissim, maximus auctor justo posuere.",
				"Integer nibh orci, finibus eu cursus nec, aliquam vitae augue. Sed lectus lectus, venenatis et venenatis eget, efficitur et turpis. Fusce enim nibh, imperdiet sit amet condimentum vel, suscipit et ex. Nullam elementum consequat elementum. Ut tempor, ante sed posuere vehicula, sapien est commodo sapien, ultrices porttitor magna felis at felis. Maecenas rutrum vehicula nisl, quis semper ex blandit quis. Aenean neque nunc, hendrerit sed feugiat sit amet, aliquet sed sapien. Ut varius lobortis nisi.",
				"Donec urna dolor, congue ac dolor at, consequat laoreet mi. Vivamus a turpis lacus. Morbi diam velit, vestibulum sit amet feugiat vitae, laoreet at enim. Praesent facilisis convallis condimentum. Fusce ac mi risus. Donec pharetra augue nec pharetra tincidunt. Fusce vestibulum eros leo, sed bibendum felis vehicula non. Integer quis arcu arcu. Nam molestie nunc ac lorem consequat efficitur. Vestibulum et egestas mauris. Suspendisse vehicula tincidunt justo. Nunc vitae malesuada erat, in gravida arcu. Curabitur placerat, ex quis egestas placerat, erat urna bibendum mauris, at finibus nisi tortor in eros."
			],
			moveTargetTop = 1,
			moveTargetClosingTag = 2,
			placeholderText = null,
			bodyElement = null,
			lastEditedRuleSelector = "",
			iframe = _ID("iframe"),
			iframeWindow = null,
			iframeDocument = null,
			iframeBody = null,
			iframeStyle = null;

		function iframeLoaded(win, doc, style) {
			iframeWindow = win;
			iframeDocument = doc;
			iframeBody = doc.body;
			iframeStyle = style;

			loading = false;

			createElement("body");
			createRule("body");
		}

		function tagClick(e) {
			dropdownShow(e, this.element, false);
		}

		function closingTagClick(e) {
			dropdownShow(e, this.element, true);
		}

		function createElement(name, parent, siblingBelow, hideUI) {
			if (loading)
				return;

			if (!parent) {
				// The body element is a special case
				bodyElement = _CE("div", "element");
				// These attribute names were chosen like this in order to
				// avoid any conflicts with existing attribute names!
				bodyElement.elementCategory = categoryElement;
				bodyElement.elementType = elementTypeBody;
				bodyElement.elementParent = null;
				bodyElement.elementIframe = iframeBody;

				bodyElement.elementTag = _CE("span", "element-tag", bodyElement);
				bodyElement.elementTag.element = bodyElement;
				bodyElement.elementTag.onclick = tagClick;
				_TXT("<", bodyElement.elementTag);
				_TXT("body", _CE("span", "element-name-block", bodyElement.elementTag));
				_TXT(">", bodyElement.elementTag);

				bodyElement.elementContainer = _CE("div", "element-container", bodyElement);
				bodyElement.elementContainer.element = bodyElement;

				bodyElement.elementClosingTag = _CE("span", "element-tag move-target", bodyElement);
				bodyElement.elementClosingTag.element = bodyElement;
				bodyElement.elementClosingTag.onclick = closingTagClick;
				bodyElement.elementClosingTag.moveTarget = moveTargetClosingTag;
				_TXT("</", bodyElement.elementClosingTag);
				_TXT("body", _CE("span", "element-name-block", bodyElement.elementClosingTag));
				_TXT(">", bodyElement.elementClosingTag);

				_AC(editor, bodyElement);

				return bodyElement;
			}

			var e, elementType = elementTypesByName[name];
			if (!elementType)
				return;

			if (elementType !== elementTypeText &&
				elementType !== elementTypeComment &&
				elementType.block && !parent.elementType.block) {
				Notification.error(translate("ErrorBlockInsideInline"), true);
				return;
			}

			e = _CE("div", "element");
			e.elementCategory = categoryElement;
			e.elementParent = parent;
			e.elementType = elementType;

			if (elementType === elementTypeText) {
				e.elementTag = _CE("div", "element-tag element-text move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				e.elementTag.empty = true;
				_TXT(placeholderText, e.elementTag);
				e.elementIframe = _ITXT("");
			} else if (elementType === elementTypeComment) {
				e.elementTag = _CE("div", "element-tag element-comment move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				_TXT("<!--\n", e.elementTag);
				_TXT("", e.elementComment = _CE("span", "", e.elementTag));
				_TXT("\n-->", e.elementTag);
				e.elementIframe = _ICMT("");
			} else {
				e.elementTag = _CE("span", "element-tag move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				_TXT("<", e.elementTag);
				_TXT(name, _CE("span", elementType.block ? "element-name-block" : "element-name", e.elementTag));
				_TXT(elementType.noChildren ? " />" : ">", e.elementTag);
				e.elementIframe = _ICE(name);

				if (!elementType.noChildren) {
					e.elementContainerVisible = true;
					e.elementContainerPlaceholder = _CE("span", "hidden", e);
					_TXT("...", e.elementContainerPlaceholder);
					e.elementContainer = _CE("div", "element-container", e);
					e.elementContainer.element = e;

					e.elementClosingTag = _CE("span", "element-tag move-target", e);
					e.elementClosingTag.element = e;
					e.elementClosingTag.onclick = closingTagClick;
					e.elementClosingTag.moveTarget = moveTargetClosingTag;
					_TXT("</", e.elementClosingTag);
					_TXT(name, _CE("span", elementType.block ? "element-name-block" : "element-name", e.elementClosingTag));
					_TXT(">", e.elementClosingTag);
				}
			}

			if (siblingBelow) {
				_IB(parent.elementContainer, e, siblingBelow);
				_IB(parent.elementIframe, e.elementIframe, siblingBelow.elementIframe);
			} else {
				_AC(parent.elementContainer, e);
				_AC(parent.elementIframe, e.elementIframe);
			}

			if ((elementType === elementTypeText || elementType === elementTypeComment) && !hideUI)
				editText(e);

			return e;
		}

		function deleteElement(element) {
			if (loading || !element || !element.elementParent || !element.elementParent.elementContainer)
				return;

			_RC(element.elementParent.elementContainer, element);
			_RC(element.elementParent.elementIframe, element.elementIframe);
		}

		function getElementText(element) {
			return (element.elementType === elementTypeComment ? element.elementComment.textContent : (element.elementType === elementTypeText && !element.elementTag.empty ? element.elementTag.firstChild.nodeValue : ""));
		}

		function setElementText(element, text) {
			if (element.elementType === elementTypeText) {
				var elementTag = element.elementTag;
				if (!text) {
					elementTag.empty = true;
					elementTag.firstChild.nodeValue = placeholderText;
					element.elementIframe.nodeValue = "";
				} else {
					elementTag.empty = false;
					elementTag.firstChild.nodeValue = text;
					element.elementIframe.nodeValue = text;
				}
			} else if (element.elementType === elementTypeComment) {
				element.elementComment.textContent = text;
				element.elementIframe.nodeValue = "\n" + text + "\n";
			}
		}

		function editText(element) {
			if (loading || !element || (element.elementType !== elementTypeText && element.elementType !== elementTypeComment))
				return;

			var modalTxtInput = _ID("modalTxtInput"),
				modalTxtOk = _ID("modalTxtOk");
			modalTxtInput.value = getElementText(element);
			modalTxtOk.onclick = function () {
				$("#modalTxt").modal("hide");
				setElementText(element, modalTxtInput.value);
			};
			$("#modalTxt").modal({
				keyboard: true,
				backdrop: true
			});
		}

		function changeType(newName, element) {
			if (loading || !element)
				return;

			var i, newElementType = elementTypesByName[newName];
			if (!newElementType || newElementType === elementTypeText || element.elementType === newElementType)
				return;

			if (newElementType.block) {
				if (!element.elementParent.elementType.block) {
					Notification.error(translate("ErrorBlockInsideInline"), true);
					return;
				}
			} else if (!element.elementType.noChildren) {
				for (i = element.elementContainer.childNodes.length - 1; i >= 0; i--) {
					if (element.elementContainer.childNodes[i].elementType.block) {
						Notification.error(translate("ErrorInlineParentBlock"), true);
						return;
					}
				}
			}

			if (!newElementType.noChildren !== !element.elementType.noChildren) {
				Notification.error(translate(newElementType.noChildren ? "ErrorNewElementMustHaveChildren" : "ErrorNewElementMustNotHaveChildren"), true);
				return;
			}

			var newElement = createElement(newName, element.elementParent, element);

			if (!element.elementType.noChildren) {
				var e,
					container = element.elementContainer,
					newContainer = newElement.elementContainer,
					icontainer = element.elementIframe,
					inewContainer = newElement.elementIframe;
				while ((e = container.firstChild)) {
					_RC(container, e);
					e.elementParent = newElement;
					_AC(newContainer, e);
					_RC(icontainer, e.elementIframe);
					_AC(inewContainer, e.elementIframe);
				}
			}

			deleteElement(element);
		}

		function toggleVisibility(element) {
			if (loading || !element || (element.elementCategory === categoryElement && element.elementType.noChildren) || element.elementCategory === categoryRuleAttribute)
				return;

			element.elementContainerVisible = !element.elementContainerVisible;
			if (element.elementContainerVisible) {
				element.elementContainerPlaceholder.className = "hidden";
				element.elementContainer.className = "element-container";
			} else {
				element.elementContainer.className = "hidden";
				element.elementContainerPlaceholder.className = "";
			}
		}

		function lockUI(lock) {
			if (lock) {
				editorContainer.style.pointerEvents = "none";
				iframe.style.pointerEvents = "none";
				bar.style.pointerEvents = "none";
			} else {
				editorContainer.style.pointerEvents = "";
				iframe.style.pointerEvents = "";
				bar.style.pointerEvents = "";
			}
		}

		function loadFileDataURL(file, callback) {
			if (loading) {
				callback(null);
				return;
			}

			if (!("FileReader" in window)) {
				Notification.error(translate("ErrorNoFile"), true);
				callback(null);
				return;
			}

			loading = true;
			Notification.wait();

			var reader = new FileReader();
			reader.onload = function () {
				loading = false;
				Notification.hide();
				callback(reader.result);
			};
			reader.onerror = function () {
				loading = false;
				Notification.error(translate("ErrorFileLoad"), true);
				callback(null);
			};
			reader.readAsDataURL(file);
		}

		function createRule(ruleSelector, siblingBelow, hideUI) {
			if (loading)
				return;

			// For the future... Perhaps we could use the CSSStyleSheet API?!?!
			// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule

			var e = _CE("div", "element");
			// These attribute names were chosen like this in order to
			// avoid any conflicts with existing attribute names!
			e.elementCategory = categoryRule;
			e.elementRuleSelector = trim(ruleSelector || lastEditedRuleSelector || "p");

			e.elementTag = _CE("span", "element-tag move-target", e);
			e.elementTag.element = e;
			e.elementTag.onclick = tagClick;
			e.elementTag.moveTarget = moveTargetTop;
			_TXT(e.elementRuleSelector, _CE("span", "element-name-block", e.elementTag));
			_TXT(" {", e.elementTag);

			e.elementContainerVisible = true;
			e.elementContainerPlaceholder = _CE("span", "hidden", e);
			_TXT("...", e.elementContainerPlaceholder);
			e.elementContainer = _CE("div", "element-container", e);
			e.elementContainer.element = e;

			e.elementClosingTag = _CE("span", "element-tag move-target", e);
			e.elementClosingTag.element = e;
			e.elementClosingTag.onclick = closingTagClick;
			e.elementClosingTag.moveTarget = moveTargetClosingTag;
			_TXT("}", e.elementClosingTag);

			if (siblingBelow)
				_IB(editorCss, e, siblingBelow);
			else
				_AC(editorCss, e);

			if (!ruleSelector && !hideUI)
				editRuleSelector(e);

			return e;
		}

		function deleteRule(element) {
			if (loading || !element || element.elementCategory !== categoryRule)
				return;

			_RC(editorCss, element);
		}

		function getRuleSelector(element) {
			return ((element.elementCategory === categoryRule && element.elementRuleSelector) || "");
		}

		function setRuleSelector(element, newRuleSelector) {
			if (element.elementCategory === categoryRule && newRuleSelector) {
				element.elementRuleSelector = newRuleSelector;
				element.elementTag.firstChild.textContent = newRuleSelector;
			}
		}

		function editRuleSelector(element) {
			if (loading || !element || element.elementCategory !== categoryRule)
				return;

			var modalRuleSelectorInput = _ID("modalRuleSelectorInput"),
				modalRuleSelectorOk = _ID("modalRuleSelectorOk");
			modalRuleSelectorInput.value = getRuleSelector(element);
			modalRuleSelectorOk.onclick = function () {
				var newRuleSelector = trimValue(modalRuleSelectorInput);
				if (!newRuleSelector)
					return;
				lastEditedRuleSelector = newRuleSelector;
				$("#modalRuleSelector").modal("hide");
				setRuleSelector(element, newRuleSelector);
			};
			$("#modalRuleSelector").modal({
				keyboard: true,
				backdrop: true
			});
		}

		// Translation
		(function () {
			if (!window.editorStrings || (typeof window.editorStrings !== "object")) window.editorStrings = {};

			function addString(key, value) { if (!window.editorStrings[key]) window.editorStrings[key] = value; }

			addString("OK", "OK");
			addString("Cancel", "Cancelar");
			addString("Close", "Fechar");
			addString("Menu", "Menu");
			addString("New", "Novo");
			addString("Load", "Abrir");
			addString("Save", "Salvar");
			addString("FileName", "Nome do Arquivo");
			addString("LoadEllipsis", "Abrir...");
			addString("SaveEllipsis", "Salvar...");
			addString("ExportHTML", "Exportar HTML...");
			addString("EditText", "Editar Texto");
			addString("NewText", "Novo Texto");
			addString("EditComment", "Editar Comment");
			addString("NewComment", "Novo Comment");
			addString("EditSelector", "Editar Seletor");
			addString("NewSelector", "Novo Seletor");
			addString("Move", "Mover");
			addString("Duplicate", "Duplicar");
			addString("Delete", "Excluir");
			addString("ElementName", "Nome do Elemento");
			addString("FindElement", "Localizar Elemento");
			addString("ChangeElement", "Alterar Elemento");
			addString("EditAttributes", "Editar Atributos");
			addString("CreateElement", "Criar Elemento");
			addString("CreateRule", "Criar Regra");
			addString("CreateText", "Criar Texto");
			addString("CreateComment", "Criar Comentário");
			addString("LoadImage", "Carregar Imagem");
			addString("UseLoremIpsum", "Utilizar Parágrafo de Lorem Ipsum");
			addString("PlaceholderText", "[Digite seu texto aqui]");
			addString("ErrorBlockInsideInline", "Um elemento block não pode ser filho de um elemento inline \uD83D\uDE22");
			addString("ErrorInlineParentBlock", "Um elemento inline não pode ser pai de um elemento block \uD83D\uDE22");
			addString("ErrorNewElementMustHaveChildren", "O novo elemento também deve poder ter filhos \uD83D\uDE22");
			addString("ErrorNewElementMustNotHaveChildren", "O novo elemento também não pode ter filhos \uD83D\uDE22");
			addString("ErrorNoFile", "Seu browser não oferece suporte a acesso avançado de arquivos \uD83D\uDE22");
			addString("ErrorFileTooLarge", "Por favor, escolha uma imagem com tamanho de até 1 MiB \uD83D\uDE22");
			addString("ErrorFileLoad", "Ocorreu um erro ao ler o arquivo \uD83D\uDE22");
			addString("ErrorInvalidHTML", "O arquivo escolhido não parece ser um arquivo HTML válido \uD83D\uDE22");
			addString("ConfirmQuit", "Deseja mesmo sair da página? Você perderá o documento atual.");
			addString("MoveMessage", "Clique sobre onde deseja mover o elemento, ou tecle Esc para cancelar");
			addString("HideChildren", "Ocultar Filhos");
			addString("ShowChildren", "Mostrar Filhos");
			addString("ElementHelp", "Ajuda do Elemento");

			window.translate = function (key) { return (editorStrings[key] || key); };

			placeholderText = translate("PlaceholderText");

			function translateChildren(childNodes) {
				var i, c, d, idx, attr, key;
				for (i = childNodes.length - 1; i >= 0; i--) {
					c = childNodes[i];
					if (!c.tagName)
						continue;
					if (c.childNodes && c.childNodes.length)
						translateChildren(c.childNodes);
					if (!(d = c.getAttribute("data-string")) || (idx = d.indexOf("|")) <= 0)
						continue;
					attr = d.substr(0, idx);
					key = d.substr(idx + 1);
					if (attr === "text")
						_TXT(translate(key), c);
					else
						_SA(c, attr, translate(key));
				}
			}

			translateChildren(document.body.childNodes);
		})();

		// Initial
		(function () {
			var i, a, e,
				modalTxtInput = _ID("modalTxtInput"),
				modalTxtOk = _ID("modalTxtOk"),
				modalTxtBtnLoremIpsum = _ID("modalTxtBtnLoremIpsum"),
				modalTxtSelectLoremIpsum = _ID("modalTxtSelectLoremIpsum"),
				modalRuleSelectorInput = _ID("modalRuleSelectorInput"),
				modalRuleSelectorOk = _ID("modalRuleSelectorOk");

			$("#modalTxt").on("shown.bs.modal", function () {
				modalTxtInput.focus();
			});
			//modalTxtInput.onkeydown = function (e) {
			//	if (e.key === "Enter" || e.keyCode === 13)
			//		modalTxtOk.click();
			//};
			modalTxtBtnLoremIpsum.onclick = function () {
				modalTxtInput.value = loremIpsum[parseInt(modalTxtSelectLoremIpsum.value)];
				modalTxtOk.click();
			};
			for (i = 0; i < loremIpsum.length; i++)
				_TXT((i + 1).toString(), _SA(_CE("option", null, modalTxtSelectLoremIpsum), "value", i));

			$("#modalRuleSelector").on("shown.bs.modal", function () {
				modalRuleSelectorInput.focus();
			});
			modalRuleSelectorInput.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalRuleSelectorOk.click();
			};

			function sortByName(a, b) {
				return (a.name < b.name ? -1 : 1);
			}

			for (i = elementTypes.length - 1; i >= 0; i--) {
				e = elementTypes[i];
				elementTypesByName[e.name] = e;
				e.urlHelp = "https://developer.mozilla.org/en-US/docs/Web/HTML/Element/" + e.name;
				a = e.attributes;
				if (!a) {
					e.attributes = htmlAttributes;
				} else {
					a.push.apply(a, htmlAttributes);
					a.sort(function (a, b) {
						if (!a.common === !b.common)
							return (a.name < b.name ? -1 : 1);
						return (a.common ? -1 : 1);
					});
				}
			}

			for (i = cssAttributes.length - 1; i >= 0; i--) {
				e = cssAttributes[i];
				cssAttributesByName[e.name] = e;
				e.urlHelp = "https://developer.mozilla.org/en-US/docs/Web/CSS/" + e.name;
				e.common = true;
			}

			elementTypes.sort(sortByName);
			cssAttributes.sort(sortByName);

			elementTypeBody = {
				name: "body",
				block: true,
				attributes: null
			};
			elementTypeText = {
				name: "text",
				attributes: null,
				noChildren: true
			};
			elementTypeComment = {
				name: "comment",
				attributes: null,
				noChildren: true
			};
			elementTypesByName["text"] = elementTypeText;
			elementTypesByName["comment"] = elementTypeComment;

			_SA(iframe, "src", "empty.html");

			window.onbeforeunload = function () {
				return null; // translate("ConfirmQuit")
			};

			setTimeout(function () { document.body.style.visibility = ""; }, 250);
		})();

		// Resize
		(function () {
			var bar = _ID("bar");
			var barDrag = false;
			var barDragX = 0;
			var barX = (window.innerWidth >> 1);

			function resizeWindow() {
				var width = (window.innerWidth | 0);
				var editorWidth = barX, iframeWidth = width - editorWidth - 8;
				if (iframeWidth < 150) {
					iframeWidth = 150;
					editorWidth = width - iframeWidth - 8;
				}
				if (editorWidth < 150) {
					editorWidth = 150;
					iframeWidth = width - editorWidth - 8;
				}
				editorContainer.style.width = editorWidth + "px";
				bar.style.left = editorContainer.style.width;
				iframe.style.left = (width - iframeWidth) + "px";
				iframe.style.width = iframeWidth + "px";
			}

			window.onresize = resizeWindow;

			bar.onmousedown = function (e) {
				if (e.button)
					return;
				var rect = bar.getBoundingClientRect();
				barDragX = (e.clientX - rect.left) | 0;
				barDrag = true;
				document.body.style.cursor = "ew-resize";
				editorContainer.style.cursor = "ew-resize";
				iframe.style.cursor = "ew-resize";
				bar.className = "editor-bar editor-bar-drag";
				lockUI(true);
				return cancelEvent(e);
			};

			document.addEventListener("mousemove", function (e) {
				if (!barDrag)
					return;
				var x = (e.clientX - barDragX) | 0;
				if (barX !== x) {
					barX = x;
					resizeWindow();
				}
			}, true);

			document.addEventListener("mouseup", function (e) {
				if (!barDrag)
					return;
				barDrag = false;
				document.body.style.cursor = "";
				editorContainer.style.cursor = "";
				iframe.style.cursor = "";
				bar.className = "editor-bar";
				lockUI(false);
			}, true);

			resizeWindow();
			bar.style.display = "block";
		})();

		// DropdownMenus
		(function () {
			var dropdownX = 0,
				dropdownY = 0,
				dropdownFading = false, dropdownMoving = false,
				dropdownVisible = false, dropdownTypeVisible = false, dropdownHighlighting = false,
				dropdownActionTop = false, dropdownActionClosingTag = false, dropdownActionChangeType = false, dropdownActionEditRuleSelector = false,
				dropdownShowTop = false, dropdownShowLeft = false, dropdownShowRight = false, dropdownShowBottom = false,
				dropdownShowTypeOnHide = false, dropdownCreateTextOnHide = false, dropdownCreateCommentOnHide = false, dropdownMoveOnHide = false, dropdownEditTextOnHide = false, dropdownEditAttributesOnHide = false, dropdownCreateEditRuleOnHide = false,
				dropdownElement = null,
				dropdownType = _ID("dropdownType"),
				dropdownTypeInput = _("dropdownTypeInput"),
				dropdownTypeContainer = _("dropdownTypeContainer"),
				dropdownMenuTop = _ID("dropdownMenuTop"),
				dropdownMenuTopCreateElement = _ID("dropdownMenuTopCreateElement"),
				dropdownMenuTopCreateRule = _ID("dropdownMenuTopCreateRule"),
				dropdownMenuTopCreateText = _ID("dropdownMenuTopCreateText"),
				dropdownMenuTopCreateComment = _ID("dropdownMenuTopCreateComment"),
				dropdownMenuLeft = _ID("dropdownMenuLeft"),
				dropdownMenuLeftToggleVisibility = _ID("dropdownMenuLeftToggleVisibility"),
				dropdownMenuRight = _ID("dropdownMenuRight"),
				dropdownMenuRightEditText = _ID("dropdownMenuRightEditText"),
				dropdownMenuRightFind = _ID("dropdownMenuRightFind"),
				dropdownMenuRightChangeType = _ID("dropdownMenuRightChangeType"),
				dropdownMenuRightEditRuleSelector = _ID("dropdownMenuRightEditRuleSelector"),
				dropdownMenuRightEditAttributes = _ID("dropdownMenuRightEditAttributes"),
				dropdownMenuBottom = _ID("dropdownMenuBottom"),
				dropdownMenuBottomCreateElement = _ID("dropdownMenuBottomCreateElement"),
				dropdownMenuBottomCreateRule = _ID("dropdownMenuBottomCreateRule"),
				dropdownMenuBottomCreateText = _ID("dropdownMenuBottomCreateText"),
				dropdownMenuBottomCreateComment = _ID("dropdownMenuBottomCreateComment");

			dropdownTypeContainer.style.height = (300 - 59) + "px";

			function fadeInFinished() {
				dropdownFading = false;
				if (dropdownShowTop)
					dropdownMenuTop.style.pointerEvents = "";
				if (dropdownShowLeft)
					dropdownMenuLeft.style.pointerEvents = "";
				if (dropdownShowRight)
					dropdownMenuRight.style.pointerEvents = "";
				if (dropdownShowBottom)
					dropdownMenuBottom.style.pointerEvents = "";
			}

			function fadeInTypeFinished() {
				dropdownFading = false;
				dropdownType.style.pointerEvents = "";
				dropdownTypeInput.focus();
				dropdownTypeInput.setSelectionRange(0, dropdownTypeInput.value.length);
			}

			function fadeOutFinished() {
				dropdownFading = false;
				dropdownMenuTop.style.display = "";
				dropdownMenuLeft.style.display = "";
				dropdownMenuRight.style.display = "";
				dropdownMenuBottom.style.display = "";

				if (dropdownShowTypeOnHide) {
					dropdownShowTypeOnHide = false;
					dropdownTypeVisible = true;
					dropdownFading = true;
					document.addEventListener("mousedown", mouseDown, true);
					document.addEventListener("keydown", keyDown, true);
					var width = (window.innerWidth | 0),
						height = (window.innerHeight | 0),
						x = dropdownX,
						y = dropdownY;
					if ((x + 160 + 4) > width)
						x = width - 160 - 4;
					if ((y + 300 + 4) > height)
						y = height - 300 - 4;
					dropdownType.style.display = "block";
					dropdownType.style.left = x + "px";
					dropdownType.style.top = y + "px";
					dropdownType.style.width = 160 + "px";
					dropdownType.style.height = 300 + "px";
					setTimeout(startFadeInType, 50);
					return;
				} else if (dropdownCreateTextOnHide) {
					dropdownCreateTextOnHide = false;
					dropdownCreateElement("text");
				} else if (dropdownCreateCommentOnHide) {
					dropdownCreateCommentOnHide = false;
					dropdownCreateElement("comment");
				} else if (dropdownMoveOnHide) {
					lockUI(false);
					dropdownMoveOnHide = false;
					move(true);
				} else if (dropdownEditTextOnHide) {
					dropdownEditTextOnHide = false;
					editText(dropdownElement);
				} else if (dropdownEditAttributesOnHide) {
					dropdownEditAttributesOnHide = false;
					showModalAttributes();
				} else if (dropdownCreateEditRuleOnHide) {
					dropdownCreateEditRuleOnHide = false;
					if (dropdownActionEditRuleSelector)
						editRuleSelector(dropdownElement);
					else if (dropdownActionTop)
						createRule("", dropdownElement);
					else
						createRule("", dropdownElement.nextSibling);
				}

				lockUI(false);
			}

			function fadeOutTypeFinished() {
				dropdownFading = false;
				dropdownType.style.display = "";
				lockUI(false);
			}

			function startFadeIn() {
				if (dropdownShowTop) {
					dropdownMenuTop.style.pointerEvents = "none";
					dropdownMenuTop.className = "editor-menu editor-menu-animated editor-menu-top editor-menu-visible";
				}
				if (dropdownShowLeft) {
					dropdownMenuLeft.style.pointerEvents = "none";
					dropdownMenuLeft.className = "editor-menu editor-menu-animated editor-menu-left editor-menu-visible";
				}
				if (dropdownShowRight) {
					dropdownMenuRight.style.pointerEvents = "none";
					dropdownMenuRight.className = "editor-menu editor-menu-animated editor-menu-right editor-menu-visible";
				}
				if (dropdownShowBottom) {
					dropdownMenuBottom.style.pointerEvents = "none";
					dropdownMenuBottom.className = "editor-menu editor-menu-animated editor-menu-bottom editor-menu-visible";
				}
				setTimeout(fadeInFinished, 210);
			}

			function startFadeInType() {
				dropdownType.style.pointerEvents = "none";
				dropdownType.className = "dropdown-menu editor-menu-animated editor-menu-visible";
				setTimeout(fadeInTypeFinished, 210);
			}

			function startFadeOut() {
				dropdownFading = true;
				dropdownVisible = false;
				dropdownMenuTop.style.pointerEvents = "none";
				dropdownMenuLeft.style.pointerEvents = "none";
				dropdownMenuRight.style.pointerEvents = "none";
				dropdownMenuBottom.style.pointerEvents = "none";
				dropdownMenuTop.className = "editor-menu editor-menu-animated editor-menu-top";
				dropdownMenuLeft.className = "editor-menu editor-menu-animated editor-menu-left";
				dropdownMenuRight.className = "editor-menu editor-menu-animated editor-menu-right";
				dropdownMenuBottom.className = "editor-menu editor-menu-animated editor-menu-bottom";
				setTimeout(fadeOutFinished, 210);
			}

			function startFadeOutType() {
				dropdownFading = true;
				dropdownTypeVisible = false;
				dropdownType.style.pointerEvents = "none";
				dropdownType.className = "dropdown-menu editor-menu-animated";
				setTimeout(fadeOutTypeFinished, 210);
			}

			function hide() {
				document.removeEventListener("mousedown", mouseDown, true);
				document.removeEventListener("keydown", keyDown, true);
				if (dropdownVisible)
					startFadeOut();
				else if (dropdownTypeVisible)
					startFadeOutType();
			}

			function mouseDown(e) {
				if ((!dropdownVisible && !dropdownTypeVisible) || dropdownFading || e.button)
					return;
				// Ignore all clicks on the menus
				var t = e.target;
				while (t && t.parentNode && t !== document.body) {
					if (t === dropdownMenuTop || t === dropdownMenuLeft || t === dropdownMenuRight || t === dropdownMenuBottom || t === dropdownType)
						return;
					t = t.parentNode;
				}
				hide();
			}

			function keyDown(e) {
				if ((!dropdownVisible && !dropdownTypeVisible) || dropdownFading || dropdownMoving)
					return;
				if (e.key === "Escape" || e.keyCode === 27)
					hide();
			}

			function clickMoving(e) {
				if (!dropdownMoving || e.button)
					return;

				var moveTarget = e.target.moveTarget, targetElement, targetParent, parent;
				if (!moveTarget && e.target.parentNode) {
					moveTarget = e.target.parentNode.moveTarget;
					if (!moveTarget)
						return;
					targetElement = e.target.parentNode.element;
				} else {
					targetElement = e.target.element;
				}

				parent = targetElement;
				while (parent && parent !== bodyElement) {
					if (parent === dropdownElement)
						return;
					parent = parent.parentNode;
				}

				if (moveTarget === moveTargetClosingTag)
					targetParent = targetElement;
				else
					targetParent = targetElement.elementParent;

				if (dropdownElement.elementType.block) {
					parent = targetParent;
					while (parent && parent !== bodyElement) {
						if (!parent.elementType.block)
							return;
						parent = parent.elementParent;
					}
				}

				_RC(dropdownElement.parentNode, dropdownElement);
				_RC(dropdownElement.elementIframe.parentNode, dropdownElement.elementIframe);

				dropdownElement.elementParent = targetParent;

				if (moveTarget === moveTargetClosingTag) {
					_AC(targetParent.elementContainer, dropdownElement);
					_AC(targetParent.elementIframe, dropdownElement.elementIframe);
				} else {
					_IB(targetParent.elementContainer, dropdownElement, targetElement);
					_IB(targetParent.elementIframe, dropdownElement.elementIframe, targetElement.elementIframe);
				}

				move(false);

				cancelEvent(e);

				return false;
			}

			function keyDownMoving(e) {
				if (!dropdownMoving)
					return;
				if (e.key === "Escape" || e.keyCode === 27)
					move(false);
			}

			function move(start) {
				if (start) {
					dropdownMoving = true;
					document.addEventListener("click", clickMoving, true);
					document.addEventListener("keydown", keyDownMoving, true);
					$(dropdownElement).addClass("moving");
					$(editor).addClass("moving");
					Notification.show(translate("MoveMessage"), "default", -1, false);
				} else {
					dropdownMoving = false;
					document.removeEventListener("click", clickMoving, true);
					document.removeEventListener("keydown", keyDownMoving, true);
					$(dropdownElement).removeClass("moving");
					$(editor).removeClass("moving");
					Notification.hide();
				}
			}

			window.dropdownShow = function (e, element, closingTag) {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				var rect = (closingTag ? element.elementClosingTag : element.elementTag).getBoundingClientRect(),
					height = (rect.height | 0);

				dropdownX = (rect.left | 0) + 12;
				dropdownY = (rect.top | 0) + (height >> 1);
				dropdownVisible = true;
				dropdownFading = true;
				dropdownActionClosingTag = closingTag;
				dropdownActionChangeType = false;
				dropdownElement = element;
				lockUI(true);
				document.addEventListener("mousedown", mouseDown, true);
				document.addEventListener("keydown", keyDown, true);

				switch (element.elementCategory) {
					case categoryElement:
						dropdownShowTop = (closingTag || element.elementType !== elementTypeBody);
						dropdownShowLeft = (element.elementType !== elementTypeBody && !element.elementType.noChildren);
						dropdownShowRight = (element.elementType !== elementTypeBody);
						dropdownShowBottom = (!closingTag || element.elementType !== elementTypeBody);
						dropdownMenuTopCreateElement.style.display = "";
						dropdownMenuTopCreateRule.style.display = "none";
						dropdownMenuTopCreateText.style.display = "";
						dropdownMenuBottomCreateElement.style.display = "";
						dropdownMenuBottomCreateRule.style.display = "none";
						dropdownMenuBottomCreateText.style.display = "";
						dropdownMenuRightEditRuleSelector.style.display = "none";
						if (element.elementType === elementTypeText || element.elementType === elementTypeComment) {
							dropdownMenuRightEditText.style.display = "";
							dropdownMenuRightFind.style.display = "none";
							dropdownMenuRightChangeType.style.display = "none";
							dropdownMenuRightEditAttributes.style.display = "none";
						} else {
							dropdownMenuRightEditText.style.display = "none";
							dropdownMenuRightFind.style.display = "";
							dropdownMenuRightChangeType.style.display = "";
							dropdownMenuRightEditAttributes.style.display = "";
						}
						break;
					case categoryRule:
						dropdownShowTop = true;
						dropdownShowLeft = true;
						dropdownShowRight = true;
						dropdownShowBottom = true;
						dropdownMenuTopCreateElement.style.display = "none";
						dropdownMenuTopCreateRule.style.display = (closingTag ? "none" : "");
						dropdownMenuTopCreateText.style.display = "none";
						dropdownMenuBottomCreateElement.style.display = "none";
						dropdownMenuBottomCreateRule.style.display = (closingTag ? "" : "none");
						dropdownMenuBottomCreateText.style.display = "none";
						dropdownMenuRightEditRuleSelector.style.display = "";
						dropdownMenuRightEditText.style.display = "none";
						dropdownMenuRightFind.style.display = "none";
						dropdownMenuRightChangeType.style.display = "none";
						dropdownMenuRightEditAttributes.style.display = "none";
						break;
				}
				if (dropdownShowLeft) {
					if (dropdownElement.elementContainerVisible) {
						_SA(dropdownMenuLeftToggleVisibility, "title", translate("HideChildren"));
						dropdownMenuLeftToggleVisibility.firstChild.className = "fa fa-nomargin fa-minus";
					} else {
						_SA(dropdownMenuLeftToggleVisibility, "title", translate("ShowChildren"));
						dropdownMenuLeftToggleVisibility.firstChild.className = "fa fa-nomargin fa-plus";
					}
				}
				dropdownShowTypeOnHide = false;
				dropdownCreateTextOnHide = false;
				dropdownCreateCommentOnHide = false;
				dropdownMoveOnHide = false;
				dropdownEditTextOnHide = false;
				dropdownEditAttributesOnHide = false;
				dropdownCreateEditRuleOnHide = false;

				if (dropdownShowTop) {
					dropdownMenuTop.style.display = "block";
					dropdownMenuTop.style.left = (dropdownX - 1) + "px";
					dropdownMenuTop.style.top = (dropdownY - (height >> 1) - 25) + "px";
				}
				if (dropdownShowLeft) {
					dropdownMenuLeft.style.display = "block";
					dropdownMenuLeft.style.left = (rect.left - 24) + "px";
					dropdownMenuLeft.style.top = (dropdownY - 10) + "px";
				}
				if (dropdownShowRight) {
					dropdownMenuRight.style.display = "block";
					dropdownMenuRight.style.left = (dropdownX + 18) + "px";
					dropdownMenuRight.style.top = (dropdownY - 10) + "px";
				}
				if (dropdownShowBottom) {
					dropdownMenuBottom.style.display = "block";
					dropdownMenuBottom.style.left = (dropdownX - 1) + "px";
					dropdownMenuBottom.style.top = (dropdownY + (height >> 1) + 5) + "px";
				}
				setTimeout(startFadeIn, 50);
			};

			window.dropdownShowType = function (top, changeType) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownActionChangeType = changeType;
				dropdownShowTypeOnHide = true;
				hide();
			};

			window.dropdownCreateText = function (top) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownCreateTextOnHide = true;
				hide();
			};

			window.dropdownEditText = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownEditTextOnHide = true;
				hide();
			};

			window.dropdownCreateComment = function (top) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownCreateCommentOnHide = true;
				hide();
			};

			window.dropdownCreateEditRuleSelector = function (top, editRuleSelector) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownActionEditRuleSelector = editRuleSelector;
				dropdownCreateEditRuleOnHide = true;
				hide();
			};

			window.dropdownMove = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownMoveOnHide = true;
				hide();
			};

			window.dropdownDuplicate = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				function duplicate(element, parent, siblingBelow) {
					var elementType = element.elementType,
						newElement = createElement(elementType.name, parent, siblingBelow, true);

					if (elementType === elementTypeText || elementType === elementTypeComment) {
						setElementText(newElement, getElementText(element));
					} else {
						var i, a, v;
						for (i = elementType.attributes.length - 1; i >= 0; i--) {
							a = elementType.attributes[i].name;
							if ((v = _GA(element.elementIframe, a)))
								_SA(newElement.elementIframe, a, v);
						}
						if (!elementType.noChildren) {
							if (!element.elementContainerVisible)
								toggleVisibility(newElement);
							if ((i = element.elementContainer.childNodes.length)) {
								i--;
								duplicate(element.elementContainer.childNodes[i--], newElement, null);
								while (i >= 0)
									duplicate(element.elementContainer.childNodes[i--], newElement, newElement.elementContainer.childNodes[0]);
							}
						}
					}
				}

				duplicate(dropdownElement, dropdownElement.elementParent, dropdownElement);

				hide();
			};

			window.dropdownFind = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownHighlighting)
					return;

				hide();
				dropdownHighlighting = true;

				var times = 0, interval = 0,
					e = dropdownElement.elementIframe,
					y = e.getBoundingClientRect().top;

				if (y < 0 || y > iframeWindow.innerHeight)
					iframeWindow.scroll({ top: y + iframeWindow.scrollY, behavior: "smooth" });

				loading = true;

				interval = setInterval(function () {
					if (!dropdownHighlighting) {
						if (interval) {
							loading = false;
							e.style.backgroundColor = "";
							e.style.color = "";
							clearInterval(interval);
							interval = 0;
						}
						return;
					}
					times++;
					if ((times & 1)) {
						e.style.backgroundColor = "#000";
						e.style.color = "#fff";
					} else {
						e.style.backgroundColor = "#fff";
						e.style.color = "#000";
					}
					if (times >= 10) {
						loading = false;
						e.style.backgroundColor = "";
						e.style.color = "";
						dropdownHighlighting = false;
						clearInterval(interval);
						interval = 0;
					}
				}, 200);
			};

			window.dropdownToggleVisibility = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				toggleVisibility(dropdownElement);
				hide();
			};

			window.dropdownEditAttributes = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownEditAttributesOnHide = true;
				hide();
			};

			window.dropdownDelete = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				switch (dropdownElement.elementCategory) {
					case categoryElement:
						deleteElement(dropdownElement);
						break;
					case categoryRule:
						deleteRule(dropdownElement);
						break;
				}
				hide();
			};

			function dropdownCreateElement(name) {
				if (dropdownActionChangeType) {
					changeType(name, dropdownElement);
				} else if (dropdownActionClosingTag) {
					if (dropdownActionTop)
						createElement(name, dropdownElement, null);
					else
						createElement(name, dropdownElement.elementParent, dropdownElement.nextSibling);
				} else {
					if (dropdownActionTop)
						createElement(name, dropdownElement.elementParent, dropdownElement);
					else if (dropdownElement.elementType.noChildren)
						createElement(name, dropdownElement.elementParent, dropdownElement.nextSibling);
					else
						createElement(name, dropdownElement, dropdownElement.elementContainer.firstChild);
				}
				hide();
			}

			dropdownTypeInput.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13) {
					var name = trimValue(dropdownTypeInput).toLowerCase();
					if ((name in elementTypesByName) && name !== "text" && dropdownTypeVisible)
						dropdownCreateElement(name);
				}
			};

			_ID("modalAttributesOk").onclick = function () {
				if (loading)
					return;

				var i, a, v, e = dropdownElement.elementIframe,
					elementType = dropdownElement.elementType,
					attributes = elementType.attributes;

				for (i = 0; i < attributes.length; i++) {
					a = attributes[i];
					v = _ID("attributeInput" + a.name).value;
					if (!v)
						_RA(e, a.name);
					else
						_SA(e, a.name, v);
				}

				$("#modalAttributes").modal("hide");
			};

			function attributeInputKeyDown(e) {
				if (e.key === "Enter" || e.keyCode === 13)
					_ID("modalAttributesOk").click();
			};

			function showModalAttributes() {
				var i, j, a, c, row, v, div, input, inputGroup, opt, fileInput,
					e = dropdownElement.elementIframe,
					elementType = dropdownElement.elementType,
					attributes = elementType.attributes,
					modalAttributesBody = _ID("modalAttributesBody");

				while (modalAttributesBody.firstChild)
					_RC(modalAttributesBody, modalAttributesBody.firstChild);

				for (i = 0, c = 3; i < attributes.length; i++) {
					a = attributes[i];

					if (i === htmlAttributes.length) {
						_CE("hr", null, modalAttributesBody);
						c = 0;
						row = _CE("div", "row", modalAttributesBody);
					} else if (c >= 3) {
						c = 0;
						row = _CE("div", "row", modalAttributesBody);
					}
					c++;

					div = _CE("div", "form-group", _CE("div", "col-sm-4", row));
					_TXT(a.name, _SA(_CE("label", null, div), "for", "attributeInput" + a.name));
					v = _GA(e, a.name);
					if (a.values && (typeof a.values === "object")) {
						input = _SA(_CE("select", "form-control", div), "size", "1");
						for (j = 0; j < a.values.length; j++) {
							opt = _SA(_CE("option", null, input), "value", a.values[j]);
							_TXT(a.values[j], opt);
							if (v == a.values[j])
								_SA(opt, "selected", "selected");
						}
					} else {
						if (a.values === valueImage) {
							inputGroup = _CE("div", "input-group", div);
							input = _SA(_SA(_SA(_CE("input", "form-control", inputGroup), "spellcheck", "false"), "type", "text"), "autocomplete", "off");
							fileInput = _SA(_SA(_SA(_CE("input", "editor-hidden-file-input", inputGroup), "tabindex", "-1"), "type", "file"), "accept", "image/png,image/gif,image/jpeg");
							fileInput.input = input;
							fileInput.onchange = function () {
								var file, input = this.input;
								if (loading)
									return;
								if (!("files" in this)) {
									Notification.error(translate("ErrorNoFile"), true);
									return;
								}
								if (!this.files.length || !(file = this.files[0]))
									return;
								if (file.size > (1 << 20)) {
									Notification.error(translate("ErrorFileTooLarge"), true);
									return;
								}
								loadFileDataURL(file, function (dataURL) {
									input.value = dataURL || "";
								});
							};
							_BTN("btn btn-default btn-force-border", "fa-folder-open", translate("LoadImage"), _CE("span", "input-group-btn", inputGroup), function () {
								if (loading)
									return;
								this.fileInput.click();
							}).fileInput = fileInput;
						} else {
							input = _SA(_SA(_SA(_CE("input", "form-control", div), "spellcheck", "false"), "type", a.values === valueNumber ? "number" : "text"), "autocomplete", "off");
						}
						input.onkeydown = attributeInputKeyDown;
						input.value = v;
					}
					_SA(input, "id", "attributeInput" + a.name);
				}

				$("#modalAttributes").modal({
					keyboard: true,
					backdrop: true
				});
			}

			// Initial
			(function () {
				var i, a, floatingHelp;

				function aClick(e) {
					if (e.target.tagName !== "A")
						return cancelEvent(e);
					if (e.button)
						return;
					dropdownCreateElement(this.elementType.name);
					return cancelEvent(e);
				}

				function helpClick(e) {
					window.open(this.parentNode.elementType.urlHelp);
					return cancelEvent(e);
				}

				for (i = 0; i < elementTypes.length; i++) {
					a = _CE("a", null, dropdownTypeContainer);
					_SA(a, "href", "#");
					a.onclick = aClick;
					a.elementType = elementTypes[i];
					_TXT(elementTypes[i].name + " ", a);
					floatingHelp = _CE("i", "fa fa-nomargin fa-question-circle fa-floating-help", a);
					_SA(floatingHelp, "title", translate("ElementHelp"));
					floatingHelp.onclick = helpClick;
				}
			})();
		})();

		// Actions Menu
		(function () {
			var editorActionFileLoad = _ID("editorActionFileLoad"),
				modalSaveFileName = _ID("modalSaveFileName"),
				modalSaveOk = _ID("modalSaveOk");

			$("#modalSave").on("shown.bs.modal", function () {
				modalSaveFileName.focus();
			});

			modalSaveFileName.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalSaveOk.click();
			};

			function loadFileFromInput() {
				if (loading)
					return;

				if (!("files" in editorActionFileLoad)) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (!editorActionFileLoad.files.length || !editorActionFileLoad.files[0])
					return;

				loadFileDataURL(editorActionFileLoad.files[0], function (dataURL) {
					var parent = editorActionFileLoad.parentNode;
					editorActionFileLoad = _SA(_SA(_SA(_CE("input", null, _RC(parent, editorActionFileLoad)), "type", "file"), "tabindex", "-1"), "accept", "text/html");
					editorActionFileLoad.onchange = loadFileFromInput;

					if (!dataURL)
						return;

					if (dataURL.indexOf("data:text/html;base64,")) {
						Notification.error(translate("ErrorInvalidHTML"), true);
						return;
					}

					loading = true;
					Notification.wait();

					try {
						var xhr = new XMLHttpRequest(), done = false;
						xhr.responseType = "document";
						xhr.onreadystatechange = function () {
							if (xhr.readyState === 4) {
								if (done)
									return;
								done = true;

								loading = false;
								Notification.hide();

								try {
									loadDocument(xhr.responseXML);
								} catch (ex) {
									Notification.error(translate("ErrorFileLoad"), true);
								}
							}
						};
						xhr.onerror = function () {
							loading = false;
							Notification.error(translate("ErrorFileLoad"), true);
						};
						xhr.open("get", dataURL);
						xhr.send();
					} catch (ex) {
						loading = false;
						Notification.error(translate("ErrorFileLoad"), true);
					}
				});
			}

			function newDocument() {
				if (!bodyElement)
					return;

				while (bodyElement.elementContainer.firstChild)
					deleteElement(bodyElement.elementContainer.firstChild);
			}

			function loadDocument(doc) {
				if (!doc || !doc.body || !doc.head)
					return;

				newDocument();

				function createElementsFromDoc(srcParent, dstParent) {
					var i, j, tag, srcElement, dstElement, emptyText, elementIframe, elementType, attributes, a, v;
					for (i = 0; i < srcParent.childNodes.length; i++) {
						srcElement = srcParent.childNodes[i];
						if (!srcElement.tagName) {
							if (srcElement.nodeType === 3) {
								emptyText = !srcElement.nodeValue;
								if (i === srcParent.childNodes.length - 1 && dstParent === bodyElement && !emptyText && !trim(srcElement.nodeValue))
									continue;
								dstElement = createElement("text", dstParent, null, true);
								if (!emptyText)
									setElementText(dstElement, srcElement.nodeValue);
							} else if (srcElement.nodeType === 8) {
								v = srcElement.nodeValue;
								if (v.length >= 2 && v.charAt(0) === "\r" && v.charAt(1) == "\n")
									v = v.substr(2);
								else if (v.length && v.charAt(0) === "\n")
									v = v.substr(1);
								if (v.length >= 2 && v.charAt(v.length - 2) === "\r" && v.charAt(v.length - 1) == "\n")
									v = v.substr(0, v.length - 2);
								else if (v.length && v.charAt(v.length - 1) === "\n")
									v = v.substr(0, v.length - 1);
								setElementText(createElement("comment", dstParent, null, true), v);
							}
						} else if (((tag = srcElement.tagName.toLowerCase()) in elementTypesByName)) {
							dstElement = createElement(tag, dstParent, null, true);

							elementIframe = dstElement.elementIframe;
							elementType = dstElement.elementType;
							// Make sure to load only supported attributes
							attributes = elementType.attributes;
							for (j = 0; j < attributes.length; j++) {
								a = attributes[j].name;
								v = _GA(srcElement, a);
								if (v)
									_SA(elementIframe, a, v);
							}

							createElementsFromDoc(srcElement, dstElement);
						}
					}
				}

				createElementsFromDoc(doc.body, bodyElement);
			}

			editorActionFileLoad.onchange = loadFileFromInput;

			_ID("editorActionNew").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				newDocument();

				return cancelEvent(e);
			};

			_ID("editorActionLoad").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				editorActionFileLoad.click();

				return cancelEvent(e);
			};

			_ID("editorActionSave").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				$("#modalSave").modal({
					keyboard: true,
					backdrop: true
				});

				return cancelEvent(e);
			};

			modalSaveOk.onclick = function () {
				var fileName = trim(modalSaveFileName.value);
				if (!fileName)
					return;

				if (!BlobDownloader.supported) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (fileName.toLowerCase().indexOf(".htm") < 0)
					fileName += ".html";

				$("#modalSave").modal("hide");

				BlobDownloader.download(fileName, new Blob([
					new Uint8Array([0xEF, 0xBB, 0xBF]), // UTF-8 BOM
					'<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">\n<head>\n	<meta charset="utf-8" />\n	<meta name="viewport" content="width=device-width, initial-scale=1" />\n	<title>HTML</title>\n	<style type="text/css" id="style">',
					trim(iframeStyle.textContent),
					"	</style>\n</head>\n<body>",
					trim(iframeBody.innerHTML),
					"</body>\n</html>\n"
				], { type: "text/html;charset=utf-8" }));
			};

		})();
	</script>
</body>
</html>
