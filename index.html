<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br" dir="ltr">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=1024, initial-scale=1" />

	<meta property="og:locale" content="pt_BR" />
	<meta property="og:type" content="website" />
	<meta property="og:url" content="https://tech-espm.github.io/labs-editor/" />
	<meta property="og:title" content="Editor" />
	<meta property="og:site_name" content="Editor" />
	<meta property="og:description" content="Editor HTML + CSS para uso em sala de aula." />
	<!--
	<meta property="og:image" content="fb.jpg" />
	<meta property="og:image:type" content="image/jpeg">
	<meta property="og:image:width" content="768">
	<meta property="og:image:height" content="768">
	-->

	<meta name="author" content="ESPM TECH" />
	<meta name="description" content="Editor HTML + CSS para uso em sala de aula." />
	<meta name="keywords" content="html, css, editor, wysiwyg" />

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="apple-mobile-web-app-title" content="Editor" />
	<!--
		https://w3c.github.io/manifest/#icon-masks
		https://github.com/w3c/manifest/issues/555
	-->
	<link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-icon-57x57.png" />
	<link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-icon-60x60.png" />
	<link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-icon-72x72.png" />
	<link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-icon-76x76.png" />
	<link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-icon-114x114.png" />
	<link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-icon-120x120.png" />
	<link rel="apple-touch-icon" sizes="144x144" href="favicons/apple-icon-144x144.png" />
	<link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-icon-152x152.png" />
	<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-icon-180x180.png" />
	<link rel="icon" type="image/png" sizes="512x512" href="favicons/favicon-512x512.png" />
	<link rel="icon" type="image/png" sizes="192x192" href="favicons/favicon-192x192.png" />
	<link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96x96.png" />
	<link rel="icon" type="image/png" sizes="48x48" href="favicons/favicon-48x48.png" />
	<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png" />
	<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png" />
	<link rel="Shortcut Icon" href="favicon.ico" />
	<link rel="Shortcut Icon" href="favicon.png" />
	<link rel="manifest" href="manifest.json" />
	<meta name="msapplication-config" content="browserconfig.xml" />
	<meta name="theme-color" content="#222222" />

	<title>Editor</title>

	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600|Roboto+Mono:400,700" />
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap-1.0.22.min.css" />
	<link rel="stylesheet" href="lib/font-awesome/css/font-awesome-1.0.2.min.css" />
	<link rel="stylesheet" href="css/style.css?v=1.0.0" />
</head>
<body style="visibility: hidden">

	<div class="modal fade" tabindex="-1" role="dialog" id="modalTxt">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditText"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="modalTxtInput" data-string="text|Text"></label>
						<textarea class="form-control" id="modalTxtInput" spellcheck="true" autocomplete="off" rows="5"></textarea>
					</div>
					<div class="form-group no-margin-bottom">
						<button type="button" class="btn btn-outline btn-primary" id="modalTxtBtnLoremIpsum" data-string="text|UseLoremIpsum"></button>
						<select size="1" class="form-control" id="modalTxtSelectLoremIpsum" style="display: inline-block; width: auto;"></select>
					</div>
					<hr />
					<div class="form-group no-margin-bottom">
						<label data-string="text|MoreHelpLinks"></label>
						<div>
							<a target="_blank" href="https://dev.w3.org/html5/html-author/charref" class="btn btn-outline btn-primary" data-string="text|HTMLEntities"><i class="fa fa-margin fa-external-link"></i></a>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalTxtOk" data-string="text|OK"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalAttributes">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditAttributes"></h4>
				</div>
				<div class="modal-body" id="modalAttributesBody"></div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalAttributesOk" data-string="text|OK"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalSave">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|Save"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group no-margin-bottom">
						<label for="modalSaveFileName" data-string="text|FileName"></label>
						<input type="text" class="form-control" id="modalSaveFileName" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalSaveOk" data-string="text|Save"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalRuleSelector">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditSelector"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group no-margin-bottom">
						<label for="modalRuleSelectorInput" data-string="text|Selector"></label>
						<input type="text" class="form-control" id="modalRuleSelectorInput" spellcheck="false" autocomplete="off" />
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalRuleSelectorOk" data-string="text|OK"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalRuleAttribute">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|EditAttribute"></h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="modalRuleAttributeName" data-string="text|Name"></label>
						<a target="_blank" href="#" class="btn btn-xs btn-outline btn-primary" id="modalRuleAttributeHelp" data-string="text|AttributeHelp"><i class="fa fa-margin fa-question-circle"></i></a>
						<select size="1" class="form-control" id="modalRuleAttributeName"></select>
					</div>
					<div class="form-group">
						<label id="modalRuleAttributeValueLabel" for="modalRuleAttributeValueInput" data-string="text|Value"></label>
						<input type="text" class="form-control" id="modalRuleAttributeValueInput" spellcheck="false" autocomplete="off" style="display: none" />
						<select size="1" class="form-control" id="modalRuleAttributeValueSelect" style="display: none"></select>
					</div>
					<hr />
					<div class="form-group no-margin-bottom">
						<label data-string="text|MoreHelpLinks"></label>
						<div>
							<a target="_blank" href="https://color.adobe.com/create/color-wheel/" class="btn btn-outline btn-primary"><i class="fa fa-margin fa-external-link"></i>Adobe Color</a>
							<br />
							<a target="_blank" href="https://htmlcolorcodes.com/color-names/" class="btn btn-outline btn-primary"><i class="fa fa-margin fa-external-link"></i>HTML Color Codes</a>
							<br />
							<a target="_blank" href="https://developer.mozilla.org/en-US/docs/Web/CSS/url" class="btn btn-outline btn-primary"><i class="fa fa-margin fa-external-link"></i>CSS URL</a>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalRuleAttributeOk" data-string="text|OK"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" tabindex="-1" role="dialog" id="modalGoogleFonts">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" data-string="aria-label|Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" data-string="text|GoogleFonts"></h4>
				</div>
				<div class="modal-body no-margin-bottom">
					<div class="form-group">
						<label for="modalGoogleFontsLink"><span data-string="text|HTMLLink"></span> <i><small data-string="text|GoogleFontsExample"></small></i></label>
						<input type="text" class="form-control" id="modalGoogleFontsLink" spellcheck="false" autocomplete="off" />
					</div>
					<hr />
					<div class="form-group no-margin-bottom">
						<a target="_blank" href="https://fonts.google.com" class="btn btn-outline btn-primary" data-string="text|GoogleFonts"><i class="fa fa-margin fa-external-link"></i></a>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline btn-default" data-dismiss="modal" data-string="text|Cancel"><i class="fa fa-margin fa-times"></i></button>
					<button type="button" class="btn btn-primary" id="modalGoogleFontsOk" data-string="text|OK"><i class="fa fa-margin fa-check"></i></button>
				</div>
			</div>
		</div>
	</div>

	<div class="editor-container" id="editorContainer">
		<ul class="nav nav-tabs" role="tablist">
			<li role="presentation" class="active"><a id="tabEditor" href="#editor" aria-controls="editor" role="tab" data-toggle="tab">HTML</a></li>
			<li role="presentation"><a id="tabEditorCss" href="#editorCss" aria-controls="editorCss" role="tab" data-toggle="tab">CSS</a></li>
		</ul>
		<a class="nav-tabs-logo" href="https://github.com/tech-espm/labs-editor" target="_blank"><img width="75" src="images/logo.png" style="border: none;" /></a>
		<div class="nav-tabs-menu">
			<button type="button" id="editorMenuDropdown" class="btn btn-primary btn-outline dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<span class="fa fa-bars" data-string="aria-label|Menu"></span>
			</button>
			<ul class="dropdown-menu dropdown-menu-right">
				<li><a href="#" data-string="text|New" id="editorActionNew"><i class="fa fa-margin fa-file-o"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|LoadEllipsis" id="editorActionLoad"><i class="fa fa-margin fa-folder-open-o"></i></a></li>
				<li><a href="#" data-string="text|SaveEllipsis" id="editorActionSave"><i class="fa fa-margin fa-cloud-download"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|LoadExample" id="editorActionLoadExample"><i class="fa fa-margin fa-lightbulb-o"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" data-string="text|GoogleFontsEllipsis" id="editorActionGoogleFonts"><i class="fa fa-margin fa-google"></i></a></li>
				<li><a href="#" id="editorActionToggleBootstrap"><i class="fa fa-margin fa-paint-brush"></i><span data-string="text|AddBootstrap" id="editorActionToggleBootstrapLabel"></span></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="html/" data-string="text|AdvancedMode"><i class="fa fa-margin fa-edit"></i></a></li>
				<li id="editorActionInstallSeparator" role="separator" class="divider" style="display: none;"></li>
				<li id="editorActionInstallItem" style="display: none;"><a href="#" id="editorActionInstall" data-string="text|Install"><i class="fa fa-margin fa-download"></i></a></li>
				<li role="separator" class="divider"></li>
				<li><a href="#" id="editorActionToggleDecoration"><i class="fa fa-margin fa-code"></i><span id="editorActionToggleDecorationLabel" data-string="text|HideDecoration"></span></a></li>
			</ul>
			<div class="nav-tabs-file-load"><input id="editorActionFileLoad" tabindex="-1" type="file" accept="text/html" /></div>
		</div>
		<div class="tab-content">
			<div id="toolbar" class="editor-toolbar">
				<div id="toolbarButtons" class="fade in">
					<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateElement" onclick="toolbarShowType()" id="editorToolbarCreateElement"><i class="fa fa-nomargin fa-code"></i></button>
					<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateText" onclick="toolbarCreateText()" id="editorToolbarCreateText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
					<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateComment" onclick="toolbarCreateComment()" id="editorToolbarCreateComment"><i class="fa fa-nomargin fa-comment"></i></button>
				</div>
				<div id="toolbarButtonsCss" class="fade hidden">
					<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateRule" onclick="toolbarCreateRule()" id="editorToolbarCreateRule"><i class="fa fa-nomargin fa-object-group"></i></button>
					<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateAttribute" onclick="toolbarCreateAttribute()" id="editorToolbarCreateAttribute"><i class="fa fa-nomargin fa-paint-brush"></i></button>
				</div>
			</div>
			<div id="editor" role="tabpanel" class="tab-pane fade in active editor">
				<div class="element">
					<div class="element-decoration" id="editor-decoration-top">
						<div class="element-tag element-text">&lt;!DOCTYPE html&gt;</div>
						<div class="element-tag no-click">&lt;<span class="element-name-block">html</span>&gt;</div>
						<div class="element-tag no-click">&lt;<span class="element-name-block">head</span>&gt;</div>
						<div class="element-container">
							<div class="element-tag no-click">&lt;<span class="element-name-block">meta</span> <span class="attribute-name">charset</span>=<span class="attribute-value">"utf-8"</span> /&gt;</div>
							<div class="element-tag no-click">&lt;<span class="element-name-block">meta</span> <span class="attribute-name">name</span>=<span class="attribute-value">"viewport"</span> <span class="attribute-name">content</span>=<span class="attribute-value">"width=device-width, initial-scale=1"</span> /&gt;</div>
							<div><span class="element-tag no-click">&lt;<span class="element-name-block">title</span>&gt;</span><span class="element-tag element-text" data-string="text|PageTitle"></span><span class="element-tag no-click">&lt;/<span class="element-name-block">title</span>&gt;</span></div>
							<div><span class="element-tag no-click">&lt;<span class="element-name-block">style</span> <span class="attribute-name">type</span>=<span class="attribute-value">"text/css"</span>&gt;</span><span class="element-tag element-text" data-string="text|CSSTab"></span><span class="element-tag no-click">&lt;/<span class="element-name-block">style</span>&gt;</span></div>
						</div>
						<div class="element-tag no-click">&lt;/<span class="element-name-block">head</span>&gt;</div>
					</div>
					<div id="editor-container"></div>
					<div class="element-decoration" id="editor-decoration-bottom">
						<div class="element-tag no-click">&lt;/<span class="element-name-block">html</span>&gt;</div>
					</div>
				</div>
			</div>
			<div id="editorCss" role="tabpanel" class="tab-pane fade editor editor-css"></div>
		</div>
	</div>
	<div class="editor-bar" id="bar"></div>
	<iframe class="editor-iframe" id="iframe" frameborder="0"></iframe>
	<ul class="dropdown-menu editor-menu-animated" id="dropdownType">
		<li class="dropdown-menu-input-container">
			<div class="input-group">
				<input id="dropdownTypeInput" spellcheck="false" autocomplete="off" class="dropdown-menu-input form-control input-sm" data-string="placeholder|ElementName" />
				<span class="input-group-btn">
					<button id="dropdownTypeButton" class="btn btn-default btn-force-border btn-sm" type="button" data-string="text|Create"></button>
				</span>
			</div>
		</li>
		<li class="divider"></li>
		<li class="dropdown-menu-container" id="dropdownTypeContainer"></li>
	</ul>
	<div class="editor-menu editor-menu-animated editor-menu-top" id="dropdownMenuTop">
		<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateElement" onclick="dropdownShowType(true, false)" id="dropdownMenuTopCreateElement"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateRule" onclick="dropdownCreateEditRuleSelector(true, false)" id="dropdownMenuTopCreateRule"><i class="fa fa-nomargin fa-object-group"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateAttribute" onclick="dropdownCreateEditRuleAttribute(true, false)" id="dropdownMenuTopCreateRuleAttribute"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateText" onclick="dropdownCreateText(true)" id="dropdownMenuTopCreateText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateComment" onclick="dropdownCreateComment(true)" id="dropdownMenuTopCreateComment"><i class="fa fa-nomargin fa-comment"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-left" id="dropdownMenuLeft">
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" onclick="dropdownToggleVisibility()" id="dropdownMenuLeftToggleVisibility"><i class="fa fa-nomargin fa-plus"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-right" id="dropdownMenuRight">
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|Move" onclick="dropdownMove()"><i class="fa fa-nomargin fa-arrows"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|Duplicate" onclick="dropdownDuplicate()"><i class="fa fa-nomargin fa-copy"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|EditText" onclick="dropdownEditText()" id="dropdownMenuRightEditText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|FindElement" onclick="dropdownFind()" id="dropdownMenuRightFind"><i class="fa fa-nomargin fa-search"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|ChangeElement" onclick="dropdownShowType(true, true)" id="dropdownMenuRightChangeType"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|EditSelector" onclick="dropdownCreateEditRuleSelector(true, true)" id="dropdownMenuRightEditRuleSelector"><i class="fa fa-nomargin fa-object-group"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-default" type="button" data-string="title|EditAttribute" onclick="dropdownCreateEditRuleAttribute(true, true)" id="dropdownMenuRightEditRuleAttribute"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|EditAttributes" onclick="dropdownEditAttributes()" id="dropdownMenuRightEditAttributes"><i class="fa fa-nomargin fa-wrench"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-danger" type="button" data-string="title|Delete" onclick="dropdownDelete()"><i class="fa fa-nomargin fa-times"></i></button>
	</div>
	<div class="editor-menu editor-menu-animated editor-menu-bottom" id="dropdownMenuBottom">
		<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateElement" onclick="dropdownShowType(false, false)" id="dropdownMenuBottomCreateElement"><i class="fa fa-nomargin fa-code"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-success" type="button" data-string="title|CreateRule" onclick="dropdownCreateEditRuleSelector(false, false)" id="dropdownMenuBottomCreateRule"><i class="fa fa-nomargin fa-object-group"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateAttribute" onclick="dropdownCreateEditRuleAttribute(false, false)" id="dropdownMenuBottomCreateRuleAttribute"><i class="fa fa-nomargin fa-paint-brush"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateText" onclick="dropdownCreateText(false)" id="dropdownMenuBottomCreateText"><i class="fa fa-nomargin fa-i-cursor"></i></button>
		<button class="btn btn-outline btn-xs btn-fa btn-primary" type="button" data-string="title|CreateComment" onclick="dropdownCreateComment(false)" id="dropdownMenuBottomCreateComment"><i class="fa fa-nomargin fa-comment"></i></button>
	</div>

	<script type="text/javascript" src="lib/jquery/jquery-1.0.0.min.js"></script>
	<script type="text/javascript" src="lib/bootstrap/js/bootstrap-1.0.0.min.js"></script>
	<script type="text/javascript" src="js/main.js?v=1.0.0"></script>

	<script type="text/javascript">
		"use strict";

		var loading = true,
			dirty = false,
			valueFreeText = null,
			valueColor = 0,
			valueNumber = 1,
			valueImage = 2,
			categoryElement = 0,
			categoryRule = 1,
			categoryRuleAttribute = 2,
			htmlAttributes = [
				{ name: "class", values: valueFreeText, common: true },
				{ name: "id", values: valueFreeText, common: true },
				{ name: "title", values: valueFreeText, common: true },
			],
			htmlAttributeClass = htmlAttributes[0],
			elementTypes = [
				{ name: "hr", block: true, noChildren: true, attributes: null },
				{ name: "br", noChildren: true, attributes: null },
				{ name: "img", noChildren: true, attributes: [{ name: "src", values: valueImage }, { name: "alt", values: valueFreeText }, { name: "width", values: valueNumber }, { name: "height", values: valueNumber }] },
				{ name: "a", attributes: [{ name: "href", values: valueFreeText }, { name: "target", values: ["_blank"] }] },
				{ name: "button", attributes: [{ name: "type", values: valueFreeText }, { name: "disabled", values: ["", "disabled"] }] },
				{ name: "input", noChildren: true, attributes: [{ name: "type", values: ["", "button", "checkbox", "color", "date", "datetime-local", "email", "file", "hidden", "month", "number", "password", "radio", "range", "reset", "search", "submit", "tel", "text", "time", "url", "week"] }, { name: "autocomplete", values: ["", "on", "off"] }, { name: "spellcheck", values: ["", "true", "false"] }, { name: "readonly", values: ["", "readonly"] }, { name: "disabled", values: ["", "disabled"] }, { name: "name", values: valueFreeText }, { name: "value", values: valueFreeText }, { name: "min", values: valueNumber }, { name: "max", values: valueNumber }, { name: "maxlength", values: valueNumber }, { name: "checked", values: ["", "checked"] }, { name: "size", values: valueNumber }, { name: "placeholder", values: valueFreeText }] },
				{ name: "select", attributes: [{ name: "size", values: valueNumber }] },
				// option and optgroup must not be block, otherwise they cannot be inserted into select elements
				{ name: "option", attributes: [{ name: "value", values: valueFreeText }, { name: "selected", values: ["", "selected"] }] },
				{ name: "optgroup", attributes: [{ name: "label", values: valueFreeText }] },
				{ name: "label", attributes: [{ name: "for", values: valueFreeText }] },
				{ name: "p", block: true, attributes: null },
				{ name: "b", attributes: null },
				{ name: "strong", attributes: null },
				{ name: "small", attributes: null },
				{ name: "i", attributes: null },
				{ name: "em", attributes: null },
				{ name: "cite", attributes: null },
				{ name: "s", attributes: null },
				{ name: "u", attributes: null },
				{ name: "blockquote", block: true, attributes: null },
				{ name: "dl", block: true, attributes: null },
				{ name: "dt", block: true, attributes: null },
				{ name: "dd", block: true, attributes: null },
				{ name: "q", attributes: null },
				{ name: "del", attributes: null },
				{ name: "ins", attributes: null },
				{ name: "span", attributes: null },
				{ name: "div", block: true, attributes: null },
				{ name: "iframe", block: true, attributes: [{ name: "allow", values: valueFreeText }, { name: "allowfullscreen", values: ["", "allowfullscreen"] }, { name: "frameborder", values: valueNumber }, { name: "width", values: valueNumber }, { name: "height", values: valueNumber }, { name: "src", values: valueFreeText }] },
				{ name: "section", block: true, attributes: null },
				{ name: "nav", block: true, attributes: null },
				{ name: "header", block: true, attributes: null },
				{ name: "footer", block: true, attributes: null },
				{ name: "main", block: true, attributes: null },
				{ name: "article", block: true, attributes: null },
				{ name: "aside", block: true, attributes: null },
				{ name: "ul", block: true, attributes: null },
				{ name: "ol", block: true, attributes: [{ name: "reversed", values: ["", "reversed"] }, { name: "start", values: valueNumber }, { name: "type", values: ["", "1", "a", "A", "i", "I"] }] },
				{ name: "li", block: true, attributes: null },
				{ name: "figure", block: true, attributes: null },
				{ name: "h1", block: true, attributes: null },
				{ name: "h2", block: true, attributes: null },
				{ name: "h3", block: true, attributes: null },
				{ name: "h4", block: true, attributes: null },
				{ name: "h5", block: true, attributes: null },
				{ name: "h6", block: true, attributes: null },
				{ name: "table", block: true, attributes: null },
				{ name: "thead", block: true, attributes: null },
				{ name: "tbody", block: true, attributes: null },
				{ name: "tfoot", block: true, attributes: null },
				{ name: "tr", block: true, attributes: null },
				{ name: "th", block: true, attributes: [{ name: "colspan", values: valueNumber }, { name: "rowspan", values: valueNumber }] },
				{ name: "td", block: true, attributes: [{ name: "colspan", values: valueNumber }, { name: "rowspan", values: valueNumber }] },
				{ name: "colgroup", block: true, attributes: [{ name: "span", values: valueNumber }] },
				{ name: "col", block: true, attributes: [{ name: "span", values: valueNumber }] },
			],
			elementTypesByName = {},
			elementTypeBody = null,
			elementTypeText = null,
			elementTypeComment = null,
			cssAttributes = [
				{ name: "margin", values: valueFreeText },
				{ name: "margin-top", values: valueFreeText },
				{ name: "margin-right", values: valueFreeText },
				{ name: "margin-bottom", values: valueFreeText },
				{ name: "margin-left", values: valueFreeText },
				{ name: "padding", values: valueFreeText },
				{ name: "padding-top", values: valueFreeText },
				{ name: "padding-right", values: valueFreeText },
				{ name: "padding-bottom", values: valueFreeText },
				{ name: "padding-left", values: valueFreeText },
				{ name: "border", values: valueFreeText },
				{ name: "border-top", values: valueFreeText },
				{ name: "border-right", values: valueFreeText },
				{ name: "border-bottom", values: valueFreeText },
				{ name: "border-left", values: valueFreeText },
				{ name: "border-color", values: valueColor },
				{ name: "border-width", values: valueFreeText },
				{ name: "border-style", values: ["none", "hidden", "dashed", "dotted", "double", "groove", "inset", "outset", "ridge", "solid"] },
				{ name: "border-collapse", values: ["collapse", "separate"] },
				{ name: "border-radius", values: valueFreeText },
				{ name: "border-top-left-radius", values: valueFreeText },
				{ name: "border-top-right-radius", values: valueFreeText },
				{ name: "border-bottom-left-radius", values: valueFreeText },
				{ name: "border-bottom-right-radius", values: valueFreeText },
				{ name: "background", values: valueFreeText },
				{ name: "background-color", values: valueColor },
				{ name: "background-image", values: valueImage },
				{ name: "background-attachment", values: ["fixed", "scroll"] },
				{ name: "background-size", values: valueFreeText },
				{ name: "background-position", values: valueFreeText },
				{ name: "background-repeat", values: ["no-repeat", "repeat", "repeat-x", "repeat-y"] },
				{ name: "width", values: valueFreeText },
				{ name: "height", values: valueFreeText },
				{ name: "min-width", values: valueFreeText },
				{ name: "min-height", values: valueFreeText },
				{ name: "max-width", values: valueFreeText },
				{ name: "max-height", values: valueFreeText },
				{ name: "z-index", values: valueFreeText },
				{ name: "box-shadow", values: valueFreeText },
				{ name: "box-sizing", values: ["border-box", "content-box"] },
				{ name: "color", values: valueColor },
				{ name: "opacity", values: valueFreeText },
				{ name: "line-height", values: valueFreeText },
				{ name: "list-style-type", values: ["none", "disc", "circle", "square", "decimal", "decimal-leading-zero", "lower-roman", "upper-roman", "lower-alpha", "upper-alpha", "lower-greek", "upper-greek"] },
				{ name: "font", values: valueFreeText },
				{ name: "font-family", values: valueFreeText },
				{ name: "font-size", values: valueFreeText },
				{ name: "font-style", values: ["normal", "italic"] },
				{ name: "font-weight", values: ["normal", "bold", "100", "200", "300", "400", "500", "600", "700", "800", "900"] },
				{ name: "cursor", values: ["auto", "crosshair", "default", "pointer", "move", "e-resize", "ne-resize", "nw-resize", "n-resize", "se-resize", "sw-resize", "s-resize", "w-resize", "text", "wait", "help", "progress", "copy", "alias", "context-menu", "cell", "not-allowed", "col-resize", "row-resize", "no-drop", "vertical-text", "all-scroll", "nesw-resize", "nwse-resize", "ns-resize", "ew-resize"] },
				{ name: "top", values: valueFreeText },
				{ name: "right", values: valueFreeText },
				{ name: "bottom", values: valueFreeText },
				{ name: "left", values: valueFreeText },
				{ name: "display", values: ["none", "block", "inline", "inline-block"] },
				{ name: "position", values: ["static", "relative", "absolute", "fixed"] },
				{ name: "float", values: ["left", "right"] },
				{ name: "resize", values: ["none", "both", "horizontal", "vertical"] },
				{ name: "text-align", values: ["left", "right", "center", "justify"] },
				{ name: "text-shadow", values: valueFreeText },
				{ name: "overflow", values: ["auto", "hidden", "visible", "scroll"] },
				{ name: "text-overflow", values: ["clip", "ellipsis"] },
				{ name: "text-decoration", values: valueFreeText },
				{ name: "text-decoration-line", values: ["none", "underline", "overline", "line-through", "blink"] },
				{ name: "text-decoration-color", values: valueColor },
				{ name: "text-decoration-style", values: ["solid", "double", "dotted", "dashed", "wavy"] },
				{ name: "vertical-align", values: ["baseline", "sub", "super", "text-top", "text-bottom", "middle", "top", "bottom"] },
				{ name: "visibility", values: ["visible", "hidden"] },
				{ name: "white-space", values: ["normal", "nowrap", "pre", "pre-wrap", "pre-line", "break-spaces"] },
			],
			cssAttributesByName = {},
			editorContainer = _ID("editorContainer"),
			editorNeedsResize = false,
			editor = _ID("editor"),
			editorBootstrapEnabled = false,
			editorDecorationVisible = true,
			editorDecorationTop = _ID("editor-decoration-top"),
			editorDecorationBottom = _ID("editor-decoration-bottom"),
			editorCss = _ID("editorCss"),
			tabEditor = _ID("tabEditor"),
			tabEditorCss = _ID("tabEditorCss"),
			toolbar = _ID("toolbar"),
			toolbarButtons = _ID("toolbarButtons"),
			toolbarButtonsCss = _ID("toolbarButtonsCss"),
			loremIpsum = [
				"Lorem ipsum dolor sit amet, consectetur adipiscing elit.\nSuspendisse erat nulla, mattis et maximus in, molestie at felis.\nVestibulum ac eros vel est commodo egestas.\nFusce blandit, purus sit amet aliquam tincidunt, nisl mauris euismod nisi, euismod pulvinar dolor metus sit amet orci.\nPraesent lectus magna, porta a volutpat ac, egestas a dui.\nQuisque semper, ex eget pretium faucibus, ante ipsum dictum nisl, sed iaculis ante nisi vehicula arcu.\nPraesent at feugiat dolor, placerat auctor ligula.\nCras venenatis viverra nisi eu volutpat.",
				"Morbi sed tortor ac lectus porta vehicula.\nNullam venenatis magna in accumsan sodales.\nDonec massa orci, egestas vel tincidunt eu, laoreet et enim.\nCurabitur fermentum tempor felis, ac condimentum urna dictum sed.\nMaecenas at purus finibus, pellentesque sem at, scelerisque lorem.\nNam pretium vitae lorem ac volutpat.\nInteger ligula turpis, lobortis quis congue ut, suscipit semper velit.\nInteger scelerisque quis lacus eu imperdiet.\nInteger ex tortor, finibus nec ultrices quis, pretium vel elit.\nPhasellus tincidunt hendrerit purus, in cursus erat euismod vitae.",
				"In laoreet iaculis nibh, ut varius massa consectetur sit amet.\nPellentesque auctor purus id sem posuere porta.\nPraesent vitae massa mi.\nDonec eget tellus egestas, aliquet justo vitae, vulputate lacus.\nPraesent eu tempor eros.\nProin risus tellus, accumsan quis magna eget, viverra rutrum nunc.\nNullam id placerat nisl, vel tempor augue.\nPhasellus dignissim dapibus dui a sollicitudin.\nNam vulputate accumsan suscipit.\nUt rhoncus risus a volutpat porta.\nPraesent eros ipsum, molestie eget dictum nec, malesuada vitae lectus.\nAliquam pretium fermentum arcu, ultricies varius magna lobortis sit amet.\nAenean tristique nisl sit amet turpis fringilla suscipit.\nMaecenas tincidunt, orci eget tincidunt suscipit, lectus nibh condimentum odio, non fermentum purus libero sagittis nibh.\nNulla finibus, nulla ut gravida gravida, massa ipsum auctor lectus, et aliquam ligula sapien id felis.",
				"Donec quis iaculis lorem.\nVestibulum sollicitudin felis massa, et commodo neque sagittis sed.\nPhasellus et laoreet ligula, id lacinia orci.\nSuspendisse luctus eget odio et fringilla.\nPhasellus vel velit at ligula ullamcorper sollicitudin.\nUt efficitur varius diam, fringilla accumsan nisi mattis vitae.\nCras dapibus nec augue posuere rhoncus.\nMauris dolor felis, malesuada et risus eu, tempus rhoncus libero.\nQuisque iaculis volutpat nunc, lacinia aliquet libero viverra in.\nEtiam sit amet lectus ut ante gravida malesuada sed a massa.\nNulla a blandit lacus.\nUt eleifend convallis libero a posuere.\nFusce a tempus urna, eu molestie enim.",
				"Cras fringilla, leo eu dignissim placerat, ligula lacus efficitur enim, eu congue arcu ante eu odio.\nDonec egestas bibendum est.\nEtiam non dolor pharetra, scelerisque tortor a, pulvinar diam.\nSuspendisse euismod elit lacus, ac gravida ligula malesuada nec.\nEtiam fringilla nisl odio, et luctus lorem posuere at.\nNam justo enim, blandit ac lorem vitae, vestibulum scelerisque leo.\nPellentesque molestie mattis neque non imperdiet.\nNulla commodo orci risus, id molestie ex efficitur non.\nSed quis elit non ante aliquet pharetra.\nMorbi lacinia mi metus, gravida accumsan ante cursus et.\nMorbi sed ipsum augue.",
				"Curabitur vel turpis maximus, rhoncus metus at, fringilla massa.\nNunc bibendum eros eget nunc scelerisque dictum.\nIn dignissim imperdiet dolor, non ornare metus iaculis nec.\nFusce nec rhoncus lectus, id rutrum odio.\nNam varius ornare elit.\nDuis eget cursus diam.\nProin fringilla ex libero, at consequat risus vulputate in.\nProin nec magna ut tortor placerat commodo ut id metus.\nPraesent mollis quam id purus vulputate consectetur.\nNam at tortor sit amet tellus vestibulum tempus.\nPellentesque ante ipsum, viverra ut imperdiet sed, commodo mollis nibh.",
				"Curabitur cursus lacus at commodo dictum.\nSed sed pharetra purus.\nQuisque pharetra neque dolor, a interdum arcu eleifend quis.\nDonec feugiat mollis justo ut molestie.\nDonec sit amet eros eu sapien cursus sollicitudin at ac dolor.\nDuis in interdum eros, vitae rutrum lacus.\nSed placerat ac arcu sit amet fringilla.\nSuspendisse et tincidunt augue.\nDuis mattis ex leo, nec iaculis orci porta in.\nDonec ultrices risus tempus est dignissim laoreet.\nSed justo dolor, mattis ut dolor et, interdum pharetra neque.\nAenean congue enim ligula, vitae interdum metus consectetur at.",
				"Sed ullamcorper gravida odio vel auctor.\nProin in velit pulvinar, consequat arcu non, congue arcu.\nMorbi ut egestas magna.\nInteger mattis lectus nec magna fringilla, vel gravida nisl eleifend.\nQuisque condimentum commodo mollis.\nMauris convallis massa nec tincidunt porta.\nFusce faucibus eros quis ante dignissim, maximus auctor justo posuere.",
				"Integer nibh orci, finibus eu cursus nec, aliquam vitae augue.\nSed lectus lectus, venenatis et venenatis eget, efficitur et turpis.\nFusce enim nibh, imperdiet sit amet condimentum vel, suscipit et ex.\nNullam elementum consequat elementum.\nUt tempor, ante sed posuere vehicula, sapien est commodo sapien, ultrices porttitor magna felis at felis.\nMaecenas rutrum vehicula nisl, quis semper ex blandit quis.\nAenean neque nunc, hendrerit sed feugiat sit amet, aliquet sed sapien.\nUt varius lobortis nisi.",
				"Donec urna dolor, congue ac dolor at, consequat laoreet mi.\nVivamus a turpis lacus.\nMorbi diam velit, vestibulum sit amet feugiat vitae, laoreet at enim.\nPraesent facilisis convallis condimentum.\nFusce ac mi risus.\nDonec pharetra augue nec pharetra tincidunt.\nFusce vestibulum eros leo, sed bibendum felis vehicula non.\nInteger quis arcu arcu.\nNam molestie nunc ac lorem consequat efficitur.\nVestibulum et egestas mauris.\nSuspendisse vehicula tincidunt justo.\nNunc vitae malesuada erat, in gravida arcu.\nCurabitur placerat, ex quis egestas placerat, erat urna bibendum mauris, at finibus nisi tortor in eros."
			],
			moveTargetTop = 1,
			moveTargetClosingTag = 2,
			bodyElement = null,
			lastEditedRuleSelector = "p",
			lastEditedRuleAttributeName = "color",
			lastEditedRuleAttributeValue = "black",
			tmpDiv = _CE("div", null, null),
			iframe = _ID("iframe"),
			iframeWindow = null,
			iframeDocument = null,
			iframeHead = null,
			iframeBody = null,
			iframeStyle = null,
			iframeGoogleFontsLink = null,
			ignoreCssChanges = false;

		function iframeLoaded(win, doc, style) {
			iframeWindow = win;
			iframeDocument = doc;
			iframeHead = doc.head;
			iframeBody = doc.body;
			iframeStyle = style;

			loading = false;

			createElement("body");
			createRule("body");

			dirty = false;

			updateGoogleFontsLink();
		}

		function tagClick(e) {
			dropdownShow(e, this.element, false);
		}

		function closingTagClick(e) {
			dropdownShow(e, this.element, true);
		}

		function createElement(name, parent, siblingBelow, hideUI) {
			if (loading)
				return;

			if (!parent) {
				// The body element is a special case
				bodyElement = _CE("div", "element");
				// These attribute names were chosen like this in order to
				// avoid any conflicts with existing attribute names!
				bodyElement.elementCategory = categoryElement;
				bodyElement.elementType = elementTypeBody;
				bodyElement.elementParent = null;
				bodyElement.elementIframe = iframeBody;

				bodyElement.elementTag = _CE("div", "element-tag", bodyElement);
				bodyElement.elementTag.element = bodyElement;
				bodyElement.elementTag.onclick = tagClick;
				_TXT("<", bodyElement.elementTag);
				_TXT("body", _CE("span", "element-name-block", bodyElement.elementTag));
				_TXT(">", bodyElement.elementTag);

				bodyElement.elementContainer = _CE("div", "element-container", bodyElement);
				bodyElement.elementContainer.element = bodyElement;

				bodyElement.elementClosingTag = _CE("div", "element-tag move-target", bodyElement);
				bodyElement.elementClosingTag.element = bodyElement;
				bodyElement.elementClosingTag.onclick = closingTagClick;
				bodyElement.elementClosingTag.moveTarget = moveTargetClosingTag;
				_TXT("</", bodyElement.elementClosingTag);
				_TXT("body", _CE("span", "element-name-block", bodyElement.elementClosingTag));
				_TXT(">", bodyElement.elementClosingTag);

				_AC(_ID("editor-container"), bodyElement);

				return bodyElement;
			}

			var e, elementType = elementTypesByName[name];
			if (!elementType)
				return;

			if (elementType !== elementTypeText &&
				elementType !== elementTypeComment &&
				elementType.block && !parent.elementType.block) {
				Notification.error(translate("ErrorBlockInsideInline"), true);
				return;
			}

			dirty = true;

			e = _CE("div", "element");
			e.elementCategory = categoryElement;
			e.elementParent = parent;
			e.elementType = elementType;

			if (elementType === elementTypeText) {
				e.elementTag = _CE("div", "element-tag element-text move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				e.elementTag.empty = true;
				_TXT(window.placeholderText, e.elementTag);
				e.elementIframe = _ITXT("");
			} else if (elementType === elementTypeComment) {
				e.elementTag = _CE("div", "element-tag element-comment move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				_TXT("<!--\n", e.elementTag);
				_TXT("", e.elementComment = _CE("span", "", e.elementTag));
				_TXT("\n-->", e.elementTag);
				e.elementIframe = _ICMT("");
			} else {
				e.elementTag = _CE("div", "element-tag move-target", e);
				e.elementTag.element = e;
				e.elementTag.onclick = tagClick;
				e.elementTag.moveTarget = moveTargetTop;
				_TXT("<", e.elementTag);
				_TXT(name, _CE("span", elementType.block ? "element-name-block" : "element-name", e.elementTag));
				_TXT(elementType.noChildren ? " />" : ">", e.elementTag);
				e.elementIframe = _ICE(name);

				if (!elementType.noChildren) {
					e.elementContainerVisible = true;
					e.elementContainerPlaceholder = _CE("span", "element-placeholder", e);
					_TXT("\u2026", e.elementContainerPlaceholder);
					e.elementContainer = _CE("div", "element-container", e);
					e.elementContainer.element = e;

					e.elementClosingTag = _CE("div", "element-tag move-target", e);
					e.elementClosingTag.element = e;
					e.elementClosingTag.onclick = closingTagClick;
					e.elementClosingTag.moveTarget = moveTargetClosingTag;
					_TXT("</", e.elementClosingTag);
					_TXT(name, _CE("span", elementType.block ? "element-name-block" : "element-name", e.elementClosingTag));
					_TXT(">", e.elementClosingTag);
				}
			}

			if (siblingBelow) {
				_IB(parent.elementContainer, e, siblingBelow);
				_IB(parent.elementIframe, e.elementIframe, siblingBelow.elementIframe);
			} else {
				_AC(parent.elementContainer, e);
				_AC(parent.elementIframe, e.elementIframe);
			}

			if ((elementType === elementTypeText || elementType === elementTypeComment) && !hideUI)
				editText(e);

			return e;
		}

		function deleteElement(element) {
			if (loading || !element || !element.elementParent || !element.elementParent.elementContainer)
				return;

			dirty = true;

			_RC(element.elementParent.elementContainer, element);
			_RC(element.elementParent.elementIframe, element.elementIframe);
		}

		function getElementText(element) {
			return (element.elementType === elementTypeComment ? element.elementComment.textContent : (element.elementType === elementTypeText && !element.elementTag.empty ? element.elementTag.firstChild.nodeValue : ""));
		}

		function setElementText(element, text) {
			if (element.elementType === elementTypeText) {
				dirty = true;

				var elementTag = element.elementTag;
				if (!text) {
					elementTag.empty = true;
					elementTag.firstChild.nodeValue = window.placeholderText;
					element.elementIframe.nodeValue = "";
				} else {
					elementTag.empty = false;
					elementTag.firstChild.nodeValue = text;
					tmpDiv.innerHTML = text;
					element.elementIframe.nodeValue = tmpDiv.textContent;
				}
			} else if (element.elementType === elementTypeComment) {
				dirty = true;

				element.elementComment.textContent = text;
				element.elementIframe.nodeValue = "\n" + text + "\n";
			}
		}

		function editText(element) {
			if (loading || !element || (element.elementType !== elementTypeText && element.elementType !== elementTypeComment))
				return;

			var modalTxtInput = _ID("modalTxtInput"),
				modalTxtOk = _ID("modalTxtOk");
			modalTxtInput.value = getElementText(element);
			modalTxtOk.onclick = function () {
				var txt = modalTxtInput.value;
				if (txt.indexOf("<") >= 0 || txt.indexOf(">") >= 0) {
					Notification.error(translate("ErrorInvalidChar"), true);
					return;
				}
				$("#modalTxt").modal("hide");
				setElementText(element, modalTxtInput.value);
			};
			$("#modalTxt").modal({
				keyboard: true,
				backdrop: true
			});
		}

		function changeType(newName, element) {
			if (loading || !element)
				return;

			var i, newElementType = elementTypesByName[newName];
			if (!newElementType || newElementType === elementTypeText || element.elementType === newElementType)
				return;

			if (newElementType.block) {
				if (!element.elementParent.elementType.block) {
					Notification.error(translate("ErrorBlockInsideInline"), true);
					return;
				}
			} else if (!element.elementType.noChildren) {
				for (i = element.elementContainer.childNodes.length - 1; i >= 0; i--) {
					if (element.elementContainer.childNodes[i].elementType.block) {
						Notification.error(translate("ErrorInlineParentBlock"), true);
						return;
					}
				}
			}

			if (!newElementType.noChildren !== !element.elementType.noChildren) {
				Notification.error(translate(newElementType.noChildren ? "ErrorNewElementMustHaveChildren" : "ErrorNewElementMustNotHaveChildren"), true);
				return;
			}

			dirty = true;

			var newElement = createElement(newName, element.elementParent, element);

			if (!element.elementType.noChildren) {
				var e,
					container = element.elementContainer,
					newContainer = newElement.elementContainer,
					icontainer = element.elementIframe,
					inewContainer = newElement.elementIframe;
				while ((e = container.firstChild)) {
					_RC(container, e);
					e.elementParent = newElement;
					_AC(newContainer, e);
					_RC(icontainer, e.elementIframe);
					_AC(inewContainer, e.elementIframe);
				}
			}

			deleteElement(element);
		}

		function toggleVisibility(element) {
			if (loading || !element || (element.elementCategory === categoryElement && element.elementType.noChildren) || element.elementCategory === categoryRuleAttribute)
				return;

			element.elementContainerVisible = !element.elementContainerVisible;
			element.className = (element.elementContainerVisible ? "element" : "element collapsed");
		}

		function createImageInput(parent, addAsUrl) {
			var inputGroup = _CE("div", "input-group", parent),
				input = _SA(_SA(_SA(_CE("input", "form-control", inputGroup), "spellcheck", "false"), "type", "text"), "autocomplete", "off"),
				fileInput = _SA(_SA(_SA(_CE("input", "editor-hidden-file-input", inputGroup), "tabindex", "-1"), "type", "file"), "accept", "image/png,image/gif,image/jpeg");

			fileInput.onchange = function () {
				var file;
				if (loading)
					return;
				if (!("files" in this)) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}
				if (!this.files.length || !(file = this.files[0]))
					return;
				if (file.size > (1 << 20)) {
					Notification.error(translate("ErrorFileTooLarge"), true);
					return;
				}
				loadFileDataURL(file, function (dataURL) {
					input.value = ((addAsUrl && dataURL) ? ("url(\"" + dataURL + "\")") : (dataURL || ""));
				});
			};
			_BTN("btn btn-default btn-force-border", "fa-folder-open", translate("LoadImage"), _CE("span", "input-group-btn", inputGroup), function () {
				if (loading)
					return;
				fileInput.click();
			});

			return input;
		}

		function createRule(ruleSelector, siblingBelow, hideUI) {
			if (loading)
				return;

			dirty = true;

			// For the future... Perhaps we could use the CSSStyleSheet API?!?!
			// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule

			var e = _CE("div", "element");
			// These attribute names were chosen like this in order to
			// avoid any conflicts with existing attribute names!
			e.elementCategory = categoryRule;

			e.elementTag = _CE("div", "element-tag move-target-top", e);
			e.elementTag.element = e;
			e.elementTag.onclick = tagClick;
			e.elementTag.moveTarget = moveTargetTop;
			_TXT(trim(ruleSelector || lastEditedRuleSelector || "p"), _CE("span", "element-name-block", e.elementTag));
			_TXT(" {", e.elementTag);

			e.elementContainerVisible = true;
			e.elementContainerPlaceholder = _CE("span", "element-placeholder", e);
			_TXT("\u2026", e.elementContainerPlaceholder);
			e.elementContainer = _CE("div", "element-container", e);
			e.elementContainer.element = e;

			e.elementClosingTag = _CE("div", "element-tag move-target", e);
			e.elementClosingTag.element = e;
			e.elementClosingTag.onclick = closingTagClick;
			e.elementClosingTag.moveTarget = moveTargetClosingTag;
			_TXT("}", e.elementClosingTag);

			if (siblingBelow)
				_IB(editorCss, e, siblingBelow);
			else
				_AC(editorCss, e);

			updateCss();

			if (!ruleSelector && !hideUI)
				editRuleSelector(e);

			return e;
		}

		function deleteRule(element) {
			if (loading || !element || element.elementCategory !== categoryRule)
				return;

			dirty = true;

			_RC(editorCss, element);

			if (!editorCss.childNodes.length)
				createRule("body");

			updateCss();
		}

		function getRuleSelector(element) {
			return ((element.elementCategory === categoryRule && element.elementTag.firstChild.firstChild.nodeValue) || "");
		}

		function setRuleSelector(element, newRuleSelector) {
			if (element.elementCategory === categoryRule && newRuleSelector) {
				dirty = true;

				element.elementTag.firstChild.firstChild.nodeValue = newRuleSelector;
			}
		}

		function editRuleSelector(element) {
			if (loading || !element || element.elementCategory !== categoryRule)
				return;

			var modalRuleSelectorInput = _ID("modalRuleSelectorInput"),
				modalRuleSelectorOk = _ID("modalRuleSelectorOk");
			modalRuleSelectorInput.value = getRuleSelector(element);
			modalRuleSelectorOk.onclick = function () {
				var newRuleSelector = trimValue(modalRuleSelectorInput);
				if (!newRuleSelector)
					return;
				lastEditedRuleSelector = newRuleSelector;
				$("#modalRuleSelector").modal("hide");
				setRuleSelector(element, newRuleSelector);
				updateCss();
			};
			$("#modalRuleSelector").modal({
				keyboard: true,
				backdrop: true
			});
		}

		function createRuleAttribute(name, value, parent, siblingBelow, hideUI) {
			if (loading)
				return;

			// For the future... Perhaps we could use the CSSStyleSheet API?!?!
			// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule

			if (!name && !value) {
				name = lastEditedRuleAttributeName;
				value = lastEditedRuleAttributeValue;
			}

			var e, elementAttribute = cssAttributesByName[name];
			if (!elementAttribute)
				return;

			dirty = true;

			e = _CE("div", "element");
			// These attribute names were chosen like this in order to
			// avoid any conflicts with existing attribute names!
			e.elementCategory = categoryRuleAttribute;
			e.elementParent = parent;

			e.elementTag = _CE("div", "element-tag move-target", e);
			e.elementTag.element = e;
			e.elementTag.onclick = tagClick;
			e.elementTag.moveTarget = moveTargetTop;
			_TXT(name, e.elementAttributeName = _CE("span", "attribute-name", e.elementTag));
			_TXT(": ", e.elementTag);
			_TXT(" ", e.elementAttributeValue = _CE("span", "attribute-value", e.elementTag));
			_TXT(";", e.elementTag);

			if (siblingBelow)
				_IB(parent.elementContainer, e, siblingBelow);
			else
				_AC(parent.elementContainer, e);

			setRuleAttribute(e, name, value);

			updateCss();

			if (!hideUI)
				editRuleAttribute(e);

			return e;
		}

		function deleteRuleAttribute(element) {
			if (loading || !element || element.elementCategory !== categoryRuleAttribute)
				return;

			dirty = true;

			_RC(element.elementParent.elementContainer, element);

			updateCss();
		}

		function getRuleAttributeName(element) {
			return ((element.elementCategory === categoryRuleAttribute && element.elementAttributeName.firstChild.nodeValue) || "");
		}

		function getRuleAttributeValue(element) {
			return ((element.elementCategory === categoryRuleAttribute && element.elementAttributeValue.elementActualAttributeValue) || "");
		}

		function setRuleAttribute(element, newRuleAttributeName, newRuleAttributeValue) {
			if (element.elementCategory === categoryRuleAttribute && newRuleAttributeName && newRuleAttributeValue) {
				dirty = true;

				element.elementAttributeName.firstChild.nodeValue = newRuleAttributeName;
				element.elementAttributeValue.elementActualAttributeValue = newRuleAttributeValue;
				if (newRuleAttributeValue.length > 50)
					element.elementAttributeValue.firstChild.nodeValue = newRuleAttributeValue.substr(0, 49) + "\u2026";
				else
					element.elementAttributeValue.firstChild.nodeValue = newRuleAttributeValue;
			}
		}

		function updateRuleAttributeValueSelect() {
			var modalRuleAttributeName = _ID("modalRuleAttributeName"),
				modalRuleAttributeValueLabel = _ID("modalRuleAttributeValueLabel"),
				modalRuleAttributeValueInput = _ID("modalRuleAttributeValueInput"),
				modalRuleAttributeValueSelect = _ID("modalRuleAttributeValueSelect"),
				modalRuleAttributeValueImageInputGroup = _ID("modalRuleAttributeValueImageInputGroup"),
				modalRuleAttributeHelp = _ID("modalRuleAttributeHelp"),
				i, v, a = cssAttributesByName[modalRuleAttributeName.value];

			_SA(modalRuleAttributeHelp, "href", a ? a.urlHelp : "");

			while (modalRuleAttributeValueSelect.firstChild)
				_RC(modalRuleAttributeValueSelect, modalRuleAttributeValueSelect.firstChild);

			if (a && a.values && a.values.length) {
				modalRuleAttributeValueInput.style.display = "none";
				modalRuleAttributeValueImageInputGroup.style.display = "none";

				for (i = 0; i < a.values.length; i++)
					_TXT(v = a.values[i], _SA(_CE("option", null, modalRuleAttributeValueSelect), "value", v));

				modalRuleAttributeValueSelect.style.display = "";
				_SA(modalRuleAttributeValueLabel, "for", "modalRuleAttributeValueSelect");
			} else if (a && a.values === valueImage) {
				modalRuleAttributeValueInput.style.display = "none";
				modalRuleAttributeValueSelect.style.display = "none";
				modalRuleAttributeValueImageInputGroup.style.display = "";
				_SA(modalRuleAttributeValueLabel, "for", "modalRuleAttributeValueImageInput");
			} else {
				modalRuleAttributeValueSelect.style.display = "none";
				modalRuleAttributeValueImageInputGroup.style.display = "none";
				modalRuleAttributeValueInput.style.display = "";
				_SA(modalRuleAttributeValueLabel, "for", "modalRuleAttributeValueInput");
			}
		}

		function editRuleAttribute(element) {
			if (loading || !element || element.elementCategory !== categoryRuleAttribute)
				return;

			var modalRuleAttributeName = _ID("modalRuleAttributeName"),
				modalRuleAttributeValueInput = _ID("modalRuleAttributeValueInput"),
				modalRuleAttributeValueSelect = _ID("modalRuleAttributeValueSelect"),
				modalRuleAttributeValueImageInput = _ID("modalRuleAttributeValueImageInput"),
				modalRuleAttributeOk = _ID("modalRuleAttributeOk");
			modalRuleAttributeName.value = getRuleAttributeName(element);
			updateRuleAttributeValueSelect();
			if (modalRuleAttributeValueInput.style.display !== "none") {
				modalRuleAttributeValueImageInput.value = "";
				modalRuleAttributeValueInput.value = getRuleAttributeValue(element);
			} else if (modalRuleAttributeValueSelect.style.display !== "none") {
				modalRuleAttributeValueInput.value = "";
				modalRuleAttributeValueImageInput.value = "";
				modalRuleAttributeValueSelect.value = getRuleAttributeValue(element);
			} else {
				modalRuleAttributeValueInput.value = "";
				modalRuleAttributeValueImageInput.value = getRuleAttributeValue(element);
			}
			modalRuleAttributeOk.onclick = function () {
				var newRuleAttributeName = modalRuleAttributeName.value,
					newRuleAttributeValue = (modalRuleAttributeValueSelect.style.display !== "none" ? modalRuleAttributeValueSelect.value :
						trimValue(modalRuleAttributeValueInput.style.display !== "none" ? modalRuleAttributeValueInput : modalRuleAttributeValueImageInput));
				if (!newRuleAttributeName || !newRuleAttributeValue)
					return;
				lastEditedRuleAttributeName = newRuleAttributeName;
				lastEditedRuleAttributeValue = newRuleAttributeValue;
				$("#modalRuleAttribute").modal("hide");
				setRuleAttribute(element, newRuleAttributeName, newRuleAttributeValue);
				updateCss();
			};
			$("#modalRuleAttribute").modal({
				keyboard: true,
				backdrop: true
			});
		}

		function generateCss() {
			// For the future... Perhaps we could use the CSSStyleSheet API?!?!
			// https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/insertRule

			var css = "", tmp, i, j, rule, rules = editorCss.childNodes, attribute, attributes;

			for (i = 0; i < rules.length; i++) {
				tmp = ("\t" + getRuleSelector(rule = rules[i]) + " {\n");

				attributes = rule.elementContainer.childNodes;
				for (j = 0; j < attributes.length; j++)
					tmp += ("\t\t" + getRuleAttributeName(attribute = attributes[j]) + ": " + getRuleAttributeValue(attribute) + ";\n");

				css += (tmp + "\t}\n");
			}

			return css;
		}

		function updateCss() {
			if (!ignoreCssChanges)
				iframeStyle.textContent = generateCss();
		}

		function updateGoogleFontsLink(href) {
			if (iframeGoogleFontsLink)
				_RC(iframeHead, iframeGoogleFontsLink);
			_IB(iframeHead, iframeGoogleFontsLink = _SA(_SA(_SA(_SA(_ICE("link"), "rel", "stylesheet"), "type", "text/css"), "id", "googleFontsLink"), "href", trim(href || "")), iframeStyle);
		}

		// Initial
		(function () {
			var i, a, e, v,
				modalTxtInput = _ID("modalTxtInput"),
				modalTxtOk = _ID("modalTxtOk"),
				modalTxtBtnLoremIpsum = _ID("modalTxtBtnLoremIpsum"),
				modalTxtSelectLoremIpsum = _ID("modalTxtSelectLoremIpsum"),
				modalRuleSelectorInput = _ID("modalRuleSelectorInput"),
				modalRuleSelectorOk = _ID("modalRuleSelectorOk"),
				modalRuleAttributeName = _ID("modalRuleAttributeName"),
				modalRuleAttributeValueInput = _ID("modalRuleAttributeValueInput"),
				modalRuleAttributeValueImageInput = createImageInput(modalRuleAttributeValueInput.parentNode, true),
				modalRuleAttributeOk = _ID("modalRuleAttributeOk");

			$("#modalTxt").on("shown.bs.modal", function () {
				modalTxtInput.focus();
			});
			//modalTxtInput.onkeydown = function (e) {
			//	if (e.key === "Enter" || e.keyCode === 13)
			//		modalTxtOk.click();
			//};
			modalTxtBtnLoremIpsum.onclick = function () {
				modalTxtInput.value = loremIpsum[parseInt(modalTxtSelectLoremIpsum.value)];
				modalTxtOk.click();
			};
			for (i = 0; i < loremIpsum.length; i++)
				_TXT((i + 1).toString(), _SA(_CE("option", null, modalTxtSelectLoremIpsum), "value", i));

			$("#modalRuleSelector").on("shown.bs.modal", function () {
				modalRuleSelectorInput.focus();
			});
			modalRuleSelectorInput.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalRuleSelectorOk.click();
			};

			function modalRuleAttributeValueInputKeyDown(e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalRuleAttributeOk.click();
			}
			$("#modalRuleAttribute").on("shown.bs.modal", function () {
				modalRuleAttributeName.focus();
			});
			modalRuleAttributeName.onchange = updateRuleAttributeValueSelect;
			_SA(modalRuleAttributeValueImageInput, "id", "modalRuleAttributeValueImageInput").onkeydown = modalRuleAttributeValueInputKeyDown;
			modalRuleAttributeValueInput.onkeydown = modalRuleAttributeValueInputKeyDown;
			_SA(modalRuleAttributeValueImageInput.parentNode, "id", "modalRuleAttributeValueImageInputGroup");

			function sortByName(a, b) {
				return (a.name < b.name ? -1 : 1);
			}

			for (i = elementTypes.length - 1; i >= 0; i--) {
				e = elementTypes[i];
				elementTypesByName[e.name] = e;
				e.urlHelp = "https://developer.mozilla.org/en-US/docs/Web/HTML/Element/" + e.name;
				a = e.attributes;
				if (!a) {
					e.attributes = htmlAttributes;
				} else {
					a.push.apply(a, htmlAttributes);
					a.sort(function (a, b) {
						if (!a.common === !b.common)
							return (a.name < b.name ? -1 : 1);
						return (a.common ? -1 : 1);
					});
				}
			}

			for (i = cssAttributes.length - 1; i >= 0; i--) {
				e = cssAttributes[i];
				cssAttributesByName[e.name] = e;
				e.urlHelp = "https://developer.mozilla.org/en-US/docs/Web/CSS/" + e.name;
				e.common = true;
			}

			elementTypes.sort(sortByName);
			cssAttributes.sort(sortByName);

			elementTypeBody = {
				name: "body",
				block: true,
				attributes: null
			};
			elementTypeText = {
				name: "text",
				attributes: null,
				noChildren: true
			};
			elementTypeComment = {
				name: "comment",
				attributes: null,
				noChildren: true
			};
			elementTypesByName["text"] = elementTypeText;
			elementTypesByName["comment"] = elementTypeComment;

			for (i = 0; i < cssAttributes.length; i++)
				_TXT(v = cssAttributes[i].name, _SA(_CE("option", null, modalRuleAttributeName), "value", v));

			_SA(iframe, "src", "empty.html");

			window.onbeforeunload = function () {
				return (dirty ? translate("ConfirmQuit") : null);
			};

			window.resizeWindow();

			setTimeout(function () { document.body.style.visibility = ""; }, 250);
		})();

		// DropdownMenus
		(function () {
			var dropdownX = 0,
				dropdownY = 0,
				dropdownFading = false, dropdownMoving = false, dropdownMovingCss = false,
				dropdownVisible = false, dropdownTypeVisible = false, dropdownHighlighting = false,
				dropdownActionTop = false, dropdownActionClosingTag = false, dropdownActionChangeType = false, dropdownActionEditRuleSelector = false, dropdownActionEditRuleAttribute = false,
				dropdownShowTop = false, dropdownShowLeft = false, dropdownShowRight = false, dropdownShowBottom = false,
				dropdownShowTypeOnHide = false, dropdownCreateTextOnHide = false, dropdownCreateCommentOnHide = false, dropdownMoveOnHide = false, dropdownEditTextOnHide = false, dropdownEditAttributesOnHide = false, dropdownCreateEditRuleOnHide = false, dropdownCreateEditRuleAttributeOnHide = false,
				toolbarElementName = null, toolbarShowTypeOnClick = false, toolbarCreateTextOnClick = false, toolbarCreateCommentOnClick = false, toolbarCreateRuleOnClick = false, toolbarCreateAttributeOnClick = false,
				dropdownElement = null,
				dropdownType = _ID("dropdownType"),
				dropdownTypeInput = _("dropdownTypeInput"),
				dropdownTypeButton = _("dropdownTypeButton"),
				dropdownTypeContainer = _("dropdownTypeContainer"),
				dropdownMenuTop = _ID("dropdownMenuTop"),
				dropdownMenuTopCreateElement = _ID("dropdownMenuTopCreateElement"),
				dropdownMenuTopCreateRule = _ID("dropdownMenuTopCreateRule"),
				dropdownMenuTopCreateRuleAttribute = _ID("dropdownMenuTopCreateRuleAttribute"),
				dropdownMenuTopCreateText = _ID("dropdownMenuTopCreateText"),
				dropdownMenuTopCreateComment = _ID("dropdownMenuTopCreateComment"),
				dropdownMenuLeft = _ID("dropdownMenuLeft"),
				dropdownMenuLeftToggleVisibility = _ID("dropdownMenuLeftToggleVisibility"),
				dropdownMenuRight = _ID("dropdownMenuRight"),
				dropdownMenuRightEditText = _ID("dropdownMenuRightEditText"),
				dropdownMenuRightFind = _ID("dropdownMenuRightFind"),
				dropdownMenuRightChangeType = _ID("dropdownMenuRightChangeType"),
				dropdownMenuRightEditRuleSelector = _ID("dropdownMenuRightEditRuleSelector"),
				dropdownMenuRightEditRuleAttribute = _ID("dropdownMenuRightEditRuleAttribute"),
				dropdownMenuRightEditAttributes = _ID("dropdownMenuRightEditAttributes"),
				dropdownMenuBottom = _ID("dropdownMenuBottom"),
				dropdownMenuBottomCreateElement = _ID("dropdownMenuBottomCreateElement"),
				dropdownMenuBottomCreateRule = _ID("dropdownMenuBottomCreateRule"),
				dropdownMenuBottomCreateRuleAttribute = _ID("dropdownMenuBottomCreateRuleAttribute"),
				dropdownMenuBottomCreateText = _ID("dropdownMenuBottomCreateText"),
				dropdownMenuBottomCreateComment = _ID("dropdownMenuBottomCreateComment"),
				editorToolbarCreateElement = _ID("editorToolbarCreateElement"),
				editorToolbarCreateText = _ID("editorToolbarCreateText"),
				editorToolbarCreateComment = _ID("editorToolbarCreateComment"),
				editorToolbarCreateRule = _ID("editorToolbarCreateRule"),
				editorToolbarCreateAttribute = _ID("editorToolbarCreateAttribute");

			dropdownTypeContainer.style.height = (300 - 59) + "px";

			function fadeInFinished() {
				dropdownFading = false;
				if (dropdownShowTop)
					dropdownMenuTop.style.pointerEvents = "";
				if (dropdownShowLeft)
					dropdownMenuLeft.style.pointerEvents = "";
				if (dropdownShowRight)
					dropdownMenuRight.style.pointerEvents = "";
				if (dropdownShowBottom)
					dropdownMenuBottom.style.pointerEvents = "";
			}

			function fadeInTypeFinished() {
				dropdownFading = false;
				dropdownType.style.pointerEvents = "";
				dropdownTypeInput.focus();
				dropdownTypeInput.setSelectionRange(0, dropdownTypeInput.value.length);
			}

			function fadeOutFinished() {
				dropdownFading = false;
				dropdownMenuTop.style.display = "";
				dropdownMenuLeft.style.display = "";
				dropdownMenuRight.style.display = "";
				dropdownMenuBottom.style.display = "";

				if (dropdownShowTypeOnHide || toolbarShowTypeOnClick) {
					dropdownShowTypeOnHide = false;
					dropdownTypeVisible = true;
					dropdownFading = true;
					document.addEventListener("mousedown", mouseDown, true);
					document.addEventListener("keydown", keyDown, true);
					var width = (window.innerWidth | 0),
						height = (window.innerHeight | 0),
						x = dropdownX,
						y = dropdownY;
					if ((x + 210 + 4) > width)
						x = width - 210 - 4;
					if ((y + 300 + 4) > height)
						y = height - 300 - 4;
					dropdownType.style.display = "block";
					dropdownType.style.left = x + "px";
					dropdownType.style.top = y + "px";
					dropdownType.style.width = 210 + "px";
					dropdownType.style.height = 300 + "px";
					setTimeout(startFadeInType, 50);
					return;
				} else if (dropdownCreateTextOnHide) {
					dropdownCreateTextOnHide = false;
					dropdownCreateElement("text");
				} else if (dropdownCreateCommentOnHide) {
					dropdownCreateCommentOnHide = false;
					dropdownCreateElement("comment");
				} else if (dropdownMoveOnHide) {
					lockUI(false);
					dropdownMoveOnHide = false;
					move(true, false);
				} else if (dropdownEditTextOnHide) {
					dropdownEditTextOnHide = false;
					editText(dropdownElement);
				} else if (dropdownEditAttributesOnHide) {
					dropdownEditAttributesOnHide = false;
					showModalAttributes();
				} else if (dropdownCreateEditRuleOnHide) {
					dropdownCreateEditRuleOnHide = false;
					if (dropdownActionEditRuleSelector)
						editRuleSelector(dropdownElement);
					else if (dropdownActionTop)
						createRule(null, dropdownElement);
					else
						createRule(null, dropdownElement.nextSibling);
				} else if (dropdownCreateEditRuleAttributeOnHide) {
					dropdownCreateEditRuleAttributeOnHide = false;
					if (dropdownActionEditRuleAttribute) {
						editRuleAttribute(dropdownElement);
					} else if (dropdownElement.elementCategory === categoryRule) {
						if (dropdownActionTop)
							createRuleAttribute(null, null, dropdownElement, null);
						else
							createRuleAttribute(null, null, dropdownElement, dropdownElement.elementContainer.firstChild);
					} else {
						if (dropdownActionTop)
							createRuleAttribute(null, null, dropdownElement.elementParent, dropdownElement);
						else
							createRuleAttribute(null, null, dropdownElement.elementParent, dropdownElement.nextSibling);
					}
				}

				lockUI(false);
			}

			function fadeOutTypeFinished() {
				dropdownFading = false;
				dropdownType.style.display = "";
				lockUI(false);
			}

			function startFadeIn() {
				if (dropdownShowTop) {
					dropdownMenuTop.style.pointerEvents = "none";
					dropdownMenuTop.className = "editor-menu editor-menu-animated editor-menu-top editor-menu-visible";
				}
				if (dropdownShowLeft) {
					dropdownMenuLeft.style.pointerEvents = "none";
					dropdownMenuLeft.className = "editor-menu editor-menu-animated editor-menu-left editor-menu-visible";
				}
				if (dropdownShowRight) {
					dropdownMenuRight.style.pointerEvents = "none";
					dropdownMenuRight.className = "editor-menu editor-menu-animated editor-menu-right editor-menu-visible";
				}
				if (dropdownShowBottom) {
					dropdownMenuBottom.style.pointerEvents = "none";
					dropdownMenuBottom.className = "editor-menu editor-menu-animated editor-menu-bottom editor-menu-visible";
				}
				setTimeout(fadeInFinished, 210);
			}

			function startFadeInType() {
				dropdownType.style.pointerEvents = "none";
				dropdownType.className = "dropdown-menu editor-menu-animated editor-menu-visible";
				setTimeout(fadeInTypeFinished, 210);
			}

			function startFadeOut() {
				dropdownFading = true;
				dropdownVisible = false;
				dropdownMenuTop.style.pointerEvents = "none";
				dropdownMenuLeft.style.pointerEvents = "none";
				dropdownMenuRight.style.pointerEvents = "none";
				dropdownMenuBottom.style.pointerEvents = "none";
				dropdownMenuTop.className = "editor-menu editor-menu-animated editor-menu-top";
				dropdownMenuLeft.className = "editor-menu editor-menu-animated editor-menu-left";
				dropdownMenuRight.className = "editor-menu editor-menu-animated editor-menu-right";
				dropdownMenuBottom.className = "editor-menu editor-menu-animated editor-menu-bottom";
				setTimeout(fadeOutFinished, 210);
			}

			function startFadeOutType() {
				dropdownFading = true;
				dropdownTypeVisible = false;
				dropdownType.style.pointerEvents = "none";
				dropdownType.className = "dropdown-menu editor-menu-animated";
				setTimeout(fadeOutTypeFinished, 210);
			}

			function hide() {
				document.removeEventListener("mousedown", mouseDown, true);
				document.removeEventListener("keydown", keyDown, true);
				if (dropdownVisible)
					startFadeOut();
				else if (dropdownTypeVisible)
					startFadeOutType();
			}

			function mouseDown(e) {
				if ((!dropdownVisible && !dropdownTypeVisible) || dropdownFading || e.button)
					return;
				// Ignore all clicks on the menus
				var t = e.target;
				while (t && t.parentNode && t !== document.body) {
					if (t === dropdownMenuTop || t === dropdownMenuLeft || t === dropdownMenuRight || t === dropdownMenuBottom || t === dropdownType)
						return;
					t = t.parentNode;
				}
				hide();
			}

			function keyDown(e) {
				if ((!dropdownVisible && !dropdownTypeVisible) || dropdownFading || dropdownMoving)
					return;
				if (e.key === "Escape" || e.keyCode === 27)
					hide();
			}

			function clickMoving(e) {
				if (!dropdownMoving || e.button)
					return;

				var moveTarget = e.target.moveTarget, targetElement, targetParent, parent = e.target, name;

				while (parent && parent !== document.body && parent !== editor && parent !== editorCss)
					parent = parent.parentNode;
				if (parent !== editor && parent !== editorCss) {
					move(false, false);
					return;
				}

				if (!moveTarget && e.target.parentNode) {
					moveTarget = e.target.parentNode.moveTarget;
					if (!moveTarget)
						return;
					targetElement = e.target.parentNode.element;
				} else {
					targetElement = e.target.element;
				}

				parent = targetElement;
				while (parent && parent !== bodyElement && parent !== document.body) {
					if (parent === dropdownElement)
						return;
					parent = parent.parentNode;
				}

				if (toolbarShowTypeOnClick) {
					if ((name = toolbarElementName)) {
						// We must invert the order here, in order not to hide a possible error
						// message displayed by createElement()

						move(false, false);

						cancelEvent(e);

						if (moveTarget === moveTargetClosingTag)
							createElement(name, targetElement, null);
						else
							createElement(name, targetElement.elementParent, targetElement);

						return false;
					}
					clearToolbarActions();
				} else if (toolbarCreateTextOnClick) {
					clearToolbarActions();
					if (moveTarget === moveTargetClosingTag)
						createElement("text", targetElement, null);
					else
						createElement("text", targetElement.elementParent, targetElement);
				} else if (toolbarCreateCommentOnClick) {
					clearToolbarActions();
					if (moveTarget === moveTargetClosingTag)
						createElement("comment", targetElement, null);
					else
						createElement("comment", targetElement.elementParent, targetElement);
				} else if (toolbarCreateRuleOnClick) {
					if (targetElement.elementCategory === categoryRuleAttribute || moveTarget === moveTargetClosingTag)
						return;

					clearToolbarActions();
					createRule(null, targetElement);
				} else if (toolbarCreateAttributeOnClick) {
					if (targetElement.elementCategory === categoryRule && moveTarget === moveTargetTop)
						return;

					clearToolbarActions();
					if (moveTarget === moveTargetClosingTag)
						createRuleAttribute(null, null, targetElement, null);
					else
						createRuleAttribute(null, null, targetElement.elementParent, targetElement);
				} else if (dropdownMovingCss) {
					if (dropdownElement.elementCategory === categoryElement)
						return;

					if (dropdownElement.elementCategory === categoryRule) {
						if (targetElement.elementCategory === categoryRuleAttribute || moveTarget === moveTargetClosingTag)
							return;

						_RC(dropdownElement.parentNode, dropdownElement);
						_IB(editorCss, dropdownElement, targetElement);
					} else {
						if (targetElement.elementCategory === categoryRule && moveTarget === moveTargetTop)
							return;

						_RC(dropdownElement.parentNode, dropdownElement);
						if (moveTarget === moveTargetClosingTag)
							_AC(targetElement.elementContainer, dropdownElement);
						else
							_IB(targetElement.parentNode, dropdownElement, targetElement);

						dropdownElement.elementParent = targetElement;
					}

					updateCss();
				} else {
					if (dropdownElement.elementCategory !== categoryElement)
						return;

					if (moveTarget === moveTargetClosingTag)
						targetParent = targetElement;
					else
						targetParent = targetElement.elementParent;

					if (dropdownElement.elementType.block) {
						parent = targetParent;
						while (parent && parent !== bodyElement) {
							if (!parent.elementType.block)
								return;
							parent = parent.elementParent;
						}
					}

					_RC(dropdownElement.parentNode, dropdownElement);
					_RC(dropdownElement.elementIframe.parentNode, dropdownElement.elementIframe);

					dropdownElement.elementParent = targetParent;

					if (moveTarget === moveTargetClosingTag) {
						_AC(targetParent.elementContainer, dropdownElement);
						_AC(targetParent.elementIframe, dropdownElement.elementIframe);
					} else {
						_IB(targetParent.elementContainer, dropdownElement, targetElement);
						_IB(targetParent.elementIframe, dropdownElement.elementIframe, targetElement.elementIframe);
					}
				}

				move(false, false);

				cancelEvent(e);

				return false;
			}

			function keyDownMoving(e) {
				if (!dropdownMoving)
					return;
				if (e.key === "Escape" || e.keyCode === 27)
					move(false, false);
			}

			function move(start, startByToolbar) {
				if (start) {
					dropdownMoving = true;
					dropdownMovingCss = $(editorCss).hasClass("active");
					document.addEventListener("click", clickMoving, true);
					document.addEventListener("keydown", keyDownMoving, true);
					if (!startByToolbar)
						$(dropdownElement).addClass("moving");
					$(dropdownMovingCss ? editorCss : editor).addClass(dropdownMovingCss && (toolbarCreateRuleOnClick || (!startByToolbar && dropdownElement.elementCategory === categoryRule)) ? "moving-top" : "moving");
					Notification.show(translate(startByToolbar ? (toolbarCreateTextOnClick ? "MoveMessageCreateText" : (toolbarCreateCommentOnClick ? "MoveMessageCreateComment" : (toolbarShowTypeOnClick ? "MoveMessageCreateElement" : (toolbarCreateRuleOnClick ? "MoveMessageCreateRule" : "MoveMessageCreateAttribute")))) : "MoveMessage"), "default", -1, false);
				} else {
					dropdownMoving = false;
					document.removeEventListener("click", clickMoving, true);
					document.removeEventListener("keydown", keyDownMoving, true);
					$(dropdownElement).removeClass("moving");
					$(dropdownMovingCss ? editorCss : editor).removeClass("moving moving-top");
					Notification.hide();
				}
			}

			window.dropdownShow = function (e, element, closingTag) {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				var rect = (closingTag ? element.elementClosingTag : element.elementTag).getBoundingClientRect(),
					height = (rect.height | 0);

				dropdownX = (rect.left | 0) + 12;
				dropdownY = (rect.top | 0) + (height >> 1);
				dropdownVisible = true;
				dropdownFading = true;
				dropdownActionClosingTag = closingTag;
				dropdownActionChangeType = false;
				dropdownElement = element;
				lockUI(true);
				document.addEventListener("mousedown", mouseDown, true);
				document.addEventListener("keydown", keyDown, true);

				switch (element.elementCategory) {
					case categoryElement:
						dropdownShowTop = (closingTag || element.elementType !== elementTypeBody);
						dropdownShowLeft = (element.elementType !== elementTypeBody && !element.elementType.noChildren);
						dropdownShowRight = (element.elementType !== elementTypeBody);
						dropdownShowBottom = (!closingTag || element.elementType !== elementTypeBody);
						dropdownMenuTopCreateElement.style.display = "";
						dropdownMenuTopCreateRule.style.display = "none";
						dropdownMenuTopCreateRuleAttribute.style.display = "none";
						dropdownMenuTopCreateText.style.display = "";
						dropdownMenuTopCreateComment.style.display = "";
						dropdownMenuBottomCreateElement.style.display = "";
						dropdownMenuBottomCreateRule.style.display = "none";
						dropdownMenuBottomCreateRuleAttribute.style.display = "none";
						dropdownMenuBottomCreateText.style.display = "";
						dropdownMenuBottomCreateComment.style.display = "";
						dropdownMenuRightEditRuleSelector.style.display = "none";
						dropdownMenuRightEditRuleAttribute.style.display = "none";
						if (element.elementType === elementTypeText || element.elementType === elementTypeComment) {
							dropdownMenuRightEditText.style.display = "";
							dropdownMenuRightFind.style.display = "none";
							dropdownMenuRightChangeType.style.display = "none";
							dropdownMenuRightEditAttributes.style.display = "none";
						} else {
							dropdownMenuRightEditText.style.display = "none";
							dropdownMenuRightFind.style.display = "";
							dropdownMenuRightChangeType.style.display = "";
							dropdownMenuRightEditAttributes.style.display = "";
						}
						break;
					case categoryRule:
						dropdownShowTop = true;
						dropdownShowLeft = true;
						dropdownShowRight = true;
						dropdownShowBottom = true;
						dropdownMenuTopCreateElement.style.display = "none";
						dropdownMenuTopCreateRule.style.display = (closingTag ? "none" : "");
						dropdownMenuTopCreateRuleAttribute.style.display = (closingTag ? "" : "none");
						dropdownMenuTopCreateText.style.display = "none";
						dropdownMenuTopCreateComment.style.display = "none";
						dropdownMenuBottomCreateElement.style.display = "none";
						dropdownMenuBottomCreateRule.style.display = (closingTag ? "" : "none");
						dropdownMenuBottomCreateRuleAttribute.style.display = (closingTag ? "none" : "");
						dropdownMenuBottomCreateText.style.display = "none";
						dropdownMenuBottomCreateComment.style.display = "none";
						dropdownMenuRightEditRuleSelector.style.display = "";
						dropdownMenuRightEditRuleAttribute.style.display = "none";
						dropdownMenuRightEditText.style.display = "none";
						dropdownMenuRightFind.style.display = "none";
						dropdownMenuRightChangeType.style.display = "none";
						dropdownMenuRightEditAttributes.style.display = "none";
						break;
					case categoryRuleAttribute:
						dropdownShowTop = true;
						dropdownShowLeft = false;
						dropdownShowRight = true;
						dropdownShowBottom = true;
						dropdownMenuTopCreateElement.style.display = "none";
						dropdownMenuTopCreateRule.style.display = "none";
						dropdownMenuTopCreateRuleAttribute.style.display = "";
						dropdownMenuTopCreateText.style.display = "none";
						dropdownMenuTopCreateComment.style.display = "none";
						dropdownMenuBottomCreateElement.style.display = "none";
						dropdownMenuBottomCreateRule.style.display = "none";
						dropdownMenuBottomCreateRuleAttribute.style.display = "";
						dropdownMenuBottomCreateText.style.display = "none";
						dropdownMenuBottomCreateComment.style.display = "none";
						dropdownMenuRightEditRuleSelector.style.display = "none";
						dropdownMenuRightEditRuleAttribute.style.display = "";
						dropdownMenuRightEditText.style.display = "none";
						dropdownMenuRightFind.style.display = "none";
						dropdownMenuRightChangeType.style.display = "none";
						dropdownMenuRightEditAttributes.style.display = "none";
						break;
				}
				if (dropdownShowLeft) {
					if (dropdownElement.elementContainerVisible) {
						_SA(dropdownMenuLeftToggleVisibility, "title", translate("HideChildren"));
						dropdownMenuLeftToggleVisibility.firstChild.className = "fa fa-nomargin fa-minus";
					} else {
						_SA(dropdownMenuLeftToggleVisibility, "title", translate("ShowChildren"));
						dropdownMenuLeftToggleVisibility.firstChild.className = "fa fa-nomargin fa-plus";
					}
				}
				clearToolbarActions();
				dropdownShowTypeOnHide = false;
				dropdownCreateTextOnHide = false;
				dropdownCreateCommentOnHide = false;
				dropdownMoveOnHide = false;
				dropdownEditTextOnHide = false;
				dropdownEditAttributesOnHide = false;
				dropdownCreateEditRuleOnHide = false;
				dropdownCreateEditRuleAttributeOnHide = false;

				if (dropdownShowTop) {
					dropdownMenuTop.style.display = "block";
					dropdownMenuTop.style.left = (dropdownX - 1) + "px";
					dropdownMenuTop.style.top = (dropdownY - (height >> 1) - 25) + "px";
				}
				if (dropdownShowLeft) {
					dropdownMenuLeft.style.display = "block";
					dropdownMenuLeft.style.left = (rect.left - 24) + "px";
					dropdownMenuLeft.style.top = (dropdownY - 10) + "px";
				}
				if (dropdownShowRight) {
					dropdownMenuRight.style.display = "block";
					dropdownMenuRight.style.left = (dropdownX + 18) + "px";
					dropdownMenuRight.style.top = (dropdownY - 10) + "px";
				}
				if (dropdownShowBottom) {
					dropdownMenuBottom.style.display = "block";
					dropdownMenuBottom.style.left = (dropdownX - 1) + "px";
					dropdownMenuBottom.style.top = (dropdownY + (height >> 1) + 5) + "px";
				}
				setTimeout(startFadeIn, 50);
			};

			window.dropdownShowType = function (top, changeType) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownActionChangeType = changeType;
				dropdownShowTypeOnHide = true;
				hide();
			};

			window.dropdownCreateText = function (top) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownCreateTextOnHide = true;
				hide();
			};

			window.dropdownEditText = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownEditTextOnHide = true;
				hide();
			};

			window.dropdownCreateComment = function (top) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownCreateCommentOnHide = true;
				hide();
			};

			window.dropdownCreateEditRuleSelector = function (top, editRuleSelector) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownActionEditRuleSelector = editRuleSelector;
				dropdownCreateEditRuleOnHide = true;
				hide();
			};

			window.dropdownCreateEditRuleAttribute = function (top, editRuleAttribute) {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownActionTop = top;
				dropdownActionEditRuleAttribute = editRuleAttribute;
				dropdownCreateEditRuleAttributeOnHide = true;
				hide();
			};

			window.dropdownMove = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownMoveOnHide = true;
				hide();
			};

			window.dropdownDuplicate = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				function duplicate(element, parent, siblingBelow) {
					var elementType = element.elementType,
						newElement = createElement(elementType.name, parent, siblingBelow, true);

					if (elementType === elementTypeText || elementType === elementTypeComment) {
						setElementText(newElement, getElementText(element));
					} else {
						var i, a, v;
						for (i = elementType.attributes.length - 1; i >= 0; i--) {
							a = elementType.attributes[i].name;
							if ((v = _GA(element.elementIframe, a)))
								_SA(newElement.elementIframe, a, v);
						}
						if (!elementType.noChildren) {
							if (!element.elementContainerVisible)
								toggleVisibility(newElement);
							if ((i = element.elementContainer.childNodes.length)) {
								i--;
								duplicate(element.elementContainer.childNodes[i--], newElement, null);
								while (i >= 0)
									duplicate(element.elementContainer.childNodes[i--], newElement, newElement.elementContainer.childNodes[0]);
							}
						}
					}
				}

				function duplicateRule(element, siblingBelow) {
					ignoreCssChanges = true;

					var newElement = createRule(getRuleSelector(element), siblingBelow, true), i, a, attributes = element.elementContainer.childNodes;
					for (i = 0; i < attributes.length; i++) {
						a = attributes[i];
						createRuleAttribute(getRuleAttributeName(a), getRuleAttributeValue(a), newElement, null, true);
					}

					ignoreCssChanges = false;

					updateCss();
				}

				function duplicateRuleAttribute(element, siblingBelow) {
					createRuleAttribute(getRuleAttributeName(element), getRuleAttributeValue(element), element.elementParent, siblingBelow, true);
				}

				switch (dropdownElement.elementCategory) {
					case categoryElement:
						duplicate(dropdownElement, dropdownElement.elementParent, dropdownElement);
						break;
					case categoryRule:
						duplicateRule(dropdownElement, dropdownElement);
						break;
					case categoryRuleAttribute:
						duplicateRuleAttribute(dropdownElement, dropdownElement);
						break;
				}

				hide();
			};

			window.dropdownFind = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownHighlighting)
					return;

				hide();
				dropdownHighlighting = true;

				var times = 0, interval = 0,
					e = dropdownElement.elementIframe,
					y = e.getBoundingClientRect().top;

				if (y < 0 || y > iframeWindow.innerHeight)
					iframeWindow.scroll({ top: y + iframeWindow.scrollY, behavior: "smooth" });

				loading = true;

				interval = setInterval(function () {
					if (!dropdownHighlighting) {
						if (interval) {
							loading = false;
							e.style.backgroundColor = "";
							e.style.color = "";
							clearInterval(interval);
							interval = 0;
						}
						return;
					}
					times++;
					if ((times & 1)) {
						e.style.backgroundColor = "#000";
						e.style.color = "#fff";
					} else {
						e.style.backgroundColor = "#fff";
						e.style.color = "#000";
					}
					if (times >= 10) {
						loading = false;
						e.style.backgroundColor = "";
						e.style.color = "";
						dropdownHighlighting = false;
						clearInterval(interval);
						interval = 0;
					}
				}, 200);
			};

			window.dropdownToggleVisibility = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				toggleVisibility(dropdownElement);
				hide();
			};

			window.dropdownEditAttributes = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				dropdownEditAttributesOnHide = true;
				hide();
			};

			window.dropdownDelete = function () {
				if (loading || dropdownFading || dropdownMoving || !dropdownVisible || dropdownTypeVisible)
					return;

				switch (dropdownElement.elementCategory) {
					case categoryElement:
						deleteElement(dropdownElement);
						break;
					case categoryRule:
						deleteRule(dropdownElement);
						break;
					case categoryRuleAttribute:
						deleteRuleAttribute(dropdownElement);
						break;
				}
				hide();
			};

			function dropdownCreateElement(name) {
				if (toolbarShowTypeOnClick) {
					toolbarElementName = name;
					move(true, true);
				} else if (dropdownActionChangeType) {
					changeType(name, dropdownElement);
				} else if (dropdownActionClosingTag) {
					if (dropdownActionTop)
						createElement(name, dropdownElement, null);
					else
						createElement(name, dropdownElement.elementParent, dropdownElement.nextSibling);
				} else {
					if (dropdownActionTop)
						createElement(name, dropdownElement.elementParent, dropdownElement);
					else if (dropdownElement.elementType.noChildren)
						createElement(name, dropdownElement.elementParent, dropdownElement.nextSibling);
					else
						createElement(name, dropdownElement, dropdownElement.elementContainer.firstChild);
				}
				hide();
			}

			dropdownTypeButton.onclick = function () {
				var name = trimValue(dropdownTypeInput).toLowerCase();
				if (name && name.charAt(0) === "<")
					name = trim(name.substr(1));
				if (name && name.charAt(name.length - 1) === ">")
					name = trim(name.substr(0, name.length - 1));
				if ((name in elementTypesByName) && name !== "text" && dropdownTypeVisible)
					dropdownCreateElement(name);
			};

			dropdownTypeInput.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					dropdownTypeButton.click();
			};

			_ID("modalAttributesOk").onclick = function () {
				if (loading)
					return;

				var i, a, v, e = dropdownElement.elementIframe,
					elementType = dropdownElement.elementType,
					attributes = elementType.attributes;

				for (i = 0; i < attributes.length; i++) {
					a = attributes[i];
					v = _ID("attributeInput" + a.name).value;
					if (!v)
						_RA(e, a.name);
					else
						_SA(e, a.name, v);
				}

				$("#modalAttributes").modal("hide");
			};

			function attributeInputKeyDown(e) {
				if (e.key === "Enter" || e.keyCode === 13)
					_ID("modalAttributesOk").click();
			};

			function showModalAttributes() {
				var i, j, a, c, row, v, div, input, opt,
					e = dropdownElement.elementIframe,
					elementType = dropdownElement.elementType,
					attributes = elementType.attributes,
					modalAttributesBody = _ID("modalAttributesBody");

				while (modalAttributesBody.firstChild)
					_RC(modalAttributesBody, modalAttributesBody.firstChild);

				for (i = 0, c = 3; i < attributes.length; i++) {
					a = attributes[i];

					if (i === htmlAttributes.length) {
						_CE("hr", null, modalAttributesBody);
						c = 0;
						row = _CE("div", "row", modalAttributesBody);
					} else if (c >= 3) {
						c = 0;
						row = _CE("div", "row", modalAttributesBody);
					}
					c++;

					div = _CE("div", "form-group", _CE("div", "col-sm-4", row));
					_TXT(a.name, _SA(_CE("label", null, div), "for", "attributeInput" + a.name));
					v = _GA(e, a.name);
					if (a.values && (typeof a.values === "object")) {
						input = _SA(_CE("select", "form-control", div), "size", "1");
						for (j = 0; j < a.values.length; j++) {
							opt = _SA(_CE("option", null, input), "value", a.values[j]);
							_TXT(a.values[j], opt);
							if (v == a.values[j])
								_SA(opt, "selected", "selected");
						}
					} else {
						input = ((a.values === valueImage) ?
							createImageInput(div, false) :
							_SA(_SA(_SA(_CE("input", "form-control", div), "spellcheck", "false"), "type", a.values === valueNumber ? "number" : "text"), "autocomplete", "off"));
						input.onkeydown = attributeInputKeyDown;
						input.value = v;
					}
					_SA(input, "id", "attributeInput" + a.name);
				}

				$("#modalAttributes").modal({
					keyboard: true,
					backdrop: true
				});
			}

			function clearToolbarActions() {
				toolbarElementName = null;
				toolbarShowTypeOnClick = false;
				toolbarCreateTextOnClick = false;
				toolbarCreateCommentOnClick = false;
				toolbarCreateRuleOnClick = false;
				toolbarCreateAttributeOnClick = false;
			}

			window.toolbarShowType = function () {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				var rect = editorToolbarCreateElement.getBoundingClientRect(),
					height = (rect.height | 0);

				dropdownX = (rect.left | 0) + 12;
				dropdownY = (rect.top | 0) + (height >> 1);
				dropdownElement = null;
				clearToolbarActions();
				toolbarShowTypeOnClick = true;
				fadeOutFinished();
			};

			window.toolbarCreateText = function () {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				dropdownElement = null;
				clearToolbarActions();
				toolbarCreateTextOnClick = true;
				lockUI(false);
				move(true, true);
			};

			window.toolbarCreateComment = function () {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				dropdownElement = null;
				clearToolbarActions();
				toolbarCreateCommentOnClick = true;
				lockUI(false);
				move(true, true);
			};

			window.toolbarCreateRule = function () {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				dropdownElement = null;
				clearToolbarActions();
				toolbarCreateRuleOnClick = true;
				lockUI(false);
				move(true, true);
			};

			window.toolbarCreateAttribute = function () {
				if (loading || dropdownFading || dropdownMoving || dropdownVisible || dropdownTypeVisible)
					return;

				dropdownElement = null;
				clearToolbarActions();
				toolbarCreateAttributeOnClick = true;
				lockUI(false);
				move(true, true);
			};

			// Initial
			(function () {
				var i, a, floatingHelp;

				function aClick(e) {
					if (e.target.tagName !== "A")
						return cancelEvent(e);
					if (e.button)
						return;
					dropdownCreateElement(this.elementType.name);
					return cancelEvent(e);
				}

				function helpClick(e) {
					window.open(this.parentNode.elementType.urlHelp);
					return cancelEvent(e);
				}

				for (i = 0; i < elementTypes.length; i++) {
					a = _CE("a", null, dropdownTypeContainer);
					_SA(a, "href", "#");
					a.onclick = aClick;
					a.elementType = elementTypes[i];
					_TXT(elementTypes[i].name + " ", a);
					floatingHelp = _CE("i", "fa fa-nomargin fa-question-circle fa-floating-help", a);
					_SA(floatingHelp, "title", translate("ElementHelp"));
					floatingHelp.onclick = helpClick;
				}
			})();
		})();

		// Actions Menu
		(function () {
			var editorActionFileLoad = _ID("editorActionFileLoad"),
				editorActionToggleBootstrapLabel = _ID("editorActionToggleBootstrapLabel"),
				editorActionToggleDecorationLabel = _ID("editorActionToggleDecorationLabel"),
				modalSaveFileName = _ID("modalSaveFileName"),
				modalSaveOk = _ID("modalSaveOk"),
				modalGoogleFontsLink = _ID("modalGoogleFontsLink"),
				modalGoogleFontsOk = _ID("modalGoogleFontsOk");

			$("#modalSave").on("shown.bs.modal", function () {
				modalSaveFileName.focus();
			});

			modalSaveFileName.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalSaveOk.click();
			};

			modalGoogleFontsLink.onkeydown = function (e) {
				if (e.key === "Enter" || e.keyCode === 13)
					modalGoogleFontsOk.click();
			};

			function enableBootstrap(enable) {
				editorBootstrapEnabled = enable;

				editorActionToggleBootstrapLabel.textContent = translate(enable ? "RemoveBootstrap" : "AddBootstrap");

				var e = iframeDocument.getElementById("bootstrapCSS");
				if (e)
					_RC(iframeHead, e);

				if (enable)
					_IB(iframeHead, _SA(_SA(_SA(_SA(_ICE("link"), "href", "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"), "type", "text/css"), "rel", "stylesheet"), "id", "bootstrapCSS"), iframeStyle);
			}

			function confirmClose() {
				return (!dirty || confirm(translate("ConfirmClose")));
			}

			function loadFileFromURL(url) {
				loading = true;
				Notification.wait();

				try {
					var xhr = new XMLHttpRequest(), done = false;
					xhr.responseType = "document";
					xhr.onreadystatechange = function () {
						if (xhr.readyState === 4) {
							if (done)
								return;
							done = true;

							loading = false;
							Notification.hide();

							try {
								loadDocument(xhr.responseXML);
							} catch (ex) {
								Notification.error(translate("ErrorFileLoad"), true);
							}
						}
					};
					xhr.onerror = function () {
						loading = false;
						Notification.error(translate("ErrorFileLoad"), true);
					};
					xhr.open("get", url);
					xhr.send();
				} catch (ex) {
					loading = false;
					Notification.error(translate("ErrorFileLoad"), true);
				}
			}

			function loadFileFromInput() {
				if (loading)
					return;

				if (!("files" in editorActionFileLoad)) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (!editorActionFileLoad.files.length || !editorActionFileLoad.files[0])
					return;

				loadFileDataURL(editorActionFileLoad.files[0], function (dataURL) {
					var parent = editorActionFileLoad.parentNode;
					editorActionFileLoad = _SA(_SA(_SA(_CE("input", null, _RC(parent, editorActionFileLoad)), "type", "file"), "tabindex", "-1"), "accept", "text/html");
					editorActionFileLoad.onchange = loadFileFromInput;

					if (!dataURL)
						return;

					if (dataURL.indexOf("data:text/html;base64,")) {
						Notification.error(translate("ErrorInvalidHTML"), true);
						return;
					}

					loadFileFromURL(dataURL);
				});
			}

			function newDocument() {
				if (!bodyElement)
					return;

				while (bodyElement.elementContainer.firstChild)
					deleteElement(bodyElement.elementContainer.firstChild);

				var i = editorCss.childNodes.length;
				while (i-- > 0 && editorCss.firstChild)
					deleteRule(editorCss.firstChild);

				updateGoogleFontsLink();
				enableBootstrap(false);

				updateCss();

				dirty = false;
			}

			function loadDocument(doc) {
				if (!doc || !doc.body || !doc.head)
					return;

				function isWhiteSpace(charCode) {
					return ((charCode === 0x20) || (charCode >= 0x09 && charCode <= 0x0D) || charCode === 0xA0 || charCode === 0x85);
				}

				function parseAttributeValue(css, start, end, valueIndices) {
					// Due to time restrictions this parser is way too simple...
					// It does not even recognize comments...
					// It should be improved in the future!

					var c;

					while (start < end) {
						if (!isWhiteSpace(css.charCodeAt(start)))
							break;

						start++;
					}

					if (start >= end)
						return false;

					valueIndices.start = start;

					while (start < end) {
						c = css.charCodeAt(start);
						if (c === 0x22) { // " = 0x22
							if ((start = css.indexOf("\"", start + 1)) < 0)
								return false;
						} else if (c === 0x27) { // ' = 0x27
							if ((start = css.indexOf("\'", start + 1)) < 0)
								return false;
						} else if (c === 0x28) { // ( = 0x28
							if ((start = css.indexOf(")", start + 1)) < 0)
								return false;
						} else if (c === 0x3B) { // ; = 0x3B
							break;
						}
						start++;
					}

					valueIndices.end = start;

					return true;
				}

				function parseRuleAttributes(rule, css, start) {
					// Due to time restrictions this parser is way too simple...
					// It does not even recognize comments...
					// It should be improved in the future!

					var end = css.indexOf("}", start),
						name, nameStart, value, valueIndices = { start: -1, end: -1 };

					if (end < 0)
						return end;

					// Skip the initial {
					for (start = start + 1; start < end; start++) {
						if (isWhiteSpace(css.charCodeAt(start)))
							continue;

						nameStart = start;
						while (start < end) {
							if (css.charCodeAt(start) === 0x3A) // : = 0x3A
								break;

							start++;
						}

						if (start >= end)
							break;

						name = trim(css.substring(nameStart, start));

						if (!parseAttributeValue(css, start + 1, end, valueIndices))
							break;
						value = trim(css.substring(valueIndices.start, valueIndices.end));
						createRuleAttribute(name, value, rule, null, true);

						start = valueIndices.end;
					}

					return end;
				}

				function parseCss(css) {
					// Due to time restrictions this parser is way too simple...
					// It does not even recognize comments...
					// It should be improved in the future!

					var start, end = css.length, selector, selectorStart, selectorEnd, rule;

					for (start = 0; start < end; start++) {
						if (isWhiteSpace(css.charCodeAt(start)))
							continue;

						selectorStart = start;

						selectorEnd = css.indexOf("{", start + 1);

						if (selectorEnd < 0)
							return;

						selector = trim(css.substring(selectorStart, selectorEnd));
						rule = createRule(selector, null, true);

						start = parseRuleAttributes(rule, css, selectorEnd + 1);

						if (start < 0)
							return;
					}
				}

				function loadDocumentCss(head) {
					try {
						var i, id, element;

						for (i = 0; i < head.childNodes.length; i++) {
							element = head.childNodes[i];
							if (element.tagName === "STYLE") {
								parseCss(element.textContent);
							} else if (element.tagName === "LINK") {
								id = _GA(element, "id");
								if (id === "googleFontsLink")
									updateGoogleFontsLink(_GA(element, "href"));
								else if (id === "bootstrapCSS")
									enableBootstrap(true);
							}
						}

					} catch (ex) {
						// Just ignore...
					}
				}

				ignoreCssChanges = true;
				newDocument();
				while (editorCss.firstChild)
					_RC(editorCss, editorCss.firstChild);
				loadDocumentCss(doc.head);
				if (!editorCss.childNodes.length)
					createRule("body");
				ignoreCssChanges = false;
				updateCss();

				//var amp = /\&/g, lt = /\</g, gt = /\>/g;

				function createElementsFromDoc(srcParent, dstParent) {
					var i, j, tag, srcElement, dstElement, emptyText, elementIframe, elementType, attributes, a, v;
					for (i = 0; i < srcParent.childNodes.length; i++) {
						srcElement = srcParent.childNodes[i];
						if (!srcElement.tagName) {
							if (srcElement.nodeType === 3) {
								emptyText = !srcElement.nodeValue;
								if (i === srcParent.childNodes.length - 1 && dstParent === bodyElement && !emptyText && !trim(srcElement.nodeValue))
									continue;
								dstElement = createElement("text", dstParent, null, true);
								if (!emptyText) {
									// Is this computationally faster/safer than replacing?!?!
									tmpDiv.textContent = srcElement.nodeValue;
									setElementText(dstElement, tmpDiv.innerHTML);
									//setElementText(dstElement, srcElement.nodeValue.replace(amp, "&amp;").replace(lt, "&lt;").replace(gt, "&gt;"));
								}
							} else if (srcElement.nodeType === 8) {
								v = srcElement.nodeValue;
								if (v.length >= 2 && v.charAt(0) === "\r" && v.charAt(1) == "\n")
									v = v.substr(2);
								else if (v.length && v.charAt(0) === "\n")
									v = v.substr(1);
								if (v.length >= 2 && v.charAt(v.length - 2) === "\r" && v.charAt(v.length - 1) == "\n")
									v = v.substr(0, v.length - 2);
								else if (v.length && v.charAt(v.length - 1) === "\n")
									v = v.substr(0, v.length - 1);
								setElementText(createElement("comment", dstParent, null, true), v);
							}
						} else if (((tag = srcElement.tagName.toLowerCase()) in elementTypesByName)) {
							dstElement = createElement(tag, dstParent, null, true);

							elementIframe = dstElement.elementIframe;
							elementType = dstElement.elementType;
							// Make sure to load only supported attributes
							attributes = elementType.attributes;
							for (j = 0; j < attributes.length; j++) {
								a = attributes[j].name;
								v = _GA(srcElement, a);
								if (v)
									_SA(elementIframe, a, v);
							}

							createElementsFromDoc(srcElement, dstElement);
						}
					}
				}

				createElementsFromDoc(doc.body, bodyElement);

				dirty = false;
			}

			editorActionFileLoad.onchange = loadFileFromInput;

			_ID("editorActionNew").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				if (!confirmClose())
					return cancelEvent(e);

				newDocument();

				return cancelEvent(e);
			};

			_ID("editorActionLoad").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				if (!confirmClose())
					return cancelEvent(e);

				editorActionFileLoad.click();

				return cancelEvent(e);
			};

			_ID("editorActionSave").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				$("#modalSave").modal({
					keyboard: true,
					backdrop: true
				});

				return cancelEvent(e);
			};

			_ID("editorActionLoadExample").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				if (!confirmClose())
					return cancelEvent(e);

				loadFileFromURL(translate("ExampleFile"));

				return cancelEvent(e);
			};

			_ID("editorActionGoogleFonts").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				if (iframeGoogleFontsLink) {
					var href = _GA(iframeGoogleFontsLink, "href");
					modalGoogleFontsLink.value = (href ? ("<link href=\"" + href + "\" rel=\"stylesheet\" />") : "");
				} else {
					modalGoogleFontsLink.value = "";
				}

				$("#modalGoogleFonts").modal({
					keyboard: true,
					backdrop: true
				});

				return cancelEvent(e);
			};

			_ID("editorActionToggleBootstrap").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				dirty = true;

				enableBootstrap(!editorBootstrapEnabled);

				return cancelEvent(e);
			};

			_ID("editorActionInstall").onclick = function (e) {
				$("#editorMenuDropdown").dropdown("toggle");

				_ID("editorActionInstallSeparator").style.display = "none";
				_ID("editorActionInstallItem").style.display = "none";

				if (installationPrompt) {
					installationPrompt.prompt();
					installationPrompt = null;
				}

				return cancelEvent(e);
			};

			_ID("editorActionToggleDecoration").onclick = function (e) {
				if (loading)
					return cancelEvent(e);

				$("#editorMenuDropdown").dropdown("toggle");

				editorDecorationVisible = !editorDecorationVisible;
				if (editorDecorationVisible) {
					editorActionToggleDecorationLabel.textContent = translate("HideDecoration");
					editorDecorationTop.style.display = "";
					editorDecorationBottom.style.display = "";
				} else {
					editorActionToggleDecorationLabel.textContent = translate("ShowDecoration");
					editorDecorationTop.style.display = "none";
					editorDecorationBottom.style.display = "none";
				}

				return cancelEvent(e);
			};

			modalSaveOk.onclick = function () {
				var fileName = trim(modalSaveFileName.value), googleFontsHref = "";
				if (!fileName)
					return;

				if (!BlobDownloader.supported) {
					Notification.error(translate("ErrorNoFile"), true);
					return;
				}

				if (fileName.toLowerCase().indexOf(".htm") < 0)
					fileName += ".html";

				$("#modalSave").modal("hide");

				if (iframeGoogleFontsLink) {
					if ((googleFontsHref = _GA(iframeGoogleFontsLink, "href")))
						googleFontsHref = '	<link href="' + googleFontsHref + '" id="googleFontsLink" rel="stylesheet" />\n'
				}

				BlobDownloader.download(fileName, new Blob([
					new Uint8Array([0xEF, 0xBB, 0xBF]), // UTF-8 BOM
					'<!DOCTYPE html>\n<html xmlns="http://www.w3.org/1999/xhtml" lang="pt-br">\n<head>\n	<meta charset="utf-8" />\n	<meta name="viewport" content="width=device-width, initial-scale=1" />\n	<title>',
					translate("PageTitle"),
					'</title>\n',
					googleFontsHref,
					(editorBootstrapEnabled ? '	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" rel="stylesheet" id="bootstrapCSS" />' : ''),
					'	<style type="text/css">\n',
					iframeStyle.textContent,
					"	</style>\n</head>\n<body>",
					trim(iframeBody.innerHTML),
					"</body>\n</html>\n"
				], { type: "text/html;charset=utf-8" }));

				dirty = false;
			};

			modalGoogleFontsOk.onclick = function () {
				$("#modalGoogleFonts").modal("hide");

				var i, e, link = trim(modalGoogleFontsLink.value);

				dirty = true;

				if (!link) {
					updateGoogleFontsLink();
					return;
				}

				if (((i = link.indexOf("href=\"")) >= 0 &&
						(e = link.indexOf("\"", i + 6)) >= 0) ||
					((i = link.indexOf("href='")) >= 0 &&
						(e = link.indexOf("'", i + 6)) >= 0)) {
					updateGoogleFontsLink(link.substring(i + 6, e));
					return;
				}

				updateGoogleFontsLink(link);
			};

		})();

		// Toolbar Animation
		(function () {
			var animTimeout = 0, animShow = null, animHide = null;

			function animateToolbar(show, hide) {
				if (animTimeout)
					clearTimeout(animTimeout);
				animShow = show;
				animHide = hide;
				animShow.className = "fade hidden";
				animHide.className = "fade in";
				animTimeout = setTimeout(function () {
					animHide.className = "fade";
					animTimeout = setTimeout(function () {
						animShow.className = "fade";
						animHide.className = "fade hidden";
						animTimeout = setTimeout(function () {
							animShow.className = "fade in";
							animTimeout = 0;
						}, 10);
					}, 150);
				}, 10);
			}

			$(tabEditor).on("show.bs.tab", function () {
				animateToolbar(toolbarButtons, toolbarButtonsCss);
			});

			$(tabEditorCss).on("show.bs.tab", function () {
				animateToolbar(toolbarButtonsCss, toolbarButtons);
			});
		})();
	</script>
</body>
</html>
